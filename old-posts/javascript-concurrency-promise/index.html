<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.aa4fa419345b6b978133.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-8d7d79679b70dbe27172b6460e7a7910.woff2) format("woff2"),url(/static/montserrat-latin-100-ec38980a9e0119a379e2a9b3dbb1901a.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-e279051046ba1286706adc886cf1c96b.woff2) format("woff2"),url(/static/montserrat-latin-100italic-3b325a3173c8207435cd1b76e19bf501.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-9d266fbbfa6cab7009bd56003b1eeb67.woff2) format("woff2"),url(/static/montserrat-latin-200-2d8ba08717110d27122e54c34b8a5798.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-6e5b3756583bb2263eb062eae992735e.woff2) format("woff2"),url(/static/montserrat-latin-200italic-a0d6f343e4b536c582926255367a57da.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-00b3e893aab5a8fd632d6342eb72551a.woff2) format("woff2"),url(/static/montserrat-latin-300-ea303695ceab35f17e7d062f30e0173b.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-56f34ea368f6aedf89583d444bbcb227.woff2) format("woff2"),url(/static/montserrat-latin-300italic-54b0bf2c8c4c12ffafd803be2466a790.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-b71748ae4f80ec8c014def4c5fa8688b.woff2) format("woff2"),url(/static/montserrat-latin-400-0659a9f4e90db5cf51b50d005bff1e41.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-6eed6b4cbb809c6efc7aa7ddad6dbe3e.woff2) format("woff2"),url(/static/montserrat-latin-400italic-7583622cfde30ae49086d18447ab28e7.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-091b209546e16313fd4f4fc36090c757.woff2) format("woff2"),url(/static/montserrat-latin-500-edd311588712a96bbf435fad264fff62.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-c90ced68b46050061d1a41842d6dfb43.woff2) format("woff2"),url(/static/montserrat-latin-500italic-5146cbfe02b1deea5dffea27a5f2f998.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-0480d2f8a71f38db8633b84d8722e0c2.woff2) format("woff2"),url(/static/montserrat-latin-600-b77863a375260a05dd13f86a1cee598f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-cf46ffb11f3a60d7df0567f8851a1d00.woff2) format("woff2"),url(/static/montserrat-latin-600italic-c4fcfeeb057724724097167e57bd7801.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-7dbcc8a5ea2289d83f657c25b4be6193.woff2) format("woff2"),url(/static/montserrat-latin-700-99271a835e1cae8c76ef8bba99a8cc4e.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-c41ad6bdb4bd504a843d546d0a47958d.woff2) format("woff2"),url(/static/montserrat-latin-700italic-6779372f04095051c62ed36bc1dcc142.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-db9a3e0ba7eaea32e5f55328ace6cf23.woff2) format("woff2"),url(/static/montserrat-latin-800-4e3c615967a2360f5db87d2f0fd2456f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-bf45bfa14805969eda318973947bc42b.woff2) format("woff2"),url(/static/montserrat-latin-800italic-fe82abb0bcede51bf724254878e0c374.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-e66c7edc609e24bacbb705175669d814.woff2) format("woff2"),url(/static/montserrat-latin-900-8211f418baeb8ec880b80ba3c682f957.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-4454c775e48152c1a72510ceed3603e2.woff2) format("woff2"),url(/static/montserrat-latin-900italic-efcaa0f6a82ee0640b83a0916e6e8d68.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-fc117160c69a8ea0851b26dd14748ee4.woff2) format("woff2"),url(/static/merriweather-latin-300-58b18067ebbd21fda77b67e73c241d3b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-fe29961474f8dbf77c0aa7b9a629e4bc.woff2) format("woff2"),url(/static/merriweather-latin-300italic-23c3f1f88683618a4fb8d265d33d383a.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-d9479e8023bef9cbd9bf8d6eabd6bf36.woff2) format("woff2"),url(/static/merriweather-latin-400-040426f99ff6e00b86506452e0d1f10b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-2de7bfeaf08fb03d4315d49947f062f7.woff2) format("woff2"),url(/static/merriweather-latin-400italic-79db67aca65f5285964ab332bd65f451.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-4b08e01d805fa35d7bf777f1b24314ae.woff2) format("woff2"),url(/static/merriweather-latin-700-22fb8afba4ab1f093b6ef9e28a9b6e92.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-cd92541b177652fffb6e3b952f1c33f1.woff2) format("woff2"),url(/static/merriweather-latin-700italic-f87f3d87cea0dd0979bfc8ac9ea90243.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-f813fc6a4bee46eda5224ac7ebf1b7be.woff2) format("woff2"),url(/static/merriweather-latin-900-5d4e42cb44410674acd99153d57df032.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-b7901d85486871c1779c0e93ddd85656.woff2) format("woff2"),url(/static/merriweather-latin-900italic-9647f9fdab98756989a8a5550eb205c3.woff) format("woff")}


/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden]{display:none}:root{--maxWidth-none:"none";--maxWidth-xs:20rem;--maxWidth-sm:24rem;--maxWidth-md:28rem;--maxWidth-lg:32rem;--maxWidth-xl:36rem;--maxWidth-2xl:42rem;--maxWidth-3xl:48rem;--maxWidth-4xl:56rem;--maxWidth-full:"100%";--maxWidth-wrapper:var(--maxWidth-4xl);--spacing-px:"1px";--spacing-0:0;--spacing-1:0.25rem;--spacing-2:0.5rem;--spacing-3:0.75rem;--spacing-4:1rem;--spacing-5:1.25rem;--spacing-6:1.5rem;--spacing-8:2rem;--spacing-10:2.5rem;--spacing-12:3rem;--spacing-16:4rem;--spacing-20:5rem;--spacing-24:6rem;--spacing-32:8rem;--fontFamily-sans:Montserrat,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--fontFamily-serif:"Merriweather","Georgia",Cambria,"Times New Roman",Times,serif;--font-body:var(--fontFamily-serif);--font-heading:var(--fontFamily-sans);--fontWeight-normal:400;--fontWeight-medium:500;--fontWeight-semibold:600;--fontWeight-bold:700;--fontWeight-extrabold:800;--fontWeight-black:900;--fontSize-root:16px;--lineHeight-none:1;--lineHeight-tight:1.1;--lineHeight-normal:1.5;--lineHeight-relaxed:1.625;--fontSize-0:0.833rem;--fontSize-1:1rem;--fontSize-2:1.2rem;--fontSize-3:1.44rem;--fontSize-4:1.728rem;--fontSize-5:2.074rem;--fontSize-6:2.488rem;--fontSize-7:2.986rem;--color-primary:#005b99;--color-text:#2e353f;--color-text-light:#4f5969;--color-heading:#1a202c;--color-heading-black:#000;--color-accent:#d1dce5}*,:after,:before{box-sizing:border-box}html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-size:var(--fontSize-root);line-height:var(--lineHeight-normal)}body{color:var(--color-text);font-family:var(--font-body);font-size:var(--fontSize-1)}footer{padding:var(--spacing-6) var(--spacing-0)}hr{background:var(--color-accent);border:0;height:1px}h1,h2,h3,h4,h5,h6{font-family:var(--font-heading);letter-spacing:-.025em;line-height:var(--lineHeight-tight);margin-bottom:var(--spacing-6);margin-top:var(--spacing-12)}h2,h3,h4,h5,h6{color:var(--color-heading);font-weight:var(--fontWeight-bold)}h1{color:var(--color-heading-black);font-size:var(--fontSize-6);font-weight:var(--fontWeight-black)}h2{font-size:var(--fontSize-5)}h3{font-size:var(--fontSize-4)}h4{font-size:var(--fontSize-3)}h5{font-size:var(--fontSize-2)}h6{font-size:var(--fontSize-1)}h1>a,h2>a,h3>a,h4>a,h5>a,h6>a{color:inherit;text-decoration:none}p{--baseline-multiplier:0.179;--x-height-multiplier:0.35;line-height:var(--lineHeight-relaxed);margin:var(--spacing-0) var(--spacing-0) var(--spacing-8) var(--spacing-0)}ol,p,ul{padding:var(--spacing-0)}ol,ul{list-style-image:none;list-style-position:outside;margin-bottom:var(--spacing-8);margin-left:var(--spacing-0);margin-right:var(--spacing-0)}ol li,ul li{padding-left:var(--spacing-0)}li>p,ol li,ul li{margin-bottom:calc(var(--spacing-8)/2)}li :last-child{margin-bottom:var(--spacing-0)}li>ul{margin-left:var(--spacing-8);margin-top:calc(var(--spacing-8)/2)}blockquote{border-left:var(--spacing-1) solid var(--color-primary);color:var(--color-text-light);font-size:var(--fontSize-2);font-style:italic;margin-bottom:var(--spacing-8);margin-left:calc(var(--spacing-6)*-1);margin-right:var(--spacing-8);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-6)}blockquote>:last-child{margin-bottom:var(--spacing-0)}blockquote>ol,blockquote>ul{list-style-position:inside}table{border-collapse:collapse;border-spacing:.25rem;margin-bottom:var(--spacing-8);width:100%}table thead tr th{border-bottom:1px solid var(--color-accent)}a{color:var(--color-primary)}a:focus,a:hover{text-decoration:none}.global-wrapper{margin:var(--spacing-0) auto;max-width:var(--maxWidth-wrapper);padding:var(--spacing-10) var(--spacing-5)}.global-wrapper[data-is-root-path=true] .bio{margin-bottom:var(--spacing-20)}.wrapper-col-2{display:flex}.wrapper-col-2 .blog-post{flex:1 1;max-width:800px}.wrapper-col-2 .aside-content{max-width:220px}.global-header{margin-bottom:var(--spacing-12)}.main-heading{font-size:var(--fontSize-7);margin:0}.post-list-item{margin-bottom:var(--spacing-8);margin-top:var(--spacing-8)}.post-list-item p{margin-bottom:var(--spacing-0)}.post-list-item h2{color:var(--color-primary);font-size:var(--fontSize-4);margin-bottom:var(--spacing-2);margin-top:var(--spacing-0)}.post-list-item header{margin-bottom:var(--spacing-4)}.header-link-home{font-family:var(--font-heading);font-size:var(--fontSize-2);font-weight:var(--fontWeight-bold);text-decoration:none}.bio{align-items:center;display:flex;margin-bottom:var(--spacing-16)}.bio-avatar,.bio p{margin-bottom:var(--spacing-0)}.bio-avatar{border-radius:100%;margin-right:var(--spacing-4);min-width:50px}.blog-post header h1{margin:var(--spacing-0) var(--spacing-0) var(--spacing-4) var(--spacing-0)}.blog-post header p{font-family:var(--font-heading);font-size:var(--fontSize-2)}.blog-post img{max-width:780px}.blog-post-nav ul{margin:var(--spacing-0)}.gatsby-highlight{margin-bottom:var(--spacing-8)}@media (max-width:42rem){blockquote{margin-left:var(--spacing-0);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-4)}ol,ul{list-style-position:inside}}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:0 1px #fff;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#b3d4fc;text-shadow:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:hsla(0,0%,100%,.5);color:#9a6e3a}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.css-toc{color:var(--color-heading);font-size:14px;margin-bottom:25px;margin-top:180px;padding:15px;position:-webkit-sticky;position:sticky;top:10px;width:220px}.css-toc ul{list-style-type:none;margin-bottom:0}.css-toc li>p{line-height:1.5;margin:0}.css-toc ul>li{margin-bottom:0}.css-toc li>ul{margin-top:6px;padding-left:0}</style><meta name="generator" content="Gatsby 4.4.0"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="Gatsby Starter Blog RSS Feed" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><title data-react-helmet="true">js异步初探 - promise | 何米酥`s Blog</title><meta data-react-helmet="true" name="description" content="js的异步编程是我们无法避免的话题之一：我们会在平时的编码过程中用到它，也会在面试中遇到它（大雾） 今天就对js的异步发展进行简单的探索，并且顺着流程了解并实现一个符合规范的promise来帮助更好地理解js中异步编程的处理逻辑： 本文第一章节将花费6～8min阅读时间；
第二章如果不着手实现将花费10～15min…"/><meta data-react-helmet="true" property="og:title" content="js异步初探 - promise"/><meta data-react-helmet="true" property="og:description" content="js的异步编程是我们无法避免的话题之一：我们会在平时的编码过程中用到它，也会在面试中遇到它（大雾） 今天就对js的异步发展进行简单的探索，并且顺着流程了解并实现一个符合规范的promise来帮助更好地理解js中异步编程的处理逻辑： 本文第一章节将花费6～8min阅读时间；
第二章如果不着手实现将花费10～15min…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content=""/><meta data-react-helmet="true" name="twitter:title" content="js异步初探 - promise"/><meta data-react-helmet="true" name="twitter:description" content="js的异步编程是我们无法避免的话题之一：我们会在平时的编码过程中用到它，也会在面试中遇到它（大雾） 今天就对js的异步发展进行简单的探索，并且顺着流程了解并实现一个符合规范的promise来帮助更好地理解js中异步编程的处理逻辑： 本文第一章节将花费6～8min阅读时间；
第二章如果不着手实现将花费10～15min…"/><link as="script" rel="preload" href="/webpack-runtime-428b742e2ddd83d8ad30.js"/><link as="script" rel="preload" href="/framework-e413e527015be9a1bdfd.js"/><link as="script" rel="preload" href="/app-4383c413ae36d40e78e6.js"/><link as="script" rel="preload" href="/commons-4801747b9acaf7a900b9.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-8c7ff09d6d39e7b3577e.js"/><link as="fetch" rel="preload" href="/page-data/old-posts/javascript-concurrency-promise/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2841359383.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3257411868.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="global-wrapper" data-is-root-path="false"><header><a class="header-link-home" href="/">何米酥`s Blog</a></header><main><div class="wrapper-col-2"><article class="blog-post" itemscope="" itemType="http://schema.org/Article"><header><h1 itemProp="headline">js异步初探 - promise</h1><p>November 04, 2019</p></header><section itemProp="articleBody"><p>js的异步编程是我们无法避免的话题之一：我们会在平时的编码过程中用到它，也会在面试中遇到它（大雾）</p>
<p>今天就对js的异步发展进行简单的探索，并且顺着流程了解并实现一个符合规范的promise来帮助更好地理解js中异步编程的处理逻辑：</p>
<p>本文第一章节将花费6～8min阅读时间；
第二章如果不着手实现将花费10～15min理解时间；参与实现将花费1h :D
第三章将花费4～6min阅读时间；</p>
<p>行文仓促，如有错误还请指正。</p>
<!-- more -->
<h1 id="1-前言" style="position:relative;"><a href="#1-%E5%89%8D%E8%A8%80" aria-label="1 前言 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. 前言</h1>
<h2 id="11-为何会有异步" style="position:relative;"><a href="#11-%E4%B8%BA%E4%BD%95%E4%BC%9A%E6%9C%89%E5%BC%82%E6%AD%A5" aria-label="11 为何会有异步 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.1 为何会有异步</h2>
<p>首先我们从为何会有异步入手，主要是有一下子两点原因：</p>
<ol>
<li>JS被涉及成单线程的语言，它自身只有一个单一的Call Stack，这就决定了它在某一时刻只能实现一件事情，因此它是同步的；</li>
<li>目前我们所使用的异步实现都需要平台的支撑（v8或者其他引擎）其次，浏览器是异步的，且为了用户体验不可避免；比如我们打开哔哩哔哩这个网站，就可以发现在同一时间，浏览器的多个模块同时工作，包括：网络请求、渲染界面、DOM事件、定时器等；</li>
</ol>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 144px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/668ba494d5a6aa497abe50455518d706/56357/668BA494D5A6AA497ABE50455518D706.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 94.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAATABQDASIAAhEBAxEB/8QAGAABAQADAAAAAAAAAAAAAAAAAAQBAgP/xAAVAQEBAAAAAAAAAAAAAAAAAAAAA//aAAwDAQACEAMQAAABs53y1nUoSowGwP/EABoQAAMBAAMAAAAAAAAAAAAAAAECAxASEyP/2gAIAQEAAQUCpSs3apmJdhW68kX0fAAM/8QAFhEAAwAAAAAAAAAAAAAAAAAAASAx/9oACAEDAQE/ATU//8QAFxEAAwEAAAAAAAAAAAAAAAAAAhESIP/aAAgBAgEBPwEVOP/EAB4QAAEEAgMBAAAAAAAAAAAAAAEAAhExECESIiNR/9oACAEBAAY/AoNGl0dyn6vQwVq02GwG3nWP/8QAGhABAQADAQEAAAAAAAAAAAAAAREAECFBUf/aAAgBAQABPyHjdtUy4RDvw51QXwMXmobneHYVYla6/9oADAMBAAIAAwAAABBsyAD/xAAWEQEBAQAAAAAAAAAAAAAAAAABESD/2gAIAQMBAT8QbOP/xAAXEQEAAwAAAAAAAAAAAAAAAAARASBh/9oACAECAQE/EIo7T//EAB0QAQABBAMBAAAAAAAAAAAAAAERACFBcRAxUWH/2gAIAQEAAT8QcWLHF3sqCOIAsrQKwFi2MT9qHWiGX2KJGWCOlMb5tFlRZXt4/9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/668ba494d5a6aa497abe50455518d706/56357/668BA494D5A6AA497ABE50455518D706.jpg"
        srcset="/static/668ba494d5a6aa497abe50455518d706/56357/668BA494D5A6AA497ABE50455518D706.jpg 144w"
        sizes="(max-width: 144px) 100vw, 144px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.1 V8引擎</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 572px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/9c12bb0e7427701125584da8535b8ca6/8d13f/9C12BB0E7427701125584DA8535B8CA6.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 106.32911392405065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAVABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAdilxK1AUD//xAAaEAACAwEBAAAAAAAAAAAAAAAAAQIQEhEx/9oACAEBAAEFAvTLOMjHKtV//8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAGhAAAgIDAAAAAAAAAAAAAAAAAAERICExQf/aAAgBAQAGPwLDRs4Qrf/EAB0QAAIBBAMAAAAAAAAAAAAAAAABERAxQVFhkbH/2gAIAQEAAT8hU+UcLqkx4rinaIexq7EhU//aAAwDAQACAAMAAAAQmAcA/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHRABAAICAgMAAAAAAAAAAAAAAQARITEQQVFxkf/aAAgBAQABPxAZHF7Fk15wkXak7qAwl1rbzLzd6ID0+SnJsqoGDzx//9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/9c12bb0e7427701125584da8535b8ca6/8d13f/9C12BB0E7427701125584DA8535B8CA6.jpg"
        srcset="/static/9c12bb0e7427701125584da8535b8ca6/ff44c/9C12BB0E7427701125584DA8535B8CA6.jpg 158w,
/static/9c12bb0e7427701125584da8535b8ca6/a6688/9C12BB0E7427701125584DA8535B8CA6.jpg 315w,
/static/9c12bb0e7427701125584da8535b8ca6/8d13f/9C12BB0E7427701125584DA8535B8CA6.jpg 572w"
        sizes="(max-width: 572px) 100vw, 572px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.2 浏览器打开b站所做的工作</p>
<h2 id="12-异步的实现原理" style="position:relative;"><a href="#12-%E5%BC%82%E6%AD%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86" aria-label="12 异步的实现原理 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.2 异步的实现原理</h2>
<p>这里我们可以看一段网络请求代码，如图1.3：接收两个参数，其中success是一个函数，这个函数传递进去不会立即执行，而是等待请求之后再运行这行函数。对于这种传递过去不执行，等待结果之后才执行的函数，我们称他为<strong>回调函数</strong>（callback）。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/aa7f49c6d13da4db21fd12805526e9f2/c2601/AA7F49C6D13DA4DB21FD12805526E9F2.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.9620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHuTaIqv//EABcQAAMBAAAAAAAAAAAAAAAAAAASIDH/2gAIAQEAAQUCwaf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAYEAEAAwEAAAAAAAAAAAAAAAABABEgQf/aAAgBAQABPyFi3SDeP//aAAwDAQACAAMAAAAQu8//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPxCH/8QAGRABAQEAAwAAAAAAAAAAAAAAAREAEEFR/9oACAEBAAE/EFVBaz3FGidQxig6FvP/2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/aa7f49c6d13da4db21fd12805526e9f2/828fb/AA7F49C6D13DA4DB21FD12805526E9F2.jpg"
        srcset="/static/aa7f49c6d13da4db21fd12805526e9f2/ff44c/AA7F49C6D13DA4DB21FD12805526E9F2.jpg 158w,
/static/aa7f49c6d13da4db21fd12805526e9f2/a6688/AA7F49C6D13DA4DB21FD12805526E9F2.jpg 315w,
/static/aa7f49c6d13da4db21fd12805526e9f2/828fb/AA7F49C6D13DA4DB21FD12805526E9F2.jpg 630w,
/static/aa7f49c6d13da4db21fd12805526e9f2/c2601/AA7F49C6D13DA4DB21FD12805526E9F2.jpg 832w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.3 网络请求代码</p>
<p>我们再来看一段nodejs中的代码，区别于前者的是，如图1.4所示的是一段文件I/O的处理。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e17178c5955c6292be26c8eaf3707e46/3f513/E17178C5955C6292BE26C8EAF3707E46.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 34.177215189873415%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3QUH/8QAFhAAAwAAAAAAAAAAAAAAAAAAABAh/9oACAEBAAEFAir/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAZEAACAwEAAAAAAAAAAAAAAAAAQQERIYH/2gAIAQEAAT8h1HBFs//aAAwDAQACAAMAAAAQAA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAbEAACAgMBAAAAAAAAAAAAAAABEQBhITFxkf/aAAgBAQABPxBASoVzn1MGjqf/2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/e17178c5955c6292be26c8eaf3707e46/828fb/E17178C5955C6292BE26C8EAF3707E46.jpg"
        srcset="/static/e17178c5955c6292be26c8eaf3707e46/ff44c/E17178C5955C6292BE26C8EAF3707E46.jpg 158w,
/static/e17178c5955c6292be26c8eaf3707e46/a6688/E17178C5955C6292BE26C8EAF3707E46.jpg 315w,
/static/e17178c5955c6292be26c8eaf3707e46/828fb/E17178C5955C6292BE26C8EAF3707E46.jpg 630w,
/static/e17178c5955c6292be26c8eaf3707e46/0ede0/E17178C5955C6292BE26C8EAF3707E46.jpg 945w,
/static/e17178c5955c6292be26c8eaf3707e46/3f513/E17178C5955C6292BE26C8EAF3707E46.jpg 1096w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.4 nodejs中文件I/O的处理</p>
<p>由此看来，实现异步的最核心原理在于：<strong>将callback作为参数传递给异步执行函数，当有结果之后再触发callback执行</strong></p>
<p>我们可以收集一波常用的异步操作，大致分为以下三种：网络请求、IO操作、定时任务；</p>
<h3 id="121-常见的异步操作" style="position:relative;"><a href="#121-%E5%B8%B8%E8%A7%81%E7%9A%84%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C" aria-label="121 常见的异步操作 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.2.1 常见的异步操作：</h3>
<ul>
<li>网络请求： ajax、http.get</li>
<li>IO操作：readFile、readdir</li>
<li>定时函数： setTimeout、setInterval</li>
</ul>
<p>那么，在这里提出第一个问题：</p>
<h3 id="122-事件绑定算不算异步操作" style="position:relative;"><a href="#122-%E4%BA%8B%E4%BB%B6%E7%BB%91%E5%AE%9A%E7%AE%97%E4%B8%8D%E7%AE%97%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C" aria-label="122 事件绑定算不算异步操作 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.2.2 事件绑定算不算异步操作？</h3>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/966dab00c8c1446882f06eb101f4ab95/15ec7/966DAB00C8C1446882F06EB101F4AB95.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 41.77215189873418%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3gUH/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFxABAAMAAAAAAAAAAAAAAAAAAAEhQf/aAAgBAQABPyHVof/aAAwDAQACAAMAAAAQAA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAYEAEAAwEAAAAAAAAAAAAAAAABABGBIf/aAAgBAQABPxBESXrMS1dn/9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/966dab00c8c1446882f06eb101f4ab95/828fb/966DAB00C8C1446882F06EB101F4AB95.jpg"
        srcset="/static/966dab00c8c1446882f06eb101f4ab95/ff44c/966DAB00C8C1446882F06EB101F4AB95.jpg 158w,
/static/966dab00c8c1446882f06eb101f4ab95/a6688/966DAB00C8C1446882F06EB101F4AB95.jpg 315w,
/static/966dab00c8c1446882f06eb101f4ab95/828fb/966DAB00C8C1446882F06EB101F4AB95.jpg 630w,
/static/966dab00c8c1446882f06eb101f4ab95/15ec7/966DAB00C8C1446882F06EB101F4AB95.jpg 690w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.5 事件绑定</p>
<p>在公布答案之前，我们对比一下以下两者之间的区别：
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/b7bc3b9378e53746c3d277e8370b16e8/fd879/B7BC3B9378E53746C3D277E8370B16E8.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 39.24050632911392%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3QUD/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFhABAQEAAAAAAAAAAAAAAAAAIQAQ/9oACAEBAAE/IWc//9oADAMBAAIAAwAAABDwD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABkQAQACAwAAAAAAAAAAAAAAAAEAESExUf/aAAgBAQABPxBotQ6zDU//2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/b7bc3b9378e53746c3d277e8370b16e8/828fb/B7BC3B9378E53746C3D277E8370B16E8.jpg"
        srcset="/static/b7bc3b9378e53746c3d277e8370b16e8/ff44c/B7BC3B9378E53746C3D277E8370B16E8.jpg 158w,
/static/b7bc3b9378e53746c3d277e8370b16e8/a6688/B7BC3B9378E53746C3D277E8370B16E8.jpg 315w,
/static/b7bc3b9378e53746c3d277e8370b16e8/828fb/B7BC3B9378E53746C3D277E8370B16E8.jpg 630w,
/static/b7bc3b9378e53746c3d277e8370b16e8/0ede0/B7BC3B9378E53746C3D277E8370B16E8.jpg 945w,
/static/b7bc3b9378e53746c3d277e8370b16e8/fd879/B7BC3B9378E53746C3D277E8370B16E8.jpg 1010w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.6 事件绑定对比</p>
<p>他们写法相同、执行方式也相同，都会将callback放入call-stack中通过eventloop调用；</p>
<p>那么他们的不同之处在于：调用源不同，前者是用户手动触发、后者是系统读取完文件后调用；此外前者有着比较明显的“订阅-发布”的设计模式痕迹，后者则没有；</p>
<details>
  <summary style="font-size: 16px; font-weight: 700">
    请思考后展开答案
  </summary>
  <span id="17:31:42">[答案1 事件绑定算不算异步操作](#17:31:42-1)</span>
  是也不是，关键要看触发源来自于哪。
</details>
<h2 id="13-异步的演进方案" style="position:relative;"><a href="#13-%E5%BC%82%E6%AD%A5%E7%9A%84%E6%BC%94%E8%BF%9B%E6%96%B9%E6%A1%88" aria-label="13 异步的演进方案 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.3 异步的演进方案</h2>
<p>关于异步方案的演进，我们可以从图1.7梳理出这样一条链路</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/8da0eb206c2f0c87bafeb9ff2a3fdba2/b4157/8DA0EB206C2F0C87BAFEB9FF2A3FDBA2.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 157.59493670886076%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAgABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe6CqMg0D//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEAAQUCT//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CT//EABwQAAEEAwEAAAAAAAAAAAAAAAABESFREDFBcf/aAAgBAQABPyHwm8Ork4kdaE0TwdaE0f/aAAwDAQACAAMAAAAQ08xA/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHBABAAICAwEAAAAAAAAAAAAAAQARIUEQUWGR/9oACAEBAAE/EEdqzK6oXuIICyDbXzhQtFk9kS2YpWlzLCXKf//Z'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/8da0eb206c2f0c87bafeb9ff2a3fdba2/828fb/8DA0EB206C2F0C87BAFEB9FF2A3FDBA2.jpg"
        srcset="/static/8da0eb206c2f0c87bafeb9ff2a3fdba2/ff44c/8DA0EB206C2F0C87BAFEB9FF2A3FDBA2.jpg 158w,
/static/8da0eb206c2f0c87bafeb9ff2a3fdba2/a6688/8DA0EB206C2F0C87BAFEB9FF2A3FDBA2.jpg 315w,
/static/8da0eb206c2f0c87bafeb9ff2a3fdba2/828fb/8DA0EB206C2F0C87BAFEB9FF2A3FDBA2.jpg 630w,
/static/8da0eb206c2f0c87bafeb9ff2a3fdba2/b4157/8DA0EB206C2F0C87BAFEB9FF2A3FDBA2.jpg 688w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.7 异步方案的演进</p>
<blockquote>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 490px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/a341ec4d95771b63dedf1d075fb22e0b/6b254/A341EC4D95771B63DEDF1D075FB22E0B.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 9.49367088607595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAACABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB2aFB/8QAFhAAAwAAAAAAAAAAAAAAAAAAAAEQ/9oACAEBAAEFAoj/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAXEAEBAQEAAAAAAAAAAAAAAAAAUTFx/9oACAEBAAE/Ib1WH//aAAwDAQACAAMAAAAQgA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAACAwEAAAAAAAAAAAAAAAABEQAhQTH/2gAIAQEAAT8QQwIQdRwwA1bP/9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/a341ec4d95771b63dedf1d075fb22e0b/6b254/A341EC4D95771B63DEDF1D075FB22E0B.jpg"
        srcset="/static/a341ec4d95771b63dedf1d075fb22e0b/ff44c/A341EC4D95771B63DEDF1D075FB22E0B.jpg 158w,
/static/a341ec4d95771b63dedf1d075fb22e0b/a6688/A341EC4D95771B63DEDF1D075FB22E0B.jpg 315w,
/static/a341ec4d95771b63dedf1d075fb22e0b/6b254/A341EC4D95771B63DEDF1D075FB22E0B.jpg 490w"
        sizes="(max-width: 490px) 100vw, 490px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
</blockquote>
<p>callback到promise阶段发生在jquery时代，在jQuery 1.5版本 以前还有deferred的出现，之后在此基础上出现了promise；</p>
<p>那么在这里再提出一个问题：</p>
<h3 id="131-deferred和promise有什么区别" style="position:relative;"><a href="#131-deferred%E5%92%8Cpromise%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB" aria-label="131 deferred和promise有什么区别 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.3.1 <code class="language-text">$.deferred</code>和<code class="language-text">$.promise</code>有什么区别？</h3>
<p>首先说明，这里的deferred和promise都是jQuery上的对象，不是我们所熟悉的promise。
在回答这个问题之前，先介绍一下deferrd：</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/eda6100e00940edc16e34d1111856c0c/50066/EDA6100E00940EDC16E34D1111856C0C.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 12.025316455696203%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAACABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3JCwf//EABYQAAMAAAAAAAAAAAAAAAAAAAEQMf/aAAgBAQABBQJCf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAABD/2gAIAQEABj8Cf//EABcQAAMBAAAAAAAAAAAAAAAAAAABMRD/2gAIAQEAAT8hdHXl/9oADAMBAAIAAwAAABADz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAQACAwEAAAAAAAAAAAAAAAEAIRExQXH/2gAIAQEAAT8QVvY3dwjWzm5//9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/eda6100e00940edc16e34d1111856c0c/828fb/EDA6100E00940EDC16E34D1111856C0C.jpg"
        srcset="/static/eda6100e00940edc16e34d1111856c0c/ff44c/EDA6100E00940EDC16E34D1111856C0C.jpg 158w,
/static/eda6100e00940edc16e34d1111856c0c/a6688/EDA6100E00940EDC16E34D1111856C0C.jpg 315w,
/static/eda6100e00940edc16e34d1111856c0c/828fb/EDA6100E00940EDC16E34D1111856C0C.jpg 630w,
/static/eda6100e00940edc16e34d1111856c0c/0ede0/EDA6100E00940EDC16E34D1111856C0C.jpg 945w,
/static/eda6100e00940edc16e34d1111856c0c/3ac88/EDA6100E00940EDC16E34D1111856C0C.jpg 1260w,
/static/eda6100e00940edc16e34d1111856c0c/50066/EDA6100E00940EDC16E34D1111856C0C.jpg 1384w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>deferred有以上5种方法，我们将它区分为两类，前者属于用户掌握控制权，控制deferred对象的状态，后者则将这个权利交给它自身。</p>
<details>
  <summary style="font-size: 16px; font-weight: 700">
    请思考后展开答案
  </summary>
  他们的区别是：promise对象相比于deferred对象，缺少了.resolve和.reject这两个函数属性（没错，与如今的promie有略微区别），你无法在上述划分的第二类方法以外去决议(resolve or reject)一个promise的状态（这个与如今类似）；而deferred可以在外边直接决议；
</details> 
<p>Promise在这里更多地被作为一个异步流程控制工具，而非一个订阅发布的事件模块，在此屏蔽了外部状态的改变。（当然，非主流之外的标准大家有兴趣可以自行搜寻或者看参考链接）</p>
<p>按照主流的说法，callback被认为是一个最差的方案，会出现类似于回调地狱这类问题等；而async/await则被认为是所谓异步的终极解决方案。
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/ce51a39e3aaf4592af69a73b34976d3f/f0afc/CE51A39E3AAF4592AF69A73B34976D3F.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 58.22784810126582%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAc2uIA//xAAYEAACAwAAAAAAAAAAAAAAAAAAAREgIf/aAAgBAQABBQJqDK//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAWEAEBAQAAAAAAAAAAAAAAAAARASD/2gAIAQEABj8CKa//xAAYEAACAwAAAAAAAAAAAAAAAAABEABRYf/aAAgBAQABPyG2sMKF/wD/2gAMAwEAAgADAAAAEPMP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhABAAMAAwAAAAAAAAAAAAAAARARIQAxgf/aAAgBAQABPxAttNnZXDTE8hK7P//Z'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/ce51a39e3aaf4592af69a73b34976d3f/828fb/CE51A39E3AAF4592AF69A73B34976D3F.jpg"
        srcset="/static/ce51a39e3aaf4592af69a73b34976d3f/ff44c/CE51A39E3AAF4592AF69A73B34976D3F.jpg 158w,
/static/ce51a39e3aaf4592af69a73b34976d3f/a6688/CE51A39E3AAF4592AF69A73B34976D3F.jpg 315w,
/static/ce51a39e3aaf4592af69a73b34976d3f/828fb/CE51A39E3AAF4592AF69A73B34976D3F.jpg 630w,
/static/ce51a39e3aaf4592af69a73b34976d3f/f0afc/CE51A39E3AAF4592AF69A73B34976D3F.jpg 658w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.8 回调地狱</p>
<h3 id="132-callback的引入" style="position:relative;"><a href="#132-callback%E7%9A%84%E5%BC%95%E5%85%A5" aria-label="132 callback的引入 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.3.2 callback的引入</h3>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/171c910237c1cc49f9965242cee5f6c4/b3058/171C910237C1CC49F9965242CEE5F6C4.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 8.860759493670885%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAACABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB2wSD/8QAFhABAQEAAAAAAAAAAAAAAAAAAAEy/9oACAEBAAEFAplX/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFhABAQEAAAAAAAAAAAAAAAAAADFB/9oACAEBAAE/ITin/9oADAMBAAIAAwAAABAAD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABkQAAIDAQAAAAAAAAAAAAAAAAABITFxgf/aAAgBAQABPxC3ROHBh//Z'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/171c910237c1cc49f9965242cee5f6c4/828fb/171C910237C1CC49F9965242CEE5F6C4.jpg"
        srcset="/static/171c910237c1cc49f9965242cee5f6c4/ff44c/171C910237C1CC49F9965242CEE5F6C4.jpg 158w,
/static/171c910237c1cc49f9965242cee5f6c4/a6688/171C910237C1CC49F9965242CEE5F6C4.jpg 315w,
/static/171c910237c1cc49f9965242cee5f6c4/828fb/171C910237C1CC49F9965242CEE5F6C4.jpg 630w,
/static/171c910237c1cc49f9965242cee5f6c4/0ede0/171C910237C1CC49F9965242CEE5F6C4.jpg 945w,
/static/171c910237c1cc49f9965242cee5f6c4/3ac88/171C910237C1CC49F9965242CEE5F6C4.jpg 1260w,
/static/171c910237c1cc49f9965242cee5f6c4/b3058/171C910237C1CC49F9965242CEE5F6C4.jpg 1296w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.9 callback</p>
<p>从流行的趋势来看，这种说法不无道理，我们确实从callback style一步步走到了今天大量使用 async/await 的阶段。那么，是否真是如此？</p>
<h3 id="133-promise也是callback" style="position:relative;"><a href="#133-promise%E4%B9%9F%E6%98%AFcallback" aria-label="133 promise也是callback permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.3.3 promise也是callback？</h3>
<p>稍后我们要介绍的主角Promise，在它的Promise/A+规范中有这么一句表述：
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/43b28/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 36.075949367088604%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBP/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdVYSB//xAAXEAEBAQEAAAAAAAAAAAAAAAACABQE/9oACAEBAAEFAlzFWM2IX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABkQAAIDAQAAAAAAAAAAAAAAAAACATEykf/aAAgBAQAGPwK54aY0x//EABoQAAICAwAAAAAAAAAAAAAAAAABESEx4fH/2gAIAQEAAT8haS6qwJ9AuEf/2gAMAwEAAgADAAAAEHAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFhEBAQEAAAAAAAAAAAAAAAAAARAh/9oACAECAQE/EAAyf//EAB0QAAICAQUAAAAAAAAAAAAAAAERADEhYXGRwfD/2gAIAQEAAT8QBcMRU8QnEr2TqLV+aT//2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/828fb/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg"
        srcset="/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/ff44c/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg 158w,
/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/a6688/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg 315w,
/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/828fb/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg 630w,
/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/0ede0/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg 945w,
/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/3ac88/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg 1260w,
/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/43b28/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg 1390w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<blockquote>
<p>Promise 表示一个异步操作的最终结果，与之进行交互的方式主要是<code class="language-text">then</code>方法，该方法注册了两个<strong>回调函数</strong>，用于接收 promise 的终值或本 promise 不能执行的原因。</p>
</blockquote>
<p>Callback是一个很宽泛的概念，我们可以把promise当作是一个能处理0-1个异步结果的状态管理器：因此，我们可以把callback -> promise的演进看作是一种style到另一种style的过程。
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/92be4e052b27172d4c27830d72cf4954/670dc/92BE4E052B27172D4C27830D72CF4954.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 6.329113924050632%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAABABQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAG2AD//xAAWEAADAAAAAAAAAAAAAAAAAAABEDH/2gAIAQEAAQUCEX//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAVEAEBAAAAAAAAAAAAAAAAAAAQsf/aAAgBAQABPyGj/9oADAMBAAIAAwAAABDzz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABcQAAMBAAAAAAAAAAAAAAAAAAABEDH/2gAIAQEAAT8Q1Cn/2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/92be4e052b27172d4c27830d72cf4954/828fb/92BE4E052B27172D4C27830D72CF4954.jpg"
        srcset="/static/92be4e052b27172d4c27830d72cf4954/ff44c/92BE4E052B27172D4C27830D72CF4954.jpg 158w,
/static/92be4e052b27172d4c27830d72cf4954/a6688/92BE4E052B27172D4C27830D72CF4954.jpg 315w,
/static/92be4e052b27172d4c27830d72cf4954/828fb/92BE4E052B27172D4C27830D72CF4954.jpg 630w,
/static/92be4e052b27172d4c27830d72cf4954/0ede0/92BE4E052B27172D4C27830D72CF4954.jpg 945w,
/static/92be4e052b27172d4c27830d72cf4954/3ac88/92BE4E052B27172D4C27830D72CF4954.jpg 1260w,
/static/92be4e052b27172d4c27830d72cf4954/670dc/92BE4E052B27172D4C27830D72CF4954.jpg 1650w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.10 promise</p>
<h3 id="134-generator也是callback" style="position:relative;"><a href="#134-generator%E4%B9%9F%E6%98%AFcallback" aria-label="134 generator也是callback permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.3.4 generator也是callback？</h3>
<p>随着进一步演进，在社区中出现了co库将generator与promise结合实现同步写法编写异步代码的解决方案：</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e4820d8bb88684defe25b089a237b26e/aefc3/E4820D8BB88684DEFE25B089A237B26E.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 50.632911392405056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdybAD//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAEFAl//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAXEAEAAwAAAAAAAAAAAAAAAAABABEg/9oACAEBAAE/IVphn//aAAwDAQACAAMAAAAQwA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAEBAQADAAAAAAAAAAAAAAABABEQITH/2gAIAQEAAT8QZckpHndhvBf/2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/e4820d8bb88684defe25b089a237b26e/828fb/E4820D8BB88684DEFE25B089A237B26E.jpg"
        srcset="/static/e4820d8bb88684defe25b089a237b26e/ff44c/E4820D8BB88684DEFE25B089A237B26E.jpg 158w,
/static/e4820d8bb88684defe25b089a237b26e/a6688/E4820D8BB88684DEFE25B089A237B26E.jpg 315w,
/static/e4820d8bb88684defe25b089a237b26e/828fb/E4820D8BB88684DEFE25B089A237B26E.jpg 630w,
/static/e4820d8bb88684defe25b089a237b26e/aefc3/E4820D8BB88684DEFE25B089A237B26E.jpg 926w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.11 co-generator</p>
<p>你们猜我是不是想说这也是一种callback style？</p>
<p>没错。。
我们可以把generator函数理解为：
它是一个把执行权一步一步交出去的函数：交出去后怎么回来？这就得调用callback函数。
当然事实没有这么简单，在这个过程中还需要做许多工作，需要恢复上下文执行栈环境等等。</p>
<p>为了印证这个说法，我们来看一个例子：如何将generator视为多个callback的函数的整合。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/d8f18ad68d4e0284446c78f2f6694af8/c222a/D8F18AD68D4E0284446C78F2F6694AF8.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 77.21518987341771%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAd0FkD//xAAXEAADAQAAAAAAAAAAAAAAAAAAARAh/9oACAEBAAEFAhXZ/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGhAAAgIDAAAAAAAAAAAAAAAAARAAIRExQf/aAAgBAQABPyE0WOeINXP/2gAMAwEAAgADAAAAEADP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhAAAwADAQAAAAAAAAAAAAAAAAERIUGBYf/aAAgBAQABPxBnh2M5mrohbYkOcL9D/9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/d8f18ad68d4e0284446c78f2f6694af8/828fb/D8F18AD68D4E0284446C78F2F6694AF8.jpg"
        srcset="/static/d8f18ad68d4e0284446c78f2f6694af8/ff44c/D8F18AD68D4E0284446C78F2F6694AF8.jpg 158w,
/static/d8f18ad68d4e0284446c78f2f6694af8/a6688/D8F18AD68D4E0284446C78F2F6694AF8.jpg 315w,
/static/d8f18ad68d4e0284446c78f2f6694af8/828fb/D8F18AD68D4E0284446C78F2F6694AF8.jpg 630w,
/static/d8f18ad68d4e0284446c78f2f6694af8/c222a/D8F18AD68D4E0284446C78F2F6694AF8.jpg 794w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.12 genetator的一个例子</p>
<p>如图1.12所示的代码，我们去掉*和yeild关键字，用朴素函数简化后变成图1.13这个样子。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e07f6e6b1f1da639d5fba7fde9fe3bbc/70aca/E07F6E6B1F1DA639D5FBA7FDE9FE3BBC.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 112.0253164556962%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAWABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe7QoM0KD//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEAAQUCH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CH//EABkQAAMAAwAAAAAAAAAAAAAAAAABERAgIf/aAAgBAQABPyF8FrKTH//aAAwDAQACAAMAAAAQAAgA/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAGhABAQEBAQEBAAAAAAAAAAAAAQARIUFRkf/aAAgBAQABPxDS0eb2AHInHR+wYcidvIJ4fkF//9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/e07f6e6b1f1da639d5fba7fde9fe3bbc/828fb/E07F6E6B1F1DA639D5FBA7FDE9FE3BBC.jpg"
        srcset="/static/e07f6e6b1f1da639d5fba7fde9fe3bbc/ff44c/E07F6E6B1F1DA639D5FBA7FDE9FE3BBC.jpg 158w,
/static/e07f6e6b1f1da639d5fba7fde9fe3bbc/a6688/E07F6E6B1F1DA639D5FBA7FDE9FE3BBC.jpg 315w,
/static/e07f6e6b1f1da639d5fba7fde9fe3bbc/828fb/E07F6E6B1F1DA639D5FBA7FDE9FE3BBC.jpg 630w,
/static/e07f6e6b1f1da639d5fba7fde9fe3bbc/0ede0/E07F6E6B1F1DA639D5FBA7FDE9FE3BBC.jpg 945w,
/static/e07f6e6b1f1da639d5fba7fde9fe3bbc/70aca/E07F6E6B1F1DA639D5FBA7FDE9FE3BBC.jpg 966w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.13 通过朴素函数转化一个generator</p>
<p>就这样，我们构造了一个嵌套了 4 层的 callback，然后在 next 函数的 4 次调用中，分别解开一层层的回调，最后清空了 callback 的层次。实现了与前面的 generator function 相似的行为。</p>
<p>当然，在babel中并不是通过上述方式来实现的，而是利用一个合成函数，通过switch case将它分割成多块，每次只执行其中一个case：
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/493bdf847706c3972b6f8501dbface82/8e1fc/493BDF847706C3972B6F8501DBFACE82.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 120.25316455696202%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAYABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe6UoM0KD//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEAAQUCH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CH//EABgQAAIDAAAAAAAAAAAAAAAAAAEQESAh/9oACAEBAAE/IZ1m3//aAAwDAQACAAMAAAAQQAgA/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHBABAQACAgMAAAAAAAAAAAAAAQAhMUFxUWGR/9oACAEBAAE/EMGQh6jVw7Y1EiuPMHf2L//Z'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/493bdf847706c3972b6f8501dbface82/828fb/493BDF847706C3972B6F8501DBFACE82.jpg"
        srcset="/static/493bdf847706c3972b6f8501dbface82/ff44c/493BDF847706C3972B6F8501DBFACE82.jpg 158w,
/static/493bdf847706c3972b6f8501dbface82/a6688/493BDF847706C3972B6F8501DBFACE82.jpg 315w,
/static/493bdf847706c3972b6f8501dbface82/828fb/493BDF847706C3972B6F8501DBFACE82.jpg 630w,
/static/493bdf847706c3972b6f8501dbface82/8e1fc/493BDF847706C3972B6F8501DBFACE82.jpg 900w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.14 babel转化generator的解决方案</p>
<h3 id="135-最后演进到asyncawait" style="position:relative;"><a href="#135-%E6%9C%80%E5%90%8E%E6%BC%94%E8%BF%9B%E5%88%B0asyncawait" aria-label="135 最后演进到asyncawait permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.3.5 最后演进到async/await</h3>
<p>至于generator到async/await的演进，我们可以视为它是promise + generator这个方案的语义化和标准化。</p>
<p>至此，我们可以将JavaScript里的异步方案演进表述为以下形式<sup><a href="https://mp.weixin.qq.com/s/qdJ0Xd8zTgtetFdlJL3P1g" title="100行实现一个Promise/A+">1</a></sup>：
Raw Callback Style -> Promise Callback Style -> Generator Callback Style -> Async/Await Callback</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/c825e85b437029689f170347582711ed/b204c/C825E85B437029689F170347582711ED.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 44.30379746835443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe8jS0D/xAAVEAEBAAAAAAAAAAAAAAAAAAAQAf/aAAgBAQABBQJj/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGRAAAgMBAAAAAAAAAAAAAAAAEEEAATGh/9oACAEBAAE/IVnCwqf/2gAMAwEAAgADAAAAEFPP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHRABAAEDBQAAAAAAAAAAAAAAAQARMXEQIUGBkf/aAAgBAQABPxAPSCo7FOtLMpwSxzP/2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/c825e85b437029689f170347582711ed/828fb/C825E85B437029689F170347582711ED.jpg"
        srcset="/static/c825e85b437029689f170347582711ed/ff44c/C825E85B437029689F170347582711ED.jpg 158w,
/static/c825e85b437029689f170347582711ed/a6688/C825E85B437029689F170347582711ED.jpg 315w,
/static/c825e85b437029689f170347582711ed/828fb/C825E85B437029689F170347582711ED.jpg 630w,
/static/c825e85b437029689f170347582711ed/0ede0/C825E85B437029689F170347582711ED.jpg 945w,
/static/c825e85b437029689f170347582711ed/3ac88/C825E85B437029689F170347582711ED.jpg 1260w,
/static/c825e85b437029689f170347582711ed/b204c/C825E85B437029689F170347582711ED.jpg 1724w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.15 JavaScript异步方案演进的表述</p>
<p>新的表述跟旧的表述，总体上是一致的。只是描述口径从 4 个不同事物的演进，变成了同种事物的不同形态的演进。</p>
<p>语义化和标准化，不意味着能力的增强，它也有可能导致能力的减弱。</p>
<ol>
<li>比如generator和async-await对比，generator 既能支持同步行为，也能支持异步行为；而async只支持异步行为。</li>
<li>再比如并行处理，我们需要在async函数中使用promise.all才能达到目的</li>
<li>最后callback虽然被人诟病，但是如果有如图1.16的需求，那又该如何实现？</li>
</ol>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/f876c08cdae85ece52e29b51522f6354/fbd2c/F876C08CDAE85ECE52E29B51522F6354.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 29.746835443037973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAME/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAd1RQP/EABYQAQEBAAAAAAAAAAAAAAAAAAEQIf/aAAgBAQABBQI1n//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAABD/2gAIAQEABj8Cf//EABkQAAEFAAAAAAAAAAAAAAAAAAABEBEhQf/aAAgBAQABPyFGhFN//9oADAMBAAIAAwAAABDzz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABkQAQADAQEAAAAAAAAAAAAAAAEAEZEh8f/aAAgBAQABPxDsK2AKF6yg9Z//2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/f876c08cdae85ece52e29b51522f6354/828fb/F876C08CDAE85ECE52E29B51522F6354.jpg"
        srcset="/static/f876c08cdae85ece52e29b51522f6354/ff44c/F876C08CDAE85ECE52E29B51522F6354.jpg 158w,
/static/f876c08cdae85ece52e29b51522f6354/a6688/F876C08CDAE85ECE52E29B51522F6354.jpg 315w,
/static/f876c08cdae85ece52e29b51522f6354/828fb/F876C08CDAE85ECE52E29B51522F6354.jpg 630w,
/static/f876c08cdae85ece52e29b51522f6354/0ede0/F876C08CDAE85ECE52E29B51522F6354.jpg 945w,
/static/f876c08cdae85ece52e29b51522f6354/fbd2c/F876C08CDAE85ECE52E29B51522F6354.jpg 1180w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.16 控制并发数的异步请求控制</p>
<p>所以说，如果我们愿意手动管理callback，理论上最原始的callback的表达能力是最强的；
这也很符合这个世界的规律：<strong>等价交换</strong>；</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/bea4bb425d88316b7b34d7d775bab835/f4946/BEA4BB425D88316B7B34D7D775BAB835.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 82.91139240506328%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAARABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe8AoxsKD//EABYQAQEBAAAAAAAAAAAAAAAAABABQv/aAAgBAQABBQIhDR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAUEAEAAAAAAAAAAAAAAAAAAAAw/9oACAEBAAY/Ah//xAAcEAADAAIDAQAAAAAAAAAAAAAAAREhMRBBgZH/2gAIAQEAAT8hitgsrYkXZcnr4IevP//aAAwDAQACAAMAAAAQcw8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHRAAAgEEAwAAAAAAAAAAAAAAAREAECExQWFxof/aAAgBAQABPxBSgdy4eQDyApsCvsuEAruoRLZLtJhPHX//2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/bea4bb425d88316b7b34d7d775bab835/828fb/BEA4BB425D88316B7B34D7D775BAB835.jpg"
        srcset="/static/bea4bb425d88316b7b34d7d775bab835/ff44c/BEA4BB425D88316B7B34D7D775BAB835.jpg 158w,
/static/bea4bb425d88316b7b34d7d775bab835/a6688/BEA4BB425D88316B7B34D7D775BAB835.jpg 315w,
/static/bea4bb425d88316b7b34d7d775bab835/828fb/BEA4BB425D88316B7B34D7D775BAB835.jpg 630w,
/static/bea4bb425d88316b7b34d7d775bab835/0ede0/BEA4BB425D88316B7B34D7D775BAB835.jpg 945w,
/static/bea4bb425d88316b7b34d7d775bab835/3ac88/BEA4BB425D88316B7B34D7D775BAB835.jpg 1260w,
/static/bea4bb425d88316b7b34d7d775bab835/f4946/BEA4BB425D88316B7B34D7D775BAB835.jpg 1274w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图1.17 有失有得的异步方案演进
从上往下，我们编写代码的方式越来越方便，更易维护；为此付出的代价就是能力削弱，编译器需要识别更多关键字；</p>
<p>初步介绍完js的异步发展过程，我们就开始介绍今日的主角promise：</p>
<h1 id="2-promise" style="position:relative;"><a href="#2-promise" aria-label="2 promise permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2 Promise</h1>
<h2 id="21-概览" style="position:relative;"><a href="#21-%E6%A6%82%E8%A7%88" aria-label="21 概览 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.1 概览</h2>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/3f024598c245c50fd8c920c0f8abc486/8284a/3F024598C245C50FD8C920C0F8ABC486.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 24.68354430379747%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAFABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAEDBP/EABUBAQEAAAAAAAAAAAAAAAAAAAAC/9oADAMBAAIQAxAAAAHfeSkH/8QAFxABAQEBAAAAAAAAAAAAAAAAAQMCEv/aAAgBAQABBQJ1TqqhJXP/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAXEQEBAQEAAAAAAAAAAAAAAAABACEx/9oACAECAQE/AXkGX//EABgQAQEAAwAAAAAAAAAAAAAAACEAAlFx/9oACAEBAAY/AjM5G5v/xAAYEAEAAwEAAAAAAAAAAAAAAAARAAExIf/aAAgBAQABPyHDaWTXUIncksn/2gAMAwEAAgADAAAAEAQf/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAEx/9oACAEDAQE/EJqv/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oACAECAQE/ECOIgF//xAAbEAEBAAIDAQAAAAAAAAAAAAABIQARQVFhkf/aAAgBAQABPxBrghJ57wQFUGxD7i6xdrSe5//Z'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/3f024598c245c50fd8c920c0f8abc486/828fb/3F024598C245C50FD8C920C0F8ABC486.jpg"
        srcset="/static/3f024598c245c50fd8c920c0f8abc486/ff44c/3F024598C245C50FD8C920C0F8ABC486.jpg 158w,
/static/3f024598c245c50fd8c920c0f8abc486/a6688/3F024598C245C50FD8C920C0F8ABC486.jpg 315w,
/static/3f024598c245c50fd8c920c0f8abc486/828fb/3F024598C245C50FD8C920C0F8ABC486.jpg 630w,
/static/3f024598c245c50fd8c920c0f8abc486/0ede0/3F024598C245C50FD8C920C0F8ABC486.jpg 945w,
/static/3f024598c245c50fd8c920c0f8abc486/3ac88/3F024598C245C50FD8C920C0F8ABC486.jpg 1260w,
/static/3f024598c245c50fd8c920c0f8abc486/8284a/3F024598C245C50FD8C920C0F8ABC486.jpg 1666w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图2.1 不同的Promise</p>
<p>通过之前的描述，我们明白promise的出现那一定是迟早的事，并且promise还有很多兄弟姐妹；
有兴趣的同学可以去看看《聊一聊promise的前世今生》这篇文章<sup><a href="https://www.cnblogs.com/tarol/p/9042407.html" title="聊一聊promise的前世今生">2</a></sup>。</p>
<p>如今我们使用的promise更多是在Promies/A+ 基础上增强的Promise ES6标准。</p>
<p>今天的另一个问题就是:</p>
<h3 id="211-图21中俩者的promise有啥区别" style="position:relative;"><a href="#211-%E5%9B%BE21%E4%B8%AD%E4%BF%A9%E8%80%85%E7%9A%84promise%E6%9C%89%E5%95%A5%E5%8C%BA%E5%88%AB" aria-label="211 图21中俩者的promise有啥区别 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.1.1 图2.1中俩者的promise有啥区别？</h3>
<details>
  <summary style="font-size: 16px; font-weight: 700">
    请思考后展开答案
  </summary>
  他们的区别是：ES6中的Promise增加了 `.catch` 方法，增加了 `Promsie.resolve`、`Promise.reject`、 `Promise.all`、`Promise.race`等静态方法
</details> 
<p>作为现代JavaScript中的一部分，理解和掌握Promise对前端开发者异常重要。它几乎成为面试中必问的问题之一，甚至还有一些付费教程教学如何实现一个Promise。</p>
<p>依我之见，互联网上资料丰富，但是也是鱼龙混杂：我们可以通过搜索引擎搜到与关键字相关的NNNN条信息，但是不一定能找到自己想要的信息。可能是我们搜索的关键字、可能是信息太多无法筛选、可能是因为坦克原因不可见、也可能是作者表述与读者理解力的不对等。</p>
<p>我将尽量以一种能看懂的方式实现Promise/A+规范。</p>
<p>不过，正如我所参考的这个实现作者所说的<sup><a href="https://mp.weixin.qq.com/s/qdJ0Xd8zTgtetFdlJL3P1g" title="100行实现一个Promise/A+">1</a></sup>：</p>
<blockquote>
<p>不过，如果一个初学者，想通过实现 Promises/A+ 去学习 Promises。或者认为实现了 Promises/A+规范后，对 Promises 的理解水平能得到质的提升。最后可能会失望。</p>
</blockquote>
<blockquote>
<p>实际上，Promises/A+ 规范，内容简短，实现难度低。其中充斥着细节行为的描述，缺乏设计目的和背景的部分，完全没有介绍使用场景。并不是一个入门 Promises 的好材料。</p>
</blockquote>
<blockquote>
<p>即便成功实现 Promises/A+ 规范，也不一定比没实现过的开发者，更善于使用 Promises 特性。</p>
</blockquote>
<p>如果想更好地使用Promise，我会推荐你去看promise迷你书<sup><a href="http://liubin.org/promises-book/" title="promise迷你书">3</a></sup></p>
<h2 id="22-实现一个-promisea-规范" style="position:relative;"><a href="#22-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA-promisea-%E8%A7%84%E8%8C%83" aria-label="22 实现一个 promisea 规范 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.2 实现一个 Promise/A+ 规范</h2>
<p>我们会使用Promise/A+作者提供的测试套件来测试我们实现的Promise是否符合规范。</p>
<p>现在跟着我一起左手🐲右手🌈</p>
<h3 id="221-前期工作" style="position:relative;"><a href="#221-%E5%89%8D%E6%9C%9F%E5%B7%A5%E4%BD%9C" aria-label="221 前期工作 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.2.1 前期工作</h3>
<p>英文规范： <a href="https://promisesaplus.com/">https://promisesaplus.com/</a>
中文规范： <a href="https://www.ituring.com.cn/article/66566">https://www.ituring.com.cn/article/66566</a>
测试套件： promises-aplus-tests</p>
<p>git repo: <a href="https://github.com/hemisu/promise-aplus-impl">https://github.com/hemisu/promise-aplus-impl</a></p>
<p>左侧打开promise规范网页，右侧编写代码撒。
创建一个目录，再命令行执行：</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/hemisu/promise-aplus-impl
<span class="token builtin class-name">cd</span> promise-aplus-impl <span class="token operator">&amp;&amp;</span> <span class="token function">npm</span> <span class="token function">install</span>
<span class="token function">npm</span> run <span class="token builtin class-name">test</span></code></pre></div>
<p>这样你就可以看到自带的promise的测试结果啦：D</p>
<h3 id="222-开始实现" style="position:relative;"><a href="#222-%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0" aria-label="222 开始实现 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.2.2 开始实现</h3>
<p>首先取消掉<code class="language-text">src/index.js</code>中第一行注释，引入我们自己编写的promise</p>
<p>在<code class="language-text">src/promies.js</code>中已经准备好了后面需要使用的一部分类型检测代码。
接着我们就开始对照着Promise/A+规范开始编码（推荐使用英文原版，有标注规范条目，不理解的地方再对照图灵中文翻译）。</p>
<h3 id="223-术语---1terminology" style="position:relative;"><a href="#223-%E6%9C%AF%E8%AF%AD---1terminology" aria-label="223 术语   1terminology permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.2.3 术语 - 1.terminology</h3>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/2f15c716ce0a3405cfbbfda2f1ef7e14/4b7fe/2F15C716CE0A3405CFBBFDA2F1EF7E14.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 46.202531645569614%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHYkkWAH//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABkQAAIDAQAAAAAAAAAAAAAAAAEQABEh4f/aAAgBAQABPyEjey0X/9oADAMBAAIAAwAAABAQz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EAB4QAQACAQQDAAAAAAAAAAAAAAEAEVEQITFBcdHh/9oACAEBAAE/EAunTl7l6+kFrcZyfMxp/9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/2f15c716ce0a3405cfbbfda2f1ef7e14/828fb/2F15C716CE0A3405CFBBFDA2F1EF7E14.jpg"
        srcset="/static/2f15c716ce0a3405cfbbfda2f1ef7e14/ff44c/2F15C716CE0A3405CFBBFDA2F1EF7E14.jpg 158w,
/static/2f15c716ce0a3405cfbbfda2f1ef7e14/a6688/2F15C716CE0A3405CFBBFDA2F1EF7E14.jpg 315w,
/static/2f15c716ce0a3405cfbbfda2f1ef7e14/828fb/2F15C716CE0A3405CFBBFDA2F1EF7E14.jpg 630w,
/static/2f15c716ce0a3405cfbbfda2f1ef7e14/0ede0/2F15C716CE0A3405CFBBFDA2F1EF7E14.jpg 945w,
/static/2f15c716ce0a3405cfbbfda2f1ef7e14/4b7fe/2F15C716CE0A3405CFBBFDA2F1EF7E14.jpg 1220w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图2.1 Terminology</p>
<p>规范的第一部分描述了几个术语，它们分别如下：</p>
<ul>
<li><code class="language-text">promise</code> 是一个包含 <code class="language-text">then</code> 方法的对象或者函数</li>
<li><code class="language-text">thenable</code> 是一个包含 <code class="language-text">then</code> 方法的对象或者函数</li>
<li><code class="language-text">value</code> 是一个合法JS值，可以是一个 <code class="language-text">undefined</code> <code class="language-text">thenable</code> <code class="language-text">promose</code></li>
</ul>
<p>这里解释一下，value是一个promise内部保持的值，它决议（resolve）成功时我们可以称它为result，而它失败(reject)时我们可以称它为reason。</p>
<p>对应这一节的规范，我们可以编写对应的代码（部分已内置）：
这里的 <code class="language-text">thenable</code> 涉及到鸭子类型(Duck Typing)。鸭子类型可解释为,如果一只动物,走起来像鸭子或者叫起来像鸭子,就可以把它当作鸭子。同理，一个对象或者函数如果有 <code class="language-text">then</code> 方法，我们就可以称它为 <code class="language-text">thenable</code></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// utils</span>
<span class="token comment">// ...</span>
<span class="token keyword">const</span> <span class="token function-variable function">isThenable</span> <span class="token operator">=</span> <span class="token parameter">obj</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">'then'</span> <span class="token keyword">in</span> obj
<span class="token comment">// ...</span>

<span class="token comment">// begin here</span>
<span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// </span>
<span class="token punctuation">}</span></code></pre></div>
<p>这一部分没有多少代码需要添加，我们只需要在构造函数中加入一行<code class="language-text">value</code>的内置值就行；另外在原型上挂载一个 <code class="language-text">then</code> 方法</p>
<h3 id="224-promise的状态---21-promise-states" style="position:relative;"><a href="#224-promise%E7%9A%84%E7%8A%B6%E6%80%81---21-promise-states" aria-label="224 promise的状态   21 promise states permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.2.4 promise的状态 - 2.1 Promise States</h3>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/abfb1dbd9bb5dbaf203d0a18339370c5/a8586/ABFB1DBD9BB5DBAF203D0A18339370C5.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 68.35443037974683%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAevpFFA//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGxAAAgIDAQAAAAAAAAAAAAAAAREAECExUZH/2gAIAQEAAT8hQeh5GaGYAuV//9oADAMBAAIAAwAAABAzD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABwQAQABBAMAAAAAAAAAAAAAAAEAESExURCBkf/aAAgBAQABPxAM3L6QTFPOBWo43Gqt0gup/9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/abfb1dbd9bb5dbaf203d0a18339370c5/828fb/ABFB1DBD9BB5DBAF203D0A18339370C5.jpg"
        srcset="/static/abfb1dbd9bb5dbaf203d0a18339370c5/ff44c/ABFB1DBD9BB5DBAF203D0A18339370C5.jpg 158w,
/static/abfb1dbd9bb5dbaf203d0a18339370c5/a6688/ABFB1DBD9BB5DBAF203D0A18339370C5.jpg 315w,
/static/abfb1dbd9bb5dbaf203d0a18339370c5/828fb/ABFB1DBD9BB5DBAF203D0A18339370C5.jpg 630w,
/static/abfb1dbd9bb5dbaf203d0a18339370c5/0ede0/ABFB1DBD9BB5DBAF203D0A18339370C5.jpg 945w,
/static/abfb1dbd9bb5dbaf203d0a18339370c5/a8586/ABFB1DBD9BB5DBAF203D0A18339370C5.jpg 1224w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图2.2 Promise States</p>
<p>这里的规范说明promise有<code class="language-text">PENDING</code>、<code class="language-text">FULFILLED</code>、<code class="language-text">REJECT</code>三种状态；
那么我们先加入这几个常量，在构造函数中声明这个值：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span>

<span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>然后从2.1.1 和 2.1.2.* 可以知道第一种可以转变为后面两种，后面两种不可再次 <code class="language-text">transition</code>，我们就再加入一条transition函数让这个函数进行状态变化，并且保存状态变化后的值 <code class="language-text">value</code>。就如之前提到的，如果<code class="language-text">state</code>为<code class="language-text">fulfilled</code>时，<code class="language-text">result</code>就被看作<code class="language-text">value</code>，如果<code class="language-text">state</code>被<code class="language-text">rejected</code>时，<code class="language-text">result</code>就被看作<code class="language-text">reason</code>。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">transition</span> <span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> state<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  promise<span class="token punctuation">.</span>state <span class="token operator">=</span> state
  promise<span class="token punctuation">.</span>result <span class="token operator">=</span> result
<span class="token punctuation">}</span></code></pre></div>
<p>此外规范中补充，这里的<code class="language-text">must not change</code>不意味着不可变对象，而仅仅是内存指向不变。（即这个value值如果是个对象，修改一下对象里的属性并不会破坏这条规则）</p>
<h3 id="225-then-方法---22-the-then-method" style="position:relative;"><a href="#225-then-%E6%96%B9%E6%B3%95---22-the-then-method" aria-label="225 then 方法   22 the then method permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.2.5 then 方法 - 2.2 The then Method</h3>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/fccede45412b545c613a24ad01f12664/4b7fe/FCCEDE45412B545C613A24AD01F12664.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 25.949367088607595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAFABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAduQsD//xAAWEAEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQEAAQUCSMf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAWEAEBAQAAAAAAAAAAAAAAAAARABD/2gAIAQEAAT8hJMf/2gAMAwEAAgADAAAAEHAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAAICAwAAAAAAAAAAAAAAAQARITGRscH/2gAIAQEAAT8QCY8gi2uIE11P/9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/fccede45412b545c613a24ad01f12664/828fb/FCCEDE45412B545C613A24AD01F12664.jpg"
        srcset="/static/fccede45412b545c613a24ad01f12664/ff44c/FCCEDE45412B545C613A24AD01F12664.jpg 158w,
/static/fccede45412b545c613a24ad01f12664/a6688/FCCEDE45412B545C613A24AD01F12664.jpg 315w,
/static/fccede45412b545c613a24ad01f12664/828fb/FCCEDE45412B545C613A24AD01F12664.jpg 630w,
/static/fccede45412b545c613a24ad01f12664/0ede0/FCCEDE45412B545C613A24AD01F12664.jpg 945w,
/static/fccede45412b545c613a24ad01f12664/4b7fe/FCCEDE45412B545C613A24AD01F12664.jpg 1220w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图2.3 then大致描述
then方法的描述就比较地长了，我们逐一来看：
首先规范说要有一个这样的方法，它接收俩参数。既然它这么大方地给了我们就直接复制到之前的代码中吧:D</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//</span>
<span class="token punctuation">}</span></code></pre></div>
<p>然后规范的2.2.1 ～ 2.2.3说明了一下这2个参数如果是函数会怎么样、不是函数又会怎么样，我们先略过不看，需要用到的时候我们再提。</p>
<p>2.2.4中提及，这俩参数如果被<code class="language-text">called</code>。哦那他们首先就是函数了。它们必须等到执行上下文只含平台代码的时候才能被执行。这里是什么意思呢？我们看到它有一个备注<code class="language-text">3.1</code>，我们看看图2.4。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/3c8d9ef3c70c59b930ad8423aa2d0eba/1982c/3C8D9EF3C70C59B930AD8423AA2D0EBA.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 36.075949367088604%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAEDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdeAtB//xAAWEAEBAQAAAAAAAAAAAAAAAAAAAUH/2gAIAQEAAQUC1H//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAYEAACAwAAAAAAAAAAAAAAAAAAEQEhMf/aAAgBAQABPyGUxRg//9oADAMBAAIAAwAAABDwD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABwQAQACAQUAAAAAAAAAAAAAAAEAIRExUWFxof/aAAgBAQABPxBjQp2nbyWKOTmf/9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/3c8d9ef3c70c59b930ad8423aa2d0eba/828fb/3C8D9EF3C70C59B930AD8423AA2D0EBA.jpg"
        srcset="/static/3c8d9ef3c70c59b930ad8423aa2d0eba/ff44c/3C8D9EF3C70C59B930AD8423AA2D0EBA.jpg 158w,
/static/3c8d9ef3c70c59b930ad8423aa2d0eba/a6688/3C8D9EF3C70C59B930AD8423AA2D0EBA.jpg 315w,
/static/3c8d9ef3c70c59b930ad8423aa2d0eba/828fb/3C8D9EF3C70C59B930AD8423AA2D0EBA.jpg 630w,
/static/3c8d9ef3c70c59b930ad8423aa2d0eba/0ede0/3C8D9EF3C70C59B930AD8423AA2D0EBA.jpg 945w,
/static/3c8d9ef3c70c59b930ad8423aa2d0eba/1982c/3C8D9EF3C70C59B930AD8423AA2D0EBA.jpg 1176w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图2.4 备注3.1</p>
<p>再补充一份翻译好的规范</p>
<blockquote>
<p>这里的平台代码指的是引擎、环境以及 promise 的实施代码。实践中要确保 onFulfilled 和 onRejected 方法异步执行，且应该在 then 方法被调用的那一轮事件循环之后的新执行栈中执行。这个事件队列可以采用“宏任务（macro-task）”机制或者“微任务（micro-task）”机制来实现。由于 promise 的实施代码本身就是平台代码（译者注：即都是 JavaScript），故代码自身在处理在处理程序时可能已经包含一个任务调度队列。</p>
</blockquote>
<p>大体意思呢就是这个then方法里的俩兄弟需要等下一个事件队列（macro task/micro task）才能执行。那我们先随便上一个：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 2.2.5 别问，先放着</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>规范2.2.6说then方法可能会被同一个promise多次调用，如果被调用的话需要按照注册的时候的顺序依次调用。</p>
<p>这下我们知道，他们应该放在一个队列中；其次，它们是不是像我们第一节说的回调一样？一个一个被注册到队列中等到需要的时候再拿出来？</p>
<p>于是我们先去构造函数中注册一个队列保存这些注册的<code class="language-text">then</code>回调。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 2.2.6</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p>最后来到2.2.7，先看规范：
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/8fb32ef8c0da6b0b82e68f63f1b0844b/ff688/8FB32EF8C0DA6B0B82E68F63F1B0844B.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 48.10126582278481%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHZHEsEH//EABcQAAMBAAAAAAAAAAAAAAAAAAABEBH/2gAIAQEAAQUCNjv/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAYEAEBAAMAAAAAAAAAAAAAAAABABARMf/aAAgBAQABPyFtocjl/9oADAMBAAIAAwAAABDDz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABsQAQEBAAIDAAAAAAAAAAAAAAERACExQXGR/9oACAEBAAE/EEi8E9YkSZEsPmJeseN1b//Z'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/8fb32ef8c0da6b0b82e68f63f1b0844b/828fb/8FB32EF8C0DA6B0B82E68F63F1B0844B.jpg"
        srcset="/static/8fb32ef8c0da6b0b82e68f63f1b0844b/ff44c/8FB32EF8C0DA6B0B82E68F63F1B0844B.jpg 158w,
/static/8fb32ef8c0da6b0b82e68f63f1b0844b/a6688/8FB32EF8C0DA6B0B82E68F63F1B0844B.jpg 315w,
/static/8fb32ef8c0da6b0b82e68f63f1b0844b/828fb/8FB32EF8C0DA6B0B82E68F63F1B0844B.jpg 630w,
/static/8fb32ef8c0da6b0b82e68f63f1b0844b/0ede0/8FB32EF8C0DA6B0B82E68F63F1B0844B.jpg 945w,
/static/8fb32ef8c0da6b0b82e68f63f1b0844b/ff688/8FB32EF8C0DA6B0B82E68F63F1B0844B.jpg 1226w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图2.5 then方法 条目2.2.7</p>
<p>这里说道：<code class="language-text">then</code>方法必须返回一个promise，称它为promies2，之前的promise就称它promise1。其实这里的promise1、promise2不是同一个promise对象了，在之后我们会提到关于这个的反模式写法。我们先加入这一条：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// promise2 2.2.7</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">//</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 2.2.5 别问，先放着</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>然后我们发现，2.2.7下面提及的东西都是在执行、返回结果甚至已经要回家过年了#滑稽#（在决议promise1的结果了），我一看这哪行，<code class="language-text">PENDING</code> 状态要做什么都还没干呢。</p>
<p>这时我们前面提及的，我们要把<code class="language-text">then</code>以回调的形式注册到队列中（2.2.6）就需要在这里重拳出击，保存目前所给的所有东西（方便恢复案发现场），排队进入队列。同时，这么多逻辑我们也不能都在一个地方写，为了好看一些，我们抽一个方法<code class="language-text">handleCallback</code>来进行剩余的操作。</p>
<p>为了减少篇幅（文字工作者不利的地方），这里我就把后面要用到的状态(state)和结果(value)都放函数里了。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// promise2 2.2.7</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token punctuation">{</span> onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2.2.6</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2.2.4</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> 
        <span class="token function">handleCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> state<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 接下来要大干一场的地方</span>
<span class="token punctuation">}</span></code></pre></div>
<p>然后我们来处理这个<code class="language-text">handleCallback</code>方法：
首先，进了这个方法的promies状态不是笑（fulfilled）就是哭（rejected），我们要对这个进行一个判断。
另外，扔进来的callback包我们也拆一下方便下一步工作。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> state<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject <span class="token punctuation">}</span> <span class="token operator">=</span> callback
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// REJECTED</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>接着我们就要用到前面提及但是未用的2.2.1～2.2.3条款并结合2.2.7
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/223edf02df00fb49ec748e72bf34dda6/deb44/223EDF02DF00FB49EC748E72BF34DDA6.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.9620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAexZTYP/xAAWEAEBAQAAAAAAAAAAAAAAAAABEAD/2gAIAQEAAQUCrif/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAZEAADAAMAAAAAAAAAAAAAAAAAARARITH/2gAIAQEAAT8hZhTo2n//2gAMAwEAAgADAAAAEPDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhAAAwADAQAAAAAAAAAAAAAAAAERITGRcf/aAAgBAQABPxB43JwTpjovUbh3s7CH/9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/223edf02df00fb49ec748e72bf34dda6/828fb/223EDF02DF00FB49EC748E72BF34DDA6.jpg"
        srcset="/static/223edf02df00fb49ec748e72bf34dda6/ff44c/223EDF02DF00FB49EC748E72BF34DDA6.jpg 158w,
/static/223edf02df00fb49ec748e72bf34dda6/a6688/223EDF02DF00FB49EC748E72BF34DDA6.jpg 315w,
/static/223edf02df00fb49ec748e72bf34dda6/828fb/223EDF02DF00FB49EC748E72BF34DDA6.jpg 630w,
/static/223edf02df00fb49ec748e72bf34dda6/0ede0/223EDF02DF00FB49EC748E72BF34DDA6.jpg 945w,
/static/223edf02df00fb49ec748e72bf34dda6/deb44/223EDF02DF00FB49EC748E72BF34DDA6.jpg 1212w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图2.6 then方法 2.2.1～2.2.3条款</p>
<p>2.2.7.1 如果我们执行 <code class="language-text">onFulfilled</code> 和 <code class="language-text">onRejected</code> 返回的值（这里称为x），它就使用promise的决议过程处理<code class="language-text">[[Resolve]](promise2, x)</code>这个值。那么首先这俩兄弟它得是个function才能返回结果x。我们这里就进行一个判断，然后决议它。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> state<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject <span class="token punctuation">}</span> <span class="token operator">=</span> callback
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 进行判断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
      <span class="token comment">// 决议它</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 进行判断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
      <span class="token comment">// 决议它</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>然后看到2.2.7.2 如果执行报错，我们要保护它，扔出一个错误作为promise2决议失败的理由。并且，2.2.7.3-4提出，如果俩兄弟不是函数的时候，跟着promise1的情况决议值</p>
<p>经过文字工作者的简单处理，代码就变成了这亚子：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> state<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject <span class="token punctuation">}</span> <span class="token operator">=</span> callback
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">isFunction</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 2.2.7.3</span>
      <span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">isFunction</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">onRejected</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 2.2.7.4</span>
      <span class="token operator">:</span> <span class="token function">reject</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2.2.7.2</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>至此我们的代码应该是这样的:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">isFunction</span> <span class="token operator">=</span> <span class="token parameter">obj</span> <span class="token operator">=></span> <span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">'function'</span>
<span class="token keyword">const</span> toString <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString
<span class="token keyword">const</span> <span class="token function-variable function">isObject</span> <span class="token operator">=</span> <span class="token parameter">obj</span> <span class="token operator">=></span> <span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Object]'</span>
<span class="token keyword">const</span> <span class="token function-variable function">isThenable</span> <span class="token operator">=</span> <span class="token parameter">obj</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">'then'</span> <span class="token keyword">in</span> obj
<span class="token keyword">const</span> <span class="token function-variable function">isPromise</span> <span class="token operator">=</span> <span class="token parameter">promise</span> <span class="token operator">=></span> promise <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span>

<span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span>

<span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">transition</span> <span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> state<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  promise<span class="token punctuation">.</span>state <span class="token operator">=</span> state
  promise<span class="token punctuation">.</span>result <span class="token operator">=</span> result
<span class="token punctuation">}</span>

<span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// promise2</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token punctuation">{</span> onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> 
        <span class="token function">handleCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> 

<span class="token keyword">function</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> state<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject <span class="token punctuation">}</span> <span class="token operator">=</span> callback
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">isFunction</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">isFunction</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">onRejected</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">reject</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>至此我们已经完成了66.66%的工作，因为总共就3条目：D</p>
<h3 id="226-then-方法---23-the-promise-resolution-procedure" style="position:relative;"><a href="#226-then-%E6%96%B9%E6%B3%95---23-the-promise-resolution-procedure" aria-label="226 then 方法   23 the promise resolution procedure permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.2.6 then 方法 - 2.3 The Promise Resolution Procedure</h3>
<p>对于大段的英文，我还是先放中文翻译吧：D</p>
<blockquote>
<p>Promise 解决过程是一个抽象的操作，其需输入一个 promise 和一个值，我们表示为 [[Resolve]](promise, x)，如果 x 有 then 方法且看上去像一个 Promise ，解决程序即尝试使 promise 接受 x 的状态；否则其用 x 的值来执行 promise 。</p>
</blockquote>
<blockquote>
<p>这种 thenable 的特性使得 Promise 的实现更具有通用性：只要其暴露出一个遵循 Promise/A+ 协议的 then 方法即可；这同时也使遵循 Promise/A+ 规范的实现可以与那些不太规范但可用的实现能良好共存。</p>
</blockquote>
<p>直接看中文的好处是我们更熟悉它（大雾
需要抠细节的时候再读原文不失为一种折衷的做法。
对于这第三部分规范，它大题的意思就是我们promise可以resolve不同类型的值，对于不同的值我们要做不同的处理。</p>
<p>首先它说明了这个方法带着promise和一个参数x。并且2.3.1做了一个基本的判断。话不多说我们开干：
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/c7c592fbb53e9c43f6fe6032772807d9/00d7d/C7C592FBB53E9C43F6FE6032772807D9.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 15.822784810126581%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAADABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdmwSD//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAEFAn//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAXEAADAQAAAAAAAAAAAAAAAAAAARAR/9oACAEBAAE/IWZP/9oADAMBAAIAAwAAABAAD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABgQAAMBAQAAAAAAAAAAAAAAAAABMREh/9oACAEBAAE/EHycEmwUP//Z'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/c7c592fbb53e9c43f6fe6032772807d9/828fb/C7C592FBB53E9C43F6FE6032772807D9.jpg"
        srcset="/static/c7c592fbb53e9c43f6fe6032772807d9/ff44c/C7C592FBB53E9C43F6FE6032772807D9.jpg 158w,
/static/c7c592fbb53e9c43f6fe6032772807d9/a6688/C7C592FBB53E9C43F6FE6032772807D9.jpg 315w,
/static/c7c592fbb53e9c43f6fe6032772807d9/828fb/C7C592FBB53E9C43F6FE6032772807D9.jpg 630w,
/static/c7c592fbb53e9c43f6fe6032772807d9/0ede0/C7C592FBB53E9C43F6FE6032772807D9.jpg 945w,
/static/c7c592fbb53e9c43f6fe6032772807d9/00d7d/C7C592FBB53E9C43F6FE6032772807D9.jpg 1218w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图2.7 决议过程1</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>promise <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'2.3.1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>2.3.2：如果x是个promise，那就沿用x的状态，让promise跟着x的状态走。
这里就类似继承一般，我们只需要在x上注册一个then，把promise的决议方法放进去即可完成要求。
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/03da27a461c8807c32a589d19c1193e9/62f39/03DA27A461C8807C32A589D19C1193E9.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 22.78481012658228%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAFABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB2KFB/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAEhEf/aAAgBAQABPyE2CqP/2gAMAwEAAgADAAAAEIPP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAAMAAwEAAAAAAAAAAAAAAQARITFBcYH/2gAIAQEAAT8QXVozqYsFfWc5u/Wf/9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/03da27a461c8807c32a589d19c1193e9/828fb/03DA27A461C8807C32A589D19C1193E9.jpg"
        srcset="/static/03da27a461c8807c32a589d19c1193e9/ff44c/03DA27A461C8807C32A589D19C1193E9.jpg 158w,
/static/03da27a461c8807c32a589d19c1193e9/a6688/03DA27A461C8807C32A589D19C1193E9.jpg 315w,
/static/03da27a461c8807c32a589d19c1193e9/828fb/03DA27A461C8807C32A589D19C1193E9.jpg 630w,
/static/03da27a461c8807c32a589d19c1193e9/0ede0/03DA27A461C8807C32A589D19C1193E9.jpg 945w,
/static/03da27a461c8807c32a589d19c1193e9/62f39/03DA27A461C8807C32A589D19C1193E9.jpg 1202w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图2.8 决议过程2</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>promise <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'2.3.1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>来到2.3.3，发现这一条特别长。一条一条解读：
如果我们发现x是一个<code class="language-text">thenable</code>对象或者函数
1: 设一个变量 <code class="language-text">then</code> 指向 x.then
2: 如果取 <code class="language-text">x</code> 的 <code class="language-text">then</code> 属性失败了，捕捉错误 <code class="language-text">e</code> 并决议作为 <code class="language-text">reason</code> 决议 promise 失败
3: 如果 <code class="language-text">then</code> 是一个 <code class="language-text">function</code> 就使它的this指向为x，接收俩个参数分别称为 <code class="language-text">resolvePromise</code> 和 <code class="language-text">rejectPromise</code></p>
<p>考虑一下，什么方法可以控制一个函数被调用时的 <code class="language-text">this</code> 指向并且返回的还是函数。</p>
<p>2.3.3.3.1 和 2.3.3.3.2 这两条与 2.3.2.2 和 2.3.2.3 有些类似，我们只需要注册一个 <code class="language-text">then</code> 方法，将promise的控制权注册进去即可。</p>
<p>剩余的2.3.3.3 ～ 2.3.3.4 先保留，我们之后来讲。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/6ec23faafdf54cafd9aa7d9a20620637/09fd1/6EC23FAAFDF54CAFD9AA7D9A20620637.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 77.21518987341771%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAey2Swf/xAAVEAEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAQABBQJrf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABgQAAMBAQAAAAAAAAAAAAAAAAABERAh/9oACAEBAAE/IU6K6RD/2gAMAwEAAgADAAAAENMP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhAAAwEBAQEAAAAAAAAAAAAAAAERIYExcf/aAAgBAQABPxCGMoyCs0l8ETmv4JJ411n/2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/6ec23faafdf54cafd9aa7d9a20620637/828fb/6EC23FAAFDF54CAFD9AA7D9A20620637.jpg"
        srcset="/static/6ec23faafdf54cafd9aa7d9a20620637/ff44c/6EC23FAAFDF54CAFD9AA7D9A20620637.jpg 158w,
/static/6ec23faafdf54cafd9aa7d9a20620637/a6688/6EC23FAAFDF54CAFD9AA7D9A20620637.jpg 315w,
/static/6ec23faafdf54cafd9aa7d9a20620637/828fb/6EC23FAAFDF54CAFD9AA7D9A20620637.jpg 630w,
/static/6ec23faafdf54cafd9aa7d9a20620637/0ede0/6EC23FAAFDF54CAFD9AA7D9A20620637.jpg 945w,
/static/6ec23faafdf54cafd9aa7d9a20620637/09fd1/6EC23FAAFDF54CAFD9AA7D9A20620637.jpg 1208w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图2.9 决议过程3</p>
<p>分别判断 <code class="language-text">x</code> 是否为 <code class="language-text">promise</code> 自身、 新的promise、 <code class="language-text">thenable</code>对象之后，剩余的处理方法即2.3.4，以x的决议promise成功</p>
<p>代码如下：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>promise <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'2.3.1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isThenable</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> then <span class="token punctuation">}</span> <span class="token operator">=</span> x
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>then<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token function">then</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>到这里我们完成了规范主要的部分，剩下的工作就是要拼接+完成之前跳过的细节条目。</p>
<p>首先，为了应对测试套件，我们需要写俩个静态方法：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">Promise<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>我们发现这时候 <code class="language-text">transition</code> 方法和 <code class="language-text">resolvePromise</code> 方法还没被使用到。再思考一下平时我们使用promise的方式：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>于是我们需要在promise的构造函数中做以下工作：</p>
<ol>
<li>使用 <code class="language-text">transition</code> 对单个promise进行状态转移</li>
<li>使用 <code class="language-text">handleCallback</code> 对当前的promise转移到下一个promise状态</li>
<li>使用 <code class="language-text">resolvePromise</code> 来处理promise决议成功后的result值</li>
<li>当 <code class="language-text">resolve</code> 或者 <code class="language-text">reject</code> 被多次调用时，只取第一次调用的结果，忽略后面的调用。（2.3.3.3.3）</li>
<li>将 <code class="language-text">resolve</code> 和 <code class="language-text">reject</code> 作为参数，传入 <code class="language-text">f</code> 函数，后续在<code class="language-text">new Promise</code>时就把 <code class="language-text">f</code> 供出去让使用者可以使用 <code class="language-text">resovle</code> 和 <code class="language-text">reject</code> 方法。</li>
<li>构建 <code class="language-text">onFulfilled</code> 和 <code class="language-text">onRejected</code> 提供将当前promise状态转换的能力</li>
</ol>
<p>这里直接贴上promies构造函数的代码，并且在代码中注释以上完成的功能点：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// 6</span>
  <span class="token keyword">let</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token function">transition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">FULFILLED</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token comment">// 1</span>
  <span class="token keyword">let</span> <span class="token function-variable function">onRejected</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token operator">=></span> <span class="token function">transition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">REJECTED</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span> <span class="token comment">// 1</span>

  <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
  <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 4</span>
    flag <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 4</span>
    <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span> <span class="token comment">// 3</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 4</span>
    flag <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 4</span>
    <span class="token function">onRejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 5</span>
    <span class="token function">f</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>这里的 <code class="language-text">try...catch</code> 是因为2.2.7.2中，注册的callback如果在 <code class="language-text">transition</code> 到新的状态的过程中抛错，可以在最外层被捕获到，直接决议promies失败。</p>
<p>然后我们就来测试一下现在的代码</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> run <span class="token builtin class-name">test</span></code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/aab4878614d10c4dfe9a05b531e05484/614df/AAB4878614D10C4DFE9A05B531E05484.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.32911392405063%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe5Q0o//xAAWEAADAAAAAAAAAAAAAAAAAAABIDH/2gAIAQEAAQUCNX//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAZEAACAwEAAAAAAAAAAAAAAAAAARARMUH/2gAIAQEAAT8hBVXIeicf/9oADAMBAAIAAwAAABATD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABwQAAICAgMAAAAAAAAAAAAAAAABESEQMUFRYf/aAAgBAQABPxCHQXi9CiK0XdjKvH//2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/aab4878614d10c4dfe9a05b531e05484/828fb/AAB4878614D10C4DFE9A05B531E05484.jpg"
        srcset="/static/aab4878614d10c4dfe9a05b531e05484/ff44c/AAB4878614D10C4DFE9A05B531E05484.jpg 158w,
/static/aab4878614d10c4dfe9a05b531e05484/a6688/AAB4878614D10C4DFE9A05B531E05484.jpg 315w,
/static/aab4878614d10c4dfe9a05b531e05484/828fb/AAB4878614D10C4DFE9A05B531E05484.jpg 630w,
/static/aab4878614d10c4dfe9a05b531e05484/0ede0/AAB4878614D10C4DFE9A05B531E05484.jpg 945w,
/static/aab4878614d10c4dfe9a05b531e05484/614df/AAB4878614D10C4DFE9A05B531E05484.jpg 978w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图2.10 第一次测试结果</p>
<p>这里我看到第一个错误结果就停止继续跑下去了。我们看一下这里报错对应的说明：</p>
<blockquote>
<p>applied to a promise rejected and then chained off of</p>
</blockquote>
<p>这里我们大概能猜出<strong>链式</strong>这一问题，回忆之前的代码，我们似乎没有处理注册在 <code class="language-text">callbacks</code> 队列里的 <code class="language-text">then</code> 回调，是否是这个原因导致呢？</p>
<p>我们再实现一个 <code class="language-text">handleCallbacks</code> 来处理队列里所有的 <code class="language-text">then</code> 回调，这里注意我们还是需要遵守2.2.4使其与当前执行上下文不在一起。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">transition</span> <span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> state<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  promise<span class="token punctuation">.</span>state <span class="token operator">=</span> state
  promise<span class="token punctuation">.</span>result <span class="token operator">=</span> result

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">handleCallbacks</span><span class="token punctuation">(</span>promise<span class="token punctuation">.</span>callbacks<span class="token punctuation">,</span> state<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handleCallbacks</span><span class="token punctuation">(</span><span class="token parameter">callbacks<span class="token punctuation">,</span> state<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> result<span class="token punctuation">)</span> 
<span class="token punctuation">}</span></code></pre></div>
<p>完整代码见：<a href="https://github.com/hemisu/promise-aplus-impl">repo</a></p>
<p>我们最后跑一下测试。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 318px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/ce07c5a06be97ba8f62f00604ca42898/2debd/CE07C5A06BE97BA8F62F00604CA42898.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 20.88607594936709%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAd+ALBf/xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAEFAn//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAYEAADAQEAAAAAAAAAAAAAAAABEWEAEP/aAAgBAQABPyFU5U8//9oADAMBAAIAAwAAABB4D//EABYRAAMAAAAAAAAAAAAAAAAAAAEQMf/aAAgBAwEBPxAVf//EABYRAAMAAAAAAAAAAAAAAAAAAAEQMf/aAAgBAgEBPxAVf//EABkQAQACAwAAAAAAAAAAAAAAAAEAERAxQf/aAAgBAQABPxBs6IKzhj//2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/ce07c5a06be97ba8f62f00604ca42898/2debd/CE07C5A06BE97BA8F62F00604CA42898.jpg"
        srcset="/static/ce07c5a06be97ba8f62f00604ca42898/ff44c/CE07C5A06BE97BA8F62F00604CA42898.jpg 158w,
/static/ce07c5a06be97ba8f62f00604ca42898/a6688/CE07C5A06BE97BA8F62F00604CA42898.jpg 315w,
/static/ce07c5a06be97ba8f62f00604ca42898/2debd/CE07C5A06BE97BA8F62F00604CA42898.jpg 318w"
        sizes="(max-width: 318px) 100vw, 318px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图2.11 第二次测试结果</p>
<p>可以看到我们已经实现了一个Promies/A+规范（鼓掌）</p>
<p>这里插一个小tip，我们如果把macroTask替换成microTask会不会更快一些捏？这里使用 <code class="language-text">process.nextTick</code> 来替换 <code class="language-text">setTimeout</code></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 270px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/182425ce19c05e16a5ad2d5631ae2fea/6f81f/182425CE19C05E16A5AD2D5631AE2FEA.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 18.354430379746837%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAd4E0Nf/xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAEFAn//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAXEAADAQAAAAAAAAAAAAAAAAAAARFh/9oACAEBAAE/IZrJrEf/2gAMAwEAAgADAAAAEIfP/8QAFREBAQAAAAAAAAAAAAAAAAAAEEH/2gAIAQMBAT8Qp//EABURAQEAAAAAAAAAAAAAAAAAABBB/9oACAECAQE/EKf/xAAcEAACAgIDAAAAAAAAAAAAAAABEQAxIUFRYXH/2gAIAQEAAT8QN8TPM3F3cBBMn2f/2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/182425ce19c05e16a5ad2d5631ae2fea/6f81f/182425CE19C05E16A5AD2D5631AE2FEA.jpg"
        srcset="/static/182425ce19c05e16a5ad2d5631ae2fea/ff44c/182425CE19C05E16A5AD2D5631AE2FEA.jpg 158w,
/static/182425ce19c05e16a5ad2d5631ae2fea/6f81f/182425CE19C05E16A5AD2D5631AE2FEA.jpg 270w"
        sizes="(max-width: 270px) 100vw, 270px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图2.12 第三次测试结果</p>
<p>可以看到跑完测试的时间减少了3s，非常大的进步：D</p>
<h2 id="23-增强为es6的promise" style="position:relative;"><a href="#23-%E5%A2%9E%E5%BC%BA%E4%B8%BAes6%E7%9A%84promise" aria-label="23 增强为es6的promise permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.3 增强为ES6的promise</h2>
<p>ES6需要补充的方法如下，可以看下面的一个是规范地址，一个是mdn地址；除去还在草案中的allsettled等方法，前面我们已经实现了打勾的部分，我们还需要实现剩下的catch、all、race。</p>
<ol>
<li><a href="https://tc39.es/ecma262/#sec-promise-objects">https://tc39.es/ecma262/#sec-promise-objects</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/finally">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/finally</a></li>
</ol>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/a4413/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 27.848101265822784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQB/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQP/2gAMAwEAAhADEAAAAb7ybgof/8QAGBAAAgMAAAAAAAAAAAAAAAAAABEBAxL/2gAIAQEAAQUCxY5Gf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABcRAAMBAAAAAAAAAAAAAAAAAAECEDH/2gAIAQIBAT8BRQMn/8QAFxAAAwEAAAAAAAAAAAAAAAAAEBEikf/aAAgBAQAGPwJzp//EABkQAAIDAQAAAAAAAAAAAAAAAAABMUFxgf/aAAgBAQABPyFLsaIHR//aAAwDAQACAAMAAAAQgA//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPxBVn//EABURAQEAAAAAAAAAAAAAAAAAABEQ/9oACAECAQE/EGRP/8QAGhABAAMAAwAAAAAAAAAAAAAAAQARIUGBof/aAAgBAQABPxCox3bM96hw8wABfif/2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/828fb/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg"
        srcset="/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/ff44c/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg 158w,
/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/a6688/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg 315w,
/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/828fb/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg 630w,
/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/0ede0/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg 945w,
/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/3ac88/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg 1260w,
/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/a4413/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg 1312w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图2.13 需要完成的方法</p>
<h3 id="231-promiseprototypecatch" style="position:relative;"><a href="#231-promiseprototypecatch" aria-label="231 promiseprototypecatch permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.3.1 Promise.prototype.catch</h3>
<p>这个方法其实就是一个语法糖，实现起来十分方便</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> </code></pre></div>
<h3 id="232-promiseall" style="position:relative;"><a href="#232-promiseall" aria-label="232 promiseall permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.3.2 Promise#all</h3>
<p>实现 <code class="language-text">promise.all</code> 方法主要注意以下几点：</p>
<ol>
<li>它不同于还在草案的<code class="language-text">allSettled</code>，<code class="language-text">all</code> 方法在决议失败时只需要返回第一个失败的错误。</li>
<li>传入 <code class="language-text">all</code> 方法的promises是一个数组，全部决议成功后返回的也是一个结果数组，且顺序与promises一致。</li>
</ol>
<p>接下来的工作我们就只需要判断每个值是否为promise，然后注册在 <code class="language-text">then</code> 中进行处理。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">Promise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">promises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    count<span class="token operator">++</span>
    results<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> value
    <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">===</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="232-promiserace" style="position:relative;"><a href="#232-promiserace" aria-label="232 promiserace permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.3.2 Promise#race</h3>
<p>其实实现了 <code class="language-text">all</code> 方法后，<code class="language-text">race</code> 的方法的实现就水到渠成了。我们把上面的<code class="language-text">fn</code>拿走就可以完成了</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">Promise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">promises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">promise</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>最后跑一下测试，</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">results</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'results'</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token constant">TIME_LOG_NAME</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">results</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'results'</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token constant">TIME_LOG_NAME</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>最后一个 <code class="language-text">finally</code> 方法交给大家来解决吧～欢迎在下面提出</p>
<h1 id="3-总结" style="position:relative;"><a href="#3-%E6%80%BB%E7%BB%93" aria-label="3 总结 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3 总结</h1>
<h2 id="31实现promise之后的思考" style="position:relative;"><a href="#31%E5%AE%9E%E7%8E%B0promise%E4%B9%8B%E5%90%8E%E7%9A%84%E6%80%9D%E8%80%83" aria-label="31实现promise之后的思考 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.1实现promise之后的思考</h2>
<h3 id="311-它是一个callback-management" style="position:relative;"><a href="#311-%E5%AE%83%E6%98%AF%E4%B8%80%E4%B8%AAcallback-management" aria-label="311 它是一个callback management permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.1.1 它是一个callback management</h3>
<p>正如前面所说的，我们可以把promise看作是一个callback management：
也正如它内置状态所展示的一样，它可以处理0～1个异步结果。
如果有了解RxJS的同学，我们可以RxJS当作是一个可以处理0～Infinite个异步结果的库。
这无疑是一种能力的增强，同时也是对编码人员的挑战。如果实际的场景没有这么大的需求，我们不会轻易上这类工具。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/a4ca555a1d97807117682bb7b8b2233a/1b43a/A4CA555A1D97807117682BB7B8B2233A.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 22.151898734177216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB34EB/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAERIf/aAAgBAQABPyGCWlh//9oADAMBAAIAAwAAABAAD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAAICAwAAAAAAAAAAAAAAAAERACExQZH/2gAIAQEAAT8QRu+yyWbCzARFbLn/2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/a4ca555a1d97807117682bb7b8b2233a/828fb/A4CA555A1D97807117682BB7B8B2233A.jpg"
        srcset="/static/a4ca555a1d97807117682bb7b8b2233a/ff44c/A4CA555A1D97807117682BB7B8B2233A.jpg 158w,
/static/a4ca555a1d97807117682bb7b8b2233a/a6688/A4CA555A1D97807117682BB7B8B2233A.jpg 315w,
/static/a4ca555a1d97807117682bb7b8b2233a/828fb/A4CA555A1D97807117682BB7B8B2233A.jpg 630w,
/static/a4ca555a1d97807117682bb7b8b2233a/0ede0/A4CA555A1D97807117682BB7B8B2233A.jpg 945w,
/static/a4ca555a1d97807117682bb7b8b2233a/3ac88/A4CA555A1D97807117682BB7B8B2233A.jpg 1260w,
/static/a4ca555a1d97807117682bb7b8b2233a/1b43a/A4CA555A1D97807117682BB7B8B2233A.jpg 1892w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>图3.1 Callback Management</p>
<h3 id="312-能手写promies实现就一定精通promies" style="position:relative;"><a href="#312-%E8%83%BD%E6%89%8B%E5%86%99promies%E5%AE%9E%E7%8E%B0%E5%B0%B1%E4%B8%80%E5%AE%9A%E7%B2%BE%E9%80%9Apromies" aria-label="312 能手写promies实现就一定精通promies permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.1.2 能手写promies实现，就一定精通promies？</h3>
<p>我们刚刚实现的Promise/A+ 规范，重点围绕的是 How to implement 通过实现规范，或者所谓的吃透底层源码，以期打通任督二脉的武学幻想，是不切实际的。 想要精通 promises，还得在日常开发的各个异步场景中，多加思考和训练。 我们应当把精通 promises 定义为：
<strong>善于在各种异步场景中使用 promises 解决问题。</strong>
这里就很推荐promise迷你书 <sup><a href="http://liubin.org/promises-book/" title="promise迷你书">3</a></sup></p>
<h3 id="313-promise-是比-callback-更先进的异步方案" style="position:relative;"><a href="#313-promise-%E6%98%AF%E6%AF%94-callback-%E6%9B%B4%E5%85%88%E8%BF%9B%E7%9A%84%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88" aria-label="313 promise 是比 callback 更先进的异步方案 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.1.3 Promise 是比 callback 更先进的异步方案？</h3>
<p>正如前面所说的等价交换，语义化和标准化，不意味着能力的增强，它也有可能导致能力的减弱；所以谈不上先进，因为减少心智负担也是重要的一个环节。</p>
<ul>
<li>减少编码的心智负担，提高代码可维护性</li>
<li>只有两种callback路径，削弱了灵活性</li>
</ul>
<p>但是我们也要发现的是：promise 的 <code class="language-text">then</code> 只支持 <code class="language-text">onFulfilled</code> 和 <code class="language-text">onRejected</code> 两种 callback 路径，属于对所有可能的 callback 路径的简化。
同样是给有兴趣的同学，<a href="https://github.com/callbag/callbag" title="callbag">callbag</a>库可以使用多个callback函数组合，实现rxjs的observables和iterables。</p>
<h2 id="32-反模式" style="position:relative;"><a href="#32-%E5%8F%8D%E6%A8%A1%E5%BC%8F" aria-label="32 反模式 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.2 反模式</h2>
<p>最后的最后，我们来看几个反模式。</p>
<h3 id="321-anti-patterns-1" style="position:relative;"><a href="#321-anti-patterns-1" aria-label="321 anti patterns 1 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.2.1 Anti-patterns 1</h3>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/a8df6f5d79c0e2eb9b9c138c846e4b2a/627f4/A8DF6F5D79C0E2EB9B9C138C846E4B2A.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 58.22784810126582%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3VFB/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGBABAQADAAAAAAAAAAAAAAAAAQAQESH/2gAIAQEAAT8h6QsWs//aAAwDAQACAAMAAAAQMM//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAbEAEBAQACAwAAAAAAAAAAAAABABEhMUFhof/aAAgBAQABPxBdE69srx9tZzI3YIv/2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/a8df6f5d79c0e2eb9b9c138c846e4b2a/828fb/A8DF6F5D79C0E2EB9B9C138C846E4B2A.jpg"
        srcset="/static/a8df6f5d79c0e2eb9b9c138c846e4b2a/ff44c/A8DF6F5D79C0E2EB9B9C138C846E4B2A.jpg 158w,
/static/a8df6f5d79c0e2eb9b9c138c846e4b2a/a6688/A8DF6F5D79C0E2EB9B9C138C846E4B2A.jpg 315w,
/static/a8df6f5d79c0e2eb9b9c138c846e4b2a/828fb/A8DF6F5D79C0E2EB9B9C138C846E4B2A.jpg 630w,
/static/a8df6f5d79c0e2eb9b9c138c846e4b2a/627f4/A8DF6F5D79C0E2EB9B9C138C846E4B2A.jpg 810w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图3.1 Anti-patterns 1</p>
<p>这块的问题在于没有使用promise方法链。</p>
<ol>
<li><code class="language-text">promise.then</code>中产生的异常不会被外部捕获</li>
<li>每次 <code class="language-text">promise.then</code> 调用都会返回一个新创建的promise对象，不能得到 <code class="language-text">then</code> 的返回值</li>
</ol>
<p>解决方法如图3.2所示
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/305e536e9ae1c3d8bc74c284c27d441d/627f4/305E536E9AE1C3D8BC74C284C27D441D.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 53.79746835443038%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3VoB/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGRAAAgMBAAAAAAAAAAAAAAAAAAERIDFR/9oACAEBAAE/IcJfBU//2gAMAwEAAgADAAAAECDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBABAAEEAwAAAAAAAAAAAAAAAQAQESExUWGB/9oACAEBAAE/EFdNdsG5ey5M4lihP//Z'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/305e536e9ae1c3d8bc74c284c27d441d/828fb/305E536E9AE1C3D8BC74C284C27D441D.jpg"
        srcset="/static/305e536e9ae1c3d8bc74c284c27d441d/ff44c/305E536E9AE1C3D8BC74C284C27D441D.jpg 158w,
/static/305e536e9ae1c3d8bc74c284c27d441d/a6688/305E536E9AE1C3D8BC74C284C27D441D.jpg 315w,
/static/305e536e9ae1c3d8bc74c284c27d441d/828fb/305E536E9AE1C3D8BC74C284C27D441D.jpg 630w,
/static/305e536e9ae1c3d8bc74c284c27d441d/627f4/305E536E9AE1C3D8BC74C284C27D441D.jpg 810w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图3.2 Anti-patterns 1 resolution</p>
<h3 id="322-anti-patterns-2" style="position:relative;"><a href="#322-anti-patterns-2" aria-label="322 anti patterns 2 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.2.2 Anti-patterns 2</h3>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/25393614a3d21e15b2d75eb6cc667f46/ad059/25393614A3D21E15B2D75EB6CC667F46.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 66.45569620253164%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3VFB/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGBAAAwEBAAAAAAAAAAAAAAAAAAERECH/2gAIAQEAAT8hfGURCZ//2gAMAwEAAgADAAAAEEDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAAICAwAAAAAAAAAAAAAAAQARIaExQZH/2gAIAQEAAT8QSlbWX7NzhG7dsCN59hP/2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/25393614a3d21e15b2d75eb6cc667f46/828fb/25393614A3D21E15B2D75EB6CC667F46.jpg"
        srcset="/static/25393614a3d21e15b2d75eb6cc667f46/ff44c/25393614A3D21E15B2D75EB6CC667F46.jpg 158w,
/static/25393614a3d21e15b2d75eb6cc667f46/a6688/25393614A3D21E15B2D75EB6CC667F46.jpg 315w,
/static/25393614a3d21e15b2d75eb6cc667f46/828fb/25393614A3D21E15B2D75EB6CC667F46.jpg 630w,
/static/25393614a3d21e15b2d75eb6cc667f46/ad059/25393614A3D21E15B2D75EB6CC667F46.jpg 758w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图3.3 Anti-patterns 2</p>
<p>这个不是一个很严重的反模式，不过还记不记得我们前面实现的时候有写一个resolvePromise方法可以处理不同情况下的result。利用好这一点：D</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/1f5f81c12726ec5bcda78e15e54a7e35/10435/1F5F81C12726EC5BCDA78E15E54A7E35.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 53.79746835443038%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3VFB/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAFxAAAwEAAAAAAAAAAAAAAAAAACAhMf/aAAgBAQABPyHCr//aAAwDAQACAAMAAAAQcA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAEBAQADAAAAAAAAAAAAAAABADERIVH/2gAIAQEAAT8QVw77Ct6iQThIAwi//9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/1f5f81c12726ec5bcda78e15e54a7e35/828fb/1F5F81C12726EC5BCDA78E15E54A7E35.jpg"
        srcset="/static/1f5f81c12726ec5bcda78e15e54a7e35/ff44c/1F5F81C12726EC5BCDA78E15E54A7E35.jpg 158w,
/static/1f5f81c12726ec5bcda78e15e54a7e35/a6688/1F5F81C12726EC5BCDA78E15E54A7E35.jpg 315w,
/static/1f5f81c12726ec5bcda78e15e54a7e35/828fb/1F5F81C12726EC5BCDA78E15E54A7E35.jpg 630w,
/static/1f5f81c12726ec5bcda78e15e54a7e35/10435/1F5F81C12726EC5BCDA78E15E54A7E35.jpg 944w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图3.4 Anti-patterns 2 resolution</p>
<h3 id="323-anti-patterns-3" style="position:relative;"><a href="#323-anti-patterns-3" aria-label="323 anti patterns 3 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.2.3 Anti-patterns 3</h3>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/fe03cf8560b940da8051bf0d8f8f2ae1/627f4/FE03CF8560B940DA8051BF0D8F8F2AE1.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 53.79746835443038%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3VFB/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGBAAAgMAAAAAAAAAAAAAAAAAAAERIDH/2gAIAQEAAT8hwkVP/9oADAMBAAIAAwAAABBwz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABsQAQEAAwADAAAAAAAAAAAAAAEAETFRQXGB/9oACAEBAAE/EFdU+sJ8Z9Wlg5Aci//Z'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/fe03cf8560b940da8051bf0d8f8f2ae1/828fb/FE03CF8560B940DA8051BF0D8F8F2AE1.jpg"
        srcset="/static/fe03cf8560b940da8051bf0d8f8f2ae1/ff44c/FE03CF8560B940DA8051BF0D8F8F2AE1.jpg 158w,
/static/fe03cf8560b940da8051bf0d8f8f2ae1/a6688/FE03CF8560B940DA8051BF0D8F8F2AE1.jpg 315w,
/static/fe03cf8560b940da8051bf0d8f8f2ae1/828fb/FE03CF8560B940DA8051BF0D8F8F2AE1.jpg 630w,
/static/fe03cf8560b940da8051bf0d8f8f2ae1/627f4/FE03CF8560B940DA8051BF0D8F8F2AE1.jpg 810w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图3.5 Anti-patterns 3</p>
<p>这里的问题就在于，<code class="language-text">somethingElseAsync</code>中抛出的函数不会被<code class="language-text">handleMyError</code>处理。
我们可以再注册一个 <code class="language-text">then</code> 方法；或者直接使用 <code class="language-text">catch</code> 语法糖。</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/786e3bb5c3937897950bb2eb47f5c120/627f4/786E3BB5C3937897950BB2EB47F5C120.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 58.22784810126582%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3aFB/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGRAAAwADAAAAAAAAAAAAAAAAAAEREDFh/9oACAEBAAE/IdF4IhFj/9oADAMBAAIAAwAAABAgz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABkQAQEAAwEAAAAAAAAAAAAAAAEAETGRQf/aAAgBAQABPxBXR6wveG0kJhgtEX//2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="IMAGE"
        title="IMAGE"
        src="/static/786e3bb5c3937897950bb2eb47f5c120/828fb/786E3BB5C3937897950BB2EB47F5C120.jpg"
        srcset="/static/786e3bb5c3937897950bb2eb47f5c120/ff44c/786E3BB5C3937897950BB2EB47F5C120.jpg 158w,
/static/786e3bb5c3937897950bb2eb47f5c120/a6688/786E3BB5C3937897950BB2EB47F5C120.jpg 315w,
/static/786e3bb5c3937897950bb2eb47f5c120/828fb/786E3BB5C3937897950BB2EB47F5C120.jpg 630w,
/static/786e3bb5c3937897950bb2eb47f5c120/627f4/786E3BB5C3937897950BB2EB47F5C120.jpg 810w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
图3.4 Anti-patterns 3 resolution</p>
<h2 id="33-附录" style="position:relative;"><a href="#33-%E9%99%84%E5%BD%95" aria-label="33 附录 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.3 附录</h2>
<p>参考：</p>
<ul>
<li>
<p>100行代码实现promise
<a href="https://mp.weixin.qq.com/s/qdJ0Xd8zTgtetFdlJL3P1g">https://mp.weixin.qq.com/s/qdJ0Xd8zTgtetFdlJL3P1g</a></p>
</li>
<li>
<p>深入理解Javascript异步 part1 part2<br>
<a href="https://github.com/wangfupeng1988/js-async-tutorial">https://github.com/wangfupeng1988/js-async-tutorial</a></p>
</li>
<li>
<p>promies迷你书
<a href="http://liubin.org/promises-book/">http://liubin.org/promises-book/</a></p>
</li>
<li>
<p>聊一聊promise的前世今生
<a href="https://www.cnblogs.com/tarol/p/9042407.html">https://www.cnblogs.com/tarol/p/9042407.html</a></p>
</li>
<li>
<p>更多的反模式
<a href="http://taoofcode.net/promise-anti-patterns/">http://taoofcode.net/promise-anti-patterns/</a></p>
</li>
</ul>
<h2 id="答案1-事件绑定算不算异步操作" style="position:relative;"><a href="#%E7%AD%94%E6%A1%881-%E4%BA%8B%E4%BB%B6%E7%BB%91%E5%AE%9A%E7%AE%97%E4%B8%8D%E7%AE%97%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C" aria-label="答案1 事件绑定算不算异步操作 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>答案1 事件绑定算不算异步操作</h2>
<p><span id="17:31:42-1"><a href="#17:31:42">⬆️ 返回 ⬆️</a></span></p>
<p>这个问题是在我研究这个主题的时候看到的一个讨论：
<a href="https://github.com/wangfupeng1988/js-async-tutorial/blob/master/part1-basic/03-event-bind.md">refer: 事件绑定算不算异步？</a></p>
<p>个人的见解在于，事件绑定是否属于异步操作需要看触发源是否在同一个 <a href="https://es5.github.io/#x10.3">execution context</a> 中。</p>
<p>通过判断有没有runtime的介入：如果仅仅是在js engine下，它只负责取消息，不负责生产消息；那么在代码中编写的事件绑定就属于一类同步操作；</p>
<p>如果有runtime的介入，比如浏览器DOM事件发送一条合成事件（SyntheticEvent）统一处理，或者是监听onload消息等，js engine在清理完call-stack后接受接收到这条消息并且执行，这时候就可以认为它是异步操作。</p></section><hr/><footer><div class="bio"><div data-gatsby-image-wrapper="" style="width:50px;height:50px" class="gatsby-image-wrapper bio-avatar"><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear;background-color:#f8f8d8;width:50px;height:50px;position:relative"></div><picture><source type="image/avif" data-srcset="/static/4655395e621ec4fe1c820568eacc54d1/d4bf4/logo_g.avif 50w,/static/4655395e621ec4fe1c820568eacc54d1/ee81f/logo_g.avif 100w" sizes="50px"/><source type="image/webp" data-srcset="/static/4655395e621ec4fe1c820568eacc54d1/3faea/logo_g.webp 50w,/static/4655395e621ec4fe1c820568eacc54d1/6a679/logo_g.webp 100w" sizes="50px"/><img data-gatsby-image-ssr="" layout="fixed" data-main-image="" style="opacity:0" sizes="50px" decoding="async" loading="lazy" data-src="/static/4655395e621ec4fe1c820568eacc54d1/d24ee/logo_g.jpg" data-srcset="/static/4655395e621ec4fe1c820568eacc54d1/d24ee/logo_g.jpg 50w,/static/4655395e621ec4fe1c820568eacc54d1/64618/logo_g.jpg 100w" alt="Profile picture"/></picture><noscript><picture><source type="image/avif" srcSet="/static/4655395e621ec4fe1c820568eacc54d1/d4bf4/logo_g.avif 50w,/static/4655395e621ec4fe1c820568eacc54d1/ee81f/logo_g.avif 100w" sizes="50px"/><source type="image/webp" srcSet="/static/4655395e621ec4fe1c820568eacc54d1/3faea/logo_g.webp 50w,/static/4655395e621ec4fe1c820568eacc54d1/6a679/logo_g.webp 100w" sizes="50px"/><img data-gatsby-image-ssr="" layout="fixed" data-main-image="" style="opacity:0" sizes="50px" decoding="async" loading="lazy" src="/static/4655395e621ec4fe1c820568eacc54d1/d24ee/logo_g.jpg" srcSet="/static/4655395e621ec4fe1c820568eacc54d1/d24ee/logo_g.jpg 50w,/static/4655395e621ec4fe1c820568eacc54d1/64618/logo_g.jpg 100w" alt="Profile picture"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1)}}</script></div><p>Written by <strong>何坤舆</strong> <!-- -->EFE<!-- --> </p></div></footer></article><aside class="aside-content"><div class="css-toc"><div class="title">TOC</div><div><ul>
<li>
<p><a href="#1-%E5%89%8D%E8%A8%80">1. 前言</a></p>
<ul>
<li>
<p><a href="#11-%E4%B8%BA%E4%BD%95%E4%BC%9A%E6%9C%89%E5%BC%82%E6%AD%A5">1.1 为何会有异步</a></p>
</li>
<li>
<p><a href="#12-%E5%BC%82%E6%AD%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86">1.2 异步的实现原理</a></p>
<ul>
<li><a href="#121-%E5%B8%B8%E8%A7%81%E7%9A%84%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C">1.2.1 常见的异步操作：</a></li>
<li><a href="#122-%E4%BA%8B%E4%BB%B6%E7%BB%91%E5%AE%9A%E7%AE%97%E4%B8%8D%E7%AE%97%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C">1.2.2 事件绑定算不算异步操作？</a></li>
</ul>
</li>
<li>
<p><a href="#13-%E5%BC%82%E6%AD%A5%E7%9A%84%E6%BC%94%E8%BF%9B%E6%96%B9%E6%A1%88">1.3 异步的演进方案</a></p>
<ul>
<li><a href="#131-deferred%E5%92%8Cpromise%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB">1.3.1 <code class="language-text">$.deferred</code>和<code class="language-text">$.promise</code>有什么区别？</a></li>
<li><a href="#132-callback%E7%9A%84%E5%BC%95%E5%85%A5">1.3.2 callback的引入</a></li>
<li><a href="#133-promise%E4%B9%9F%E6%98%AFcallback">1.3.3 promise也是callback？</a></li>
<li><a href="#134-generator%E4%B9%9F%E6%98%AFcallback">1.3.4 generator也是callback？</a></li>
<li><a href="#135-%E6%9C%80%E5%90%8E%E6%BC%94%E8%BF%9B%E5%88%B0asyncawait">1.3.5 最后演进到async/await</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><a href="#2-promise">2 Promise</a></p>
<ul>
<li>
<p><a href="#21-%E6%A6%82%E8%A7%88">2.1 概览</a></p>
<ul>
<li><a href="#211-%E5%9B%BE21%E4%B8%AD%E4%BF%A9%E8%80%85%E7%9A%84promise%E6%9C%89%E5%95%A5%E5%8C%BA%E5%88%AB">2.1.1 图2.1中俩者的promise有啥区别？</a></li>
</ul>
</li>
<li>
<p><a href="#22-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA-promisea-%E8%A7%84%E8%8C%83">2.2 实现一个 Promise/A+ 规范</a></p>
<ul>
<li><a href="#221-%E5%89%8D%E6%9C%9F%E5%B7%A5%E4%BD%9C">2.2.1 前期工作</a></li>
<li><a href="#222-%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0">2.2.2 开始实现</a></li>
<li><a href="#223-%E6%9C%AF%E8%AF%AD---1terminology">2.2.3 术语 - 1.terminology</a></li>
<li><a href="#224-promise%E7%9A%84%E7%8A%B6%E6%80%81---21-promise-states">2.2.4 promise的状态 - 2.1 Promise States</a></li>
<li><a href="#225-then-%E6%96%B9%E6%B3%95---22-the-then-method">2.2.5 then 方法 - 2.2 The then Method</a></li>
<li><a href="#226-then-%E6%96%B9%E6%B3%95---23-the-promise-resolution-procedure">2.2.6 then 方法 - 2.3 The Promise Resolution Procedure</a></li>
</ul>
</li>
<li>
<p><a href="#23-%E5%A2%9E%E5%BC%BA%E4%B8%BAes6%E7%9A%84promise">2.3 增强为ES6的promise</a></p>
<ul>
<li><a href="#231-promiseprototypecatch">2.3.1 Promise.prototype.catch</a></li>
<li><a href="#232-promiseall">2.3.2 Promise#all</a></li>
<li><a href="#232-promiserace">2.3.2 Promise#race</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><a href="#3-%E6%80%BB%E7%BB%93">3 总结</a></p>
<ul>
<li>
<p><a href="#31%E5%AE%9E%E7%8E%B0promise%E4%B9%8B%E5%90%8E%E7%9A%84%E6%80%9D%E8%80%83">3.1实现promise之后的思考</a></p>
<ul>
<li><a href="#311-%E5%AE%83%E6%98%AF%E4%B8%80%E4%B8%AAcallback-management">3.1.1 它是一个callback management</a></li>
<li><a href="#312-%E8%83%BD%E6%89%8B%E5%86%99promies%E5%AE%9E%E7%8E%B0%E5%B0%B1%E4%B8%80%E5%AE%9A%E7%B2%BE%E9%80%9Apromies">3.1.2 能手写promies实现，就一定精通promies？</a></li>
<li><a href="#313-promise-%E6%98%AF%E6%AF%94-callback-%E6%9B%B4%E5%85%88%E8%BF%9B%E7%9A%84%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88">3.1.3 Promise 是比 callback 更先进的异步方案？</a></li>
</ul>
</li>
<li>
<p><a href="#32-%E5%8F%8D%E6%A8%A1%E5%BC%8F">3.2 反模式</a></p>
<ul>
<li><a href="#321-anti-patterns-1">3.2.1 Anti-patterns 1</a></li>
<li><a href="#322-anti-patterns-2">3.2.2 Anti-patterns 2</a></li>
<li><a href="#323-anti-patterns-3">3.2.3 Anti-patterns 3</a></li>
</ul>
</li>
<li>
<p><a href="#33-%E9%99%84%E5%BD%95">3.3 附录</a></p>
</li>
<li>
<p><a href="#%E7%AD%94%E6%A1%881-%E4%BA%8B%E4%BB%B6%E7%BB%91%E5%AE%9A%E7%AE%97%E4%B8%8D%E7%AE%97%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C">答案1 事件绑定算不算异步操作</a></p>
</li>
</ul>
</li>
</ul></div></div></aside></div><nav class="blog-post-nav"><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/old-posts/2018-10-17-React-Components-Elements-and-Instance/">← <!-- -->一次打包错误 引起的对 React Components, Elements, Instance三者的认识</a></li><li><a rel="next" href="/old-posts/promise-pool/">js异步初探 - 图解并发控制<!-- --> →</a></li></ul></nav></main><footer>© <!-- -->2022<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.com">Gatsby</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/old-posts/javascript-concurrency-promise/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-b227d9031ab4094e5021.js"],"app":["/app-4383c413ae36d40e78e6.js"],"component---src-pages-404-js":["/component---src-pages-404-js-bb1698d01a7f9dde5caa.js"],"component---src-pages-index-all-js":["/component---src-pages-index-all-js-ec11b9dc98566a20cc21.js"],"component---src-pages-using-typescript-tsx":["/component---src-pages-using-typescript-tsx-9c9bb60840b1cd34d351.js"],"component---src-templates-blog-list-js":["/component---src-templates-blog-list-js-35c21d3a23de5beb9324.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-8c7ff09d6d39e7b3577e.js"]};/*]]>*/</script><script src="/polyfill-b227d9031ab4094e5021.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-8c7ff09d6d39e7b3577e.js" async=""></script><script src="/commons-4801747b9acaf7a900b9.js" async=""></script><script src="/app-4383c413ae36d40e78e6.js" async=""></script><script src="/framework-e413e527015be9a1bdfd.js" async=""></script><script src="/webpack-runtime-428b742e2ddd83d8ad30.js" async=""></script></body></html>
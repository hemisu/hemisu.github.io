{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/old-posts/promise-pool/",
    "result": {"data":{"site":{"siteMetadata":{"title":"何米酥`s Blog"}},"markdownRemark":{"id":"7e002c77-fc4e-5f11-95b7-b6279b770e6c","excerpt":"前言 本篇起因源一个问题，Promise.all的限制并发数是多少？ 这个可以通过  的测试用例得知这个数字不超过 ： 平时在社区中，我们也偶尔会看到这样一道题： 请实现如下函数，可以批量请求数据,所有的 url 地址在 urls 参数中，同时可以通过 max…","html":"<h2 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h2>\n<p>本篇起因源一个问题，Promise.all的限制并发数是多少？</p>\n<p>这个可以通过 <code class=\"language-text\">V8</code> 的<a href=\"https://github.com/v8/v8/blob/4b9b23521e6fd42373ebbcb20ebe03bf445494f9/test/mjsunit/es6/promise-all-overflow-1.js#L9-L12\">测试用例</a>得知这个数字不超过 <code class=\"language-text\">2097151</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> a <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">**</span> <span class=\"token number\">21</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> a<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> a<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> p<span class=\"token punctuation\">;</span>\n<span class=\"token function\">testAsync</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">assert</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  assert<span class=\"token punctuation\">.</span><span class=\"token function\">plan</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>assert<span class=\"token punctuation\">.</span>unreachable<span class=\"token punctuation\">,</span> <span class=\"token parameter\">reason</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    assert<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> reason <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">RangeError</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>平时在社区中，我们也偶尔会看到这样一道题：</p>\n<blockquote>\n<p>请实现如下函数，可以批量请求数据,所有的 url 地址在 urls 参数中，同时可以通过 max 参数控制请求的并发数，当所有请求结束之后，需要执行 callback 回调函数，发送请求的函数可以直接使用 fetch 即可</p>\n</blockquote>\n<p>这道题我们发现，发送请求的函数使用 <code class=\"language-text\">fetch</code> 可知这是在在浏览器环境中；浏览器其实对同一域名的并发数量有所限制，比如 <code class=\"language-text\">Chrome</code> 就限制了 <code class=\"language-text\">6</code> 个，所以这里的 <code class=\"language-text\">max</code> 我们可以认为是不超过 <code class=\"language-text\">10</code> 个。解决这类限制我们可以通过多域名的形式优化。</p>\n<!-- more -->\n<p>以目前的网络环境，我们恨不得增加浏览器的单域名并发请求上限。这么看来这道题的实用性很小喽？</p>\n<p>然而，在工作中遇到了一个这样问题，让我发现这题有它的应用场景。</p>\n<blockquote>\n<p>发送邮件和IM消息需要调用三方提供的API接口，而这个接口分别限制了150/min和600/min的上限</p>\n</blockquote>\n<p>假设我们不作限制，直接使用 <code class=\"language-text\">promise.all</code> 实例化所有的消息发起请求，假设接口请求返回时间是 <code class=\"language-text\">1s</code> 的话， 直接突破了 <code class=\"language-text\">6 * 60 > 150</code>  的限制导致后续的请求失效。</p>\n<p>首先我们定制一个测试用例，限制并发数 <code class=\"language-text\">limit</code> 为 <code class=\"language-text\">2</code></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> results <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">timeout</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">i</span> <span class=\"token operator\">=></span>\n  <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span> <span class=\"token operator\">=></span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      results<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> i\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> urls <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">,</span> <span class=\"token number\">300</span><span class=\"token punctuation\">,</span> <span class=\"token number\">200</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>那么执行之后会有以下两个结果：</p>\n<ol>\n<li>如果没有限制成功，得到的结果应该是 <code class=\"language-text\">[100, 200, 300, 500]</code></li>\n<li>如果限制并发数成功，得到的结果应该是 <code class=\"language-text\">[100, 300, 500, 200]</code></li>\n</ol>\n<p>如图所示\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f3cee4f8c006ddc1dc236e2512e444ed/79e48/1.%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.93670886075949%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABZElEQVQoz42S70vCQBzG9/+/KuxNhEaFgtWLCIJKKDS1TDJJQxxmm7dNicK5u7ndtvOJnUorEzx4uC9fnvvccz8Uz/cxcTmYF0rZjIO6PuIxm82klvUmQ+FBBNcPEEZCKgjnsxCrsLjvBRH8NYoiAaVFHJzUzLU7JlM2dRuHZYL9EkG+ZiF7byJTGiBbNZG5I7hojqC0Bjb2bjWc1i3ZOHsa4qhCkC4O0BtRCYrEHFhVP7F1+YadQh/poo7dGw2pQh+p6z7axAYPBZSO6SBTIjh+tHBQNnDeGKFtOGhoE3xRLkFikXBk+3ghDl4Niu6QoWNRWcd+6oXzO2zqY2xf9ZCtEOSqBp618cqRN32U2KPE9Hz9A7kHC0PbXySap0pC/gJnCSW9ShBw6No7GKOIvxBzp3Bd91eyZe15HnRdB2NM1ksJIX4Scs7R7aoYj20JopRK/QecTqdQVRWO40ho7IvXJIHfu4Or85ZV/UkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/f3cee4f8c006ddc1dc236e2512e444ed/f058b/1.%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B.png\"\n        srcset=\"/static/f3cee4f8c006ddc1dc236e2512e444ed/c26ae/1.%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B.png 158w,\n/static/f3cee4f8c006ddc1dc236e2512e444ed/6bdcf/1.%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B.png 315w,\n/static/f3cee4f8c006ddc1dc236e2512e444ed/f058b/1.%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B.png 630w,\n/static/f3cee4f8c006ddc1dc236e2512e444ed/79e48/1.%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B.png 865w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"尝试1-失败的第一次\" style=\"position:relative;\"><a href=\"#%E5%B0%9D%E8%AF%951-%E5%A4%B1%E8%B4%A5%E7%9A%84%E7%AC%AC%E4%B8%80%E6%AC%A1\" aria-label=\"尝试1 失败的第一次 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>尝试1. 失败的第一次</h2>\n<p><a href=\"https://runkit.com/hemisu/concurrency-limit-1\">在 runkit 中运行</a>\n我们可以利用 <code class=\"language-text\">Promise.all</code> 配合 <code class=\"language-text\">ES7</code> 的 <code class=\"language-text\">async</code> 语法实现一个简单的并发限制</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> urls<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>urls<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> i <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_</span> <span class=\"token operator\">=></span> <span class=\"token function\">timeout</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Array(4) [100, 500, 200, 300]</span></code></pre></div>\n<p>执行得到的结果是 <code class=\"language-text\">Array(4) [100, 500, 200, 300]</code>，和我们前面提到的不符鸭，画个图康康</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 599px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/52737f560316e1893dbf18f07f2d841e/43142/2.%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.0253164556962%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABj0lEQVQoz42S0WvTUBjF88/6KswH2cMGexN8GAg+7En24gaV7cWKIuJwsLmtuK4G0642bdqHZWnTtA1ZlvXem5/clJS2rtoDh3w5+e75zneJATAajSidnWLbNo7jYFmWlknTdEqNu/ie8o8SlfIlgd/ll1khR95jSJXS7kU0vZDo/gGpFGMhUGmKUhPqHt1/E8TYtyENd0jLG9G8DWl1I+4SMTU1krFk52ubrcNr/DDhXyic3/D0rcXmYZ3tTy2e7Vd58sbkyhlk3/VwQ0jFhR1wXO1xWu9nLNkBpWaQ1d9/9zmp9yk7AyrtId+qPc4bfY6sLu4gzlLpDaYJx0Lx6nOL9UKNjYNr1t/VePG+wcsPdlZr7XmhxvZHm93jNhsHdV5/cVjbs/jZGU6SzdyzkbuvgvzQX1o6k1C7CzmZoP7DsVRz7+mMUQ5j8fdYxtlEi/qc4WNrLFv3MYNFZAnjOMb3faIoQghBkiTZM69XMZoz7HQ6FItFTNMkDENc180GaHqeh5RydcNlTYv6qlfzBwuplde6+UAWAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/52737f560316e1893dbf18f07f2d841e/43142/2.%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0.png\"\n        srcset=\"/static/52737f560316e1893dbf18f07f2d841e/c26ae/2.%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0.png 158w,\n/static/52737f560316e1893dbf18f07f2d841e/6bdcf/2.%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0.png 315w,\n/static/52737f560316e1893dbf18f07f2d841e/43142/2.%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0.png 599w\"\n        sizes=\"(max-width: 599px) 100vw, 599px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>很显然，这个是不符合我们要求的；我们不可能等到这两个通道里最晚的执行完毕后再发起下一波请求。</p>\n<h2 id=\"尝试2-限制通道数\" style=\"position:relative;\"><a href=\"#%E5%B0%9D%E8%AF%952-%E9%99%90%E5%88%B6%E9%80%9A%E9%81%93%E6%95%B0\" aria-label=\"尝试2 限制通道数 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>尝试2. 限制通道数</h2>\n<p><a href=\"https://runkit.com/hemisu/concurrency-limit-2\">在 runkit 中运行</a></p>\n<p>既然我们需要在 <code class=\"language-text\">100</code> 执行完后立刻放入下一个 <code class=\"language-text\">500</code>，我们就需要抛弃这个 <code class=\"language-text\">Promise.all</code> 来进行一次尝试了</p>\n<p>这里我们可以假想有 <code class=\"language-text\">2</code> 个通道，开始时我们先填满这 <code class=\"language-text\">2</code> 个通道，然后我们对其中运行的 <code class=\"language-text\">1</code> 和 <code class=\"language-text\">5</code> 注册一个回调函数，它可以做以下两件事：</p>\n<ol>\n<li>如果发现待执行的队列还有需要执行的，把它放入队列（如 <code class=\"language-text\">1</code> 执行完后就应当把 <code class=\"language-text\">3</code> 放入）</li>\n<li>如果发现执行完毕（此处应该有一个计数，统计当前已经请求完毕），那么不再取出数据并且决议完成（或者执行完成后的回调）</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">limitRun</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> index <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> cnt <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 计数君</span>\n  <span class=\"token keyword\">let</span> idx <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 通道数</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">_request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>idx <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> cnt <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> item <span class=\"token operator\">=</span> urls<span class=\"token punctuation\">[</span>index<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">// 取出一个用于请求</span>\n      idx<span class=\"token operator\">--</span> <span class=\"token comment\">// 占用通道</span>\n      <span class=\"token function\">timeout</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">finally</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 注册一个回调函数，做上面提到的两件事</span>\n        cnt<span class=\"token operator\">++</span> <span class=\"token comment\">// 计数+1</span>\n        idx<span class=\"token operator\">++</span> <span class=\"token comment\">// 释放通道</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cnt <span class=\"token operator\">===</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 2. 如果发现执行完毕（此处应该有一个计数，统计当前已经请求完毕），那么不再取出数据并且决议完成（或者执行完成后的回调）</span>\n          <span class=\"token comment\">// do something..</span>\n          console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'执行完毕'</span><span class=\"token punctuation\">,</span> results<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 1. 如果发现待执行的队列还有需要执行的，把它放入队列（如 `1` 执行完后就应当把 `3` 放入）</span>\n          <span class=\"token function\">_request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 递归执行</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">_request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token function\">limitRun</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// Array(4) [100, 300, 500, 200]</span></code></pre></div>\n<p>通过这样的方式，我们第一次得到了正确答案。简单的抽象一下，我们就可以得到一个工具函数。</p>\n<h2 id=\"尝试3-第一次抽象\" style=\"position:relative;\"><a href=\"#%E5%B0%9D%E8%AF%953-%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%8A%BD%E8%B1%A1\" aria-label=\"尝试3 第一次抽象 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>尝试3. 第一次抽象</h2>\n<p><a href=\"https://runkit.com/hemisu/concurrency-limit-3\">在 runkit 中运行</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">/**\n * 并发工具函数\n * @param {any[]} queue 待处理队列\n * @param {() => Promise&lt;any>} fn 异步函数，返回一个promise\n * @param {Number} max 并发上限\n * @param {() => any} callback 回调\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">sendRequestIdle</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">,</span> <span class=\"token function-variable function\">fn</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> max <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> len <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> idx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> cnt <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">_request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>idx <span class=\"token operator\">&lt;</span> len <span class=\"token operator\">&amp;&amp;</span> max <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      max<span class=\"token operator\">--</span>\n      <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">[</span>idx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">finally</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        max<span class=\"token operator\">++</span>\n        cnt<span class=\"token operator\">++</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>len <span class=\"token operator\">===</span> cnt<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">_request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">_request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">sendRequestIdle</span><span class=\"token punctuation\">(</span>urls<span class=\"token punctuation\">,</span> timeout<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"尝试4-进一步优化\" style=\"position:relative;\"><a href=\"#%E5%B0%9D%E8%AF%954-%E8%BF%9B%E4%B8%80%E6%AD%A5%E4%BC%98%E5%8C%96\" aria-label=\"尝试4 进一步优化 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>尝试4. 进一步优化</h2>\n<p><a href=\"https://runkit.com/hemisu/concurrency-limit4\">在 runkit 中运行</a></p>\n<p>其实到了上一步，已经满足了我们的需求。我们可以更进一步，把递归优化成迭代的形式。</p>\n<p>这一步的工作是为了方便我们更进一步，可以更方便的去管理异步队列，抽象为一个个池子单独运行。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">LimitPool</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">max</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_max <span class=\"token operator\">=</span> max\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_idle <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_queue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fn<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> task <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">_createTask</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_idle <span class=\"token operator\">>=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_max<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 大于目前通道数 放入队列中</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_queue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">task</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">_createTask</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fn<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">,</span> _resolve<span class=\"token punctuation\">,</span> _reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 惰性计算 如果返回，会直接计算fn，Promise的构造函数是直接运行的，不会异步执行</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>_resolve<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>_reject<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">finally</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_idle<span class=\"token operator\">--</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_queue<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> task <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_queue<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token function\">task</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// console.log('队列清空完毕')</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_idle<span class=\"token operator\">++</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 初始化请求池</span>\n<span class=\"token keyword\">const</span> limitPool <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LimitPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 请求就完事了，根本不慌</span>\n<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token keyword\">of</span> urls<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">limitPool</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>timeout<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">/**\n * 输出结果：\n * Array(1) [100]\n * Array(2) [100, 300]\n * Array(3) [100, 300, 500]\n * Array(4) [100, 300, 500, 200]\n */</span></code></pre></div>\n<p>此条参考的是 <a href=\"https://github.com/leejialing/limit-promise/blob/master/lib/LimitPromise.js\">limit-promise</a></p>\n<p>后续按照下载量排名讲解几个社区内的并发控制库</p>\n<p><a href=\"https://www.npmjs.com/package/tiny-async-pool\">async-pool</a>、<a href=\"https://www.npmjs.com/package/p-limit\">p-limit</a></p>\n<h2 id=\"读三方库\" style=\"position:relative;\"><a href=\"#%E8%AF%BB%E4%B8%89%E6%96%B9%E5%BA%93\" aria-label=\"读三方库 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>读三方库</h2>\n<p>接下来解读俩个社区内的并发控制库</p>\n<ul>\n<li><a href=\"https://www.npmjs.com/package/tiny-async-pool\">tiny-async-pool</a></li>\n<li><a href=\"https://www.npmjs.com/package/p-limit\">p-limit</a></li>\n</ul>\n<h3 id=\"1-tiny-async-pool\" style=\"position:relative;\"><a href=\"#1-tiny-async-pool\" aria-label=\"1 tiny async pool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. tiny-async-pool</h3>\n<p><a href=\"https://runkit.com/hemisu/tiny-async-pool-es7\">在 runkit 中运行</a></p>\n<p>第一个库如名字所示，突出一个小巧。它有<a href=\"https://github.com/rxaviers/async-pool/tree/master/lib\">两种版本</a>的实现。</p>\n<h4 id=\"es7版本\" style=\"position:relative;\"><a href=\"#es7%E7%89%88%E6%9C%AC\" aria-label=\"es7版本 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ES7版本</h4>\n<p>该版本使用 <code class=\"language-text\">Promise.all</code> 和 <code class=\"language-text\">Promise.race</code> 组合进行实现，单纯的使用 <code class=\"language-text\">Promise.all</code> 的结果已经在上文中展现了，无法满足我们的需求。</p>\n<p>此处使用 <code class=\"language-text\">Promise.all</code> 的作用仅仅是提取结果，阻塞后续请求的底层能力是由 <code class=\"language-text\">for of loop</code> + <code class=\"language-text\">async function</code> 语法糖中调用的 <code class=\"language-text\">Generator</code> 作为协程提供的。</p>\n<p>这里值得注意的是两次调用 <code class=\"language-text\">.then</code> ，是会返回的不同的promise对象<a href=\"http://liubin.org/promises-book/#then-return-new-promise\">参考</a>。</p>\n<p>以下是 <code class=\"language-text\">ES7</code> 版本的解读</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">asyncPool</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">poolLimit<span class=\"token punctuation\">,</span> array<span class=\"token punctuation\">,</span> iteratorFn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 存储结果队列</span>\n  <span class=\"token keyword\">const</span> ret <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 存储执行队列，该队列长度不会超过 poolLimit 的大小</span>\n  <span class=\"token keyword\">const</span> executing <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> item <span class=\"token keyword\">of</span> array<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 实例化，如果有请求则在此处进行</span>\n    <span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">iteratorFn</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">,</span> array<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 将注册 iteratorFn 回调的 Promise 放入结果队列</span>\n    ret<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 新的 Promise 对象，执行后会将自己从执行队列中剔除</span>\n    <span class=\"token keyword\">const</span> e <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> executing<span class=\"token punctuation\">.</span><span class=\"token function\">splice</span><span class=\"token punctuation\">(</span>executing<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 加入执行队列</span>\n    executing<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 如果执行队列已满</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>executing<span class=\"token punctuation\">.</span>length <span class=\"token operator\">>=</span> poolLimit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 协程阻塞，直到一个任务（请求）成功或者失败</span>\n      <span class=\"token comment\">// 再执行下一轮 for of</span>\n      <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">race</span><span class=\"token punctuation\">(</span>executing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 类似于 Monad 中将 Unit :: a -> monad a 的 a 取出</span>\n  <span class=\"token comment\">// 通过 Promise.all 将结果数组 ret 中的 Promise 结果提取</span>\n  <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"es6版本\" style=\"position:relative;\"><a href=\"#es6%E7%89%88%E6%9C%AC\" aria-label=\"es6版本 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ES6版本</h4>\n<p><a href=\"https://runkit.com/hemisu/tiny-async-pool-es6\">在 runkit 中运行</a></p>\n<p>在理解了上述 <code class=\"language-text\">ES7</code> 的版本之后，我们看ES6的版本会轻松很多；</p>\n<p>核心的两个数组 <code class=\"language-text\">ret</code> 和 <code class=\"language-text\">executing</code> 的用处已经在上面解释过了</p>\n<p>下面仅注释与上文不同的地方：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">asyncPool</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">poolLimit<span class=\"token punctuation\">,</span> array<span class=\"token punctuation\">,</span> iteratorFn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 记录执行到第 i 个任务</span>\n  <span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> ret <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> executing <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">enqueue</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 递归出口： 如果任务执行完，返回 Resolved Promise</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">===</span> array<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> item <span class=\"token operator\">=</span> array<span class=\"token punctuation\">[</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">iteratorFn</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">,</span> array<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ret<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> e <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> executing<span class=\"token punctuation\">.</span><span class=\"token function\">splice</span><span class=\"token punctuation\">(</span>executing<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    executing<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 这里就是与上面不同的第一处关键点</span>\n    <span class=\"token comment\">// r 默认声明为 Resolved Promise</span>\n    <span class=\"token comment\">// 当执行队列 executing 被占满后，</span>\n    <span class=\"token comment\">// r 会被替换为 Promise.race 等待其中一个任务的完成</span>\n    <span class=\"token keyword\">let</span> r <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>executing<span class=\"token punctuation\">.</span>length <span class=\"token operator\">>=</span> poolLimit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      r <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">race</span><span class=\"token punctuation\">(</span>executing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 同时注册回调，递归开始</span>\n    <span class=\"token keyword\">return</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"2-p-limit\" style=\"position:relative;\"><a href=\"#2-p-limit\" aria-label=\"2 p limit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. p-limit</h3>\n<p><a href=\"https://runkit.com/hemisu/p-limit\">在 runkit 中运行</a></p>\n<p>这是个周下载快 3 千万的库 🤔 (携带了 <code class=\"language-text\">p-</code> 一家子)，在读这个库之前我们先过一下前置知识。</p>\n<p>平时我们使用的 <code class=\"language-text\">Promise ES</code> 版本提供了这么些个实例方法给我们折腾：</p>\n<ul>\n<li><code class=\"language-text\">Promise.all</code></li>\n<li><code class=\"language-text\">Promise.allSetteld</code> (还没普及，babel 一下又不是不能用)</li>\n<li><code class=\"language-text\">Promise.race</code></li>\n<li><code class=\"language-text\">Promise.any</code> 对比 <code class=\"language-text\">race</code> 它返回第一个 <code class=\"language-text\">resolve</code> 的值 (支持度比 <code class=\"language-text\">allSetteld</code> 还低，babel 一下又不是不能用)</li>\n</ul>\n<p>可是在这个 <code class=\"language-text\">p-limit</code> 中调用了一个 <code class=\"language-text\">p-try</code> 的包（警觉。</p>\n<p>看完了挂在 README 的这篇 <a href=\"http://cryto.net/~joepie91/blog/2016/05/11/what-is-promise-try-and-why-does-it-matter/\">What is Promise.try, and why does it matter?</a> ，文章表达了以下几个 <code class=\"language-text\">Promise.try</code> 所带来的好处，详情可以进去see一下：</p>\n<ol>\n<li>更好地错误处理： 通过它可以把同步错误转为异步错误，统一处理避免一堆 <code class=\"language-text\">try..catch</code></li>\n<li>更好地交互： 不管你用的是哪种 Promise (p, bluebird…) 都可以转变为你目前用的 <code class=\"language-text\">Promise</code> 来执行调用链</li>\n<li>更好地see： 这个见仁见智，我觉得问题不大 🐶</li>\n</ol>\n<p>整了这么多高大上的我以为会看到又一份精妙代码，然后啃读，结果就一行整完了：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">promiseTry</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">func<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>arguments_</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span> <span class=\"token operator\">=></span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>arguments_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>接下来开始研读 <code class=\"language-text\">p-limit</code>： 首先从 <code class=\"language-text\">API</code> 入手，我们发现它先调用了 <code class=\"language-text\">pLimit(concurrency)</code> 限定了同时请求数目；这个和上文 <strong>尝试4. 进一步优化</strong> 的 <code class=\"language-text\">limit-promise</code> 有点相似，此处没有实例化对象，返回了一个闭包</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">pLimit</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">concurrency</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 校验参数</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Number<span class=\"token punctuation\">.</span><span class=\"token function\">isInteger</span><span class=\"token punctuation\">(</span>concurrency<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> concurrency <span class=\"token operator\">===</span> <span class=\"token number\">Infinity</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> concurrency <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Expected `concurrency` to be a number from 1 and up'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 待执行队列</span>\n  <span class=\"token keyword\">const</span> queue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 执行中的任务数 对比之前的实现，可以看作通道数 idle</span>\n\t<span class=\"token keyword\">let</span> activeCount <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 执行完毕后的回调函数</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">next</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 执行数目--， 等于释放通道</span>\n\t\tactiveCount<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 如果待执行队列不为空，取出一个继续执行</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tqueue<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 执行任务</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">run</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">fn<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 占用通道</span>\n    activeCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 此处实例化fn，如果有请求在这里才会正式发起</span>\n\t\t<span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">pTry</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 透传的 generator 中的 Promise resolve</span>\n\t\t<span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">await</span> result<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">//</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 执行完毕后 释放通道、检查待执行队列</span>\n\t\t<span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">enqueue</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">fn<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\tqueue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token function\">run</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> fn<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token comment\">// This function needs to wait until the next microtask before comparing</span>\n\t\t\t<span class=\"token comment\">// `activeCount` to `concurrency`, because `activeCount` is updated asynchronously</span>\n\t\t\t<span class=\"token comment\">// when the run function is dequeued and called. The comparison in the if-statement</span>\n      <span class=\"token comment\">// needs to happen asynchronously as well to get an up-to-date value for `activeCount`.</span>\n      <span class=\"token comment\">// 作为隔离多个 run 函数执行的作用，保持原子性</span>\n      <span class=\"token comment\">// 如果没有这一句，同时执行多个 run, 无法确保通道的占用和释放是安全的</span>\n\t\t\t<span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>activeCount <span class=\"token operator\">&lt;</span> concurrency <span class=\"token operator\">&amp;&amp;</span> queue<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\tqueue<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 闭包</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">generator</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">fn<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span> <span class=\"token operator\">=></span> <span class=\"token function\">enqueue</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 给闭包几个属性和方法</span>\n\tObject<span class=\"token punctuation\">.</span><span class=\"token function\">defineProperties</span><span class=\"token punctuation\">(</span>generator<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 返回目前执行的任务数</span>\n\t\tactiveCount<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token function-variable function\">get</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> activeCount\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// 返回待执行的任务数</span>\n\t\tpendingCount<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token function-variable function\">get</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> queue<span class=\"token punctuation\">.</span>length\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// 清空待执行队列</span>\n\t\tclearQueue<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token function-variable function\">value</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t\t\tqueue<span class=\"token punctuation\">.</span>length <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">return</span> generator<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"总结\" style=\"position:relative;\"><a href=\"#%E6%80%BB%E7%BB%93\" aria-label=\"总结 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>总结</h2>\n<p>本文从一道模仿HTTP并发请求和工作中的问题出发，简述了JS异步并发控制的方法，并对社区中几个常见库进行解读，希望可以带来不一样的思考，如果大家有不同的想法可以在评论区讨论交流。</p>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E5%89%8D%E8%A8%80\">前言</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%B0%9D%E8%AF%951-%E5%A4%B1%E8%B4%A5%E7%9A%84%E7%AC%AC%E4%B8%80%E6%AC%A1\">尝试1. 失败的第一次</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%B0%9D%E8%AF%952-%E9%99%90%E5%88%B6%E9%80%9A%E9%81%93%E6%95%B0\">尝试2. 限制通道数</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%B0%9D%E8%AF%953-%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%8A%BD%E8%B1%A1\">尝试3. 第一次抽象</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%B0%9D%E8%AF%954-%E8%BF%9B%E4%B8%80%E6%AD%A5%E4%BC%98%E5%8C%96\">尝试4. 进一步优化</a></p>\n</li>\n<li>\n<p><a href=\"#%E8%AF%BB%E4%B8%89%E6%96%B9%E5%BA%93\">读三方库</a></p>\n<ul>\n<li>\n<p><a href=\"#1-tiny-async-pool\">1. tiny-async-pool</a></p>\n<ul>\n<li><a href=\"#es7%E7%89%88%E6%9C%AC\">ES7版本</a></li>\n<li><a href=\"#es6%E7%89%88%E6%9C%AC\">ES6版本</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#2-p-limit\">2. p-limit</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E6%80%BB%E7%BB%93\">总结</a></p>\n</li>\n</ul>","frontmatter":{"title":"js异步初探 - 图解并发控制","date":"June 20, 2020","description":null}},"previous":{"fields":{"slug":"/old-posts/javascript-concurrency-promise/"},"frontmatter":{"title":"js异步初探 - promise"}},"next":{"fields":{"slug":"/old-posts/2020-09-27-webpack-bundling-live-by-hand/"},"frontmatter":{"title":"webpack原理 - 作者教你手把手打包"}}},"pageContext":{"id":"7e002c77-fc4e-5f11-95b7-b6279b770e6c","previousPostId":"1c84bcf6-b47b-5bad-be30-31744e154099","nextPostId":"dabf4f24-d8be-5126-aa76-47fdc9ef0861"}},
    "staticQueryHashes": ["2841359383","3257411868"]}
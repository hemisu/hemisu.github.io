{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/old-posts/javascript-concurrency-promise/",
    "result": {"data":{"site":{"siteMetadata":{"title":"何米酥`s Blog"}},"markdownRemark":{"id":"1c84bcf6-b47b-5bad-be30-31744e154099","excerpt":"js的异步编程是我们无法避免的话题之一：我们会在平时的编码过程中用到它，也会在面试中遇到它（大雾） 今天就对js的异步发展进行简单的探索，并且顺着流程了解并实现一个符合规范的promise来帮助更好地理解js中异步编程的处理逻辑： 本文第一章节将花费6～8min阅读时间；\n第二章如果不着手实现将花费10～15min…","html":"<p>js的异步编程是我们无法避免的话题之一：我们会在平时的编码过程中用到它，也会在面试中遇到它（大雾）</p>\n<p>今天就对js的异步发展进行简单的探索，并且顺着流程了解并实现一个符合规范的promise来帮助更好地理解js中异步编程的处理逻辑：</p>\n<p>本文第一章节将花费6～8min阅读时间；\n第二章如果不着手实现将花费10～15min理解时间；参与实现将花费1h :D\n第三章将花费4～6min阅读时间；</p>\n<p>行文仓促，如有错误还请指正。</p>\n<!-- more -->\n<h1 id=\"1-前言\" style=\"position:relative;\"><a href=\"#1-%E5%89%8D%E8%A8%80\" aria-label=\"1 前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 前言</h1>\n<h2 id=\"11-为何会有异步\" style=\"position:relative;\"><a href=\"#11-%E4%B8%BA%E4%BD%95%E4%BC%9A%E6%9C%89%E5%BC%82%E6%AD%A5\" aria-label=\"11 为何会有异步 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 为何会有异步</h2>\n<p>首先我们从为何会有异步入手，主要是有一下子两点原因：</p>\n<ol>\n<li>JS被涉及成单线程的语言，它自身只有一个单一的Call Stack，这就决定了它在某一时刻只能实现一件事情，因此它是同步的；</li>\n<li>目前我们所使用的异步实现都需要平台的支撑（v8或者其他引擎）其次，浏览器是异步的，且为了用户体验不可避免；比如我们打开哔哩哔哩这个网站，就可以发现在同一时间，浏览器的多个模块同时工作，包括：网络请求、渲染界面、DOM事件、定时器等；</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 144px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/668ba494d5a6aa497abe50455518d706/56357/668BA494D5A6AA497ABE50455518D706.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 94.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAATABQDASIAAhEBAxEB/8QAGAABAQADAAAAAAAAAAAAAAAAAAQBAgP/xAAVAQEBAAAAAAAAAAAAAAAAAAAAA//aAAwDAQACEAMQAAABs53y1nUoSowGwP/EABoQAAMBAAMAAAAAAAAAAAAAAAECAxASEyP/2gAIAQEAAQUCpSs3apmJdhW68kX0fAAM/8QAFhEAAwAAAAAAAAAAAAAAAAAAASAx/9oACAEDAQE/ATU//8QAFxEAAwEAAAAAAAAAAAAAAAAAAhESIP/aAAgBAgEBPwEVOP/EAB4QAAEEAgMBAAAAAAAAAAAAAAEAAhExECESIiNR/9oACAEBAAY/AoNGl0dyn6vQwVq02GwG3nWP/8QAGhABAQADAQEAAAAAAAAAAAAAAREAECFBUf/aAAgBAQABPyHjdtUy4RDvw51QXwMXmobneHYVYla6/9oADAMBAAIAAwAAABBsyAD/xAAWEQEBAQAAAAAAAAAAAAAAAAABESD/2gAIAQMBAT8QbOP/xAAXEQEAAwAAAAAAAAAAAAAAAAARASBh/9oACAECAQE/EIo7T//EAB0QAQABBAMBAAAAAAAAAAAAAAERACFBcRAxUWH/2gAIAQEAAT8QcWLHF3sqCOIAsrQKwFi2MT9qHWiGX2KJGWCOlMb5tFlRZXt4/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/668ba494d5a6aa497abe50455518d706/56357/668BA494D5A6AA497ABE50455518D706.jpg\"\n        srcset=\"/static/668ba494d5a6aa497abe50455518d706/56357/668BA494D5A6AA497ABE50455518D706.jpg 144w\"\n        sizes=\"(max-width: 144px) 100vw, 144px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.1 V8引擎</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 572px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9c12bb0e7427701125584da8535b8ca6/8d13f/9C12BB0E7427701125584DA8535B8CA6.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 106.32911392405065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAVABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAdilxK1AUD//xAAaEAACAwEBAAAAAAAAAAAAAAAAAQIQEhEx/9oACAEBAAEFAvTLOMjHKtV//8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAGhAAAgIDAAAAAAAAAAAAAAAAAAERICExQf/aAAgBAQAGPwLDRs4Qrf/EAB0QAAIBBAMAAAAAAAAAAAAAAAABERAxQVFhkbH/2gAIAQEAAT8hU+UcLqkx4rinaIexq7EhU//aAAwDAQACAAMAAAAQmAcA/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHRABAAICAgMAAAAAAAAAAAAAAQARITEQQVFxkf/aAAgBAQABPxAZHF7Fk15wkXak7qAwl1rbzLzd6ID0+SnJsqoGDzx//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/9c12bb0e7427701125584da8535b8ca6/8d13f/9C12BB0E7427701125584DA8535B8CA6.jpg\"\n        srcset=\"/static/9c12bb0e7427701125584da8535b8ca6/ff44c/9C12BB0E7427701125584DA8535B8CA6.jpg 158w,\n/static/9c12bb0e7427701125584da8535b8ca6/a6688/9C12BB0E7427701125584DA8535B8CA6.jpg 315w,\n/static/9c12bb0e7427701125584da8535b8ca6/8d13f/9C12BB0E7427701125584DA8535B8CA6.jpg 572w\"\n        sizes=\"(max-width: 572px) 100vw, 572px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.2 浏览器打开b站所做的工作</p>\n<h2 id=\"12-异步的实现原理\" style=\"position:relative;\"><a href=\"#12-%E5%BC%82%E6%AD%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86\" aria-label=\"12 异步的实现原理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 异步的实现原理</h2>\n<p>这里我们可以看一段网络请求代码，如图1.3：接收两个参数，其中success是一个函数，这个函数传递进去不会立即执行，而是等待请求之后再运行这行函数。对于这种传递过去不执行，等待结果之后才执行的函数，我们称他为<strong>回调函数</strong>（callback）。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aa7f49c6d13da4db21fd12805526e9f2/c2601/AA7F49C6D13DA4DB21FD12805526E9F2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.9620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHuTaIqv//EABcQAAMBAAAAAAAAAAAAAAAAAAASIDH/2gAIAQEAAQUCwaf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAYEAEAAwEAAAAAAAAAAAAAAAABABEgQf/aAAgBAQABPyFi3SDeP//aAAwDAQACAAMAAAAQu8//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPxCH/8QAGRABAQEAAwAAAAAAAAAAAAAAAREAEEFR/9oACAEBAAE/EFVBaz3FGidQxig6FvP/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/aa7f49c6d13da4db21fd12805526e9f2/828fb/AA7F49C6D13DA4DB21FD12805526E9F2.jpg\"\n        srcset=\"/static/aa7f49c6d13da4db21fd12805526e9f2/ff44c/AA7F49C6D13DA4DB21FD12805526E9F2.jpg 158w,\n/static/aa7f49c6d13da4db21fd12805526e9f2/a6688/AA7F49C6D13DA4DB21FD12805526E9F2.jpg 315w,\n/static/aa7f49c6d13da4db21fd12805526e9f2/828fb/AA7F49C6D13DA4DB21FD12805526E9F2.jpg 630w,\n/static/aa7f49c6d13da4db21fd12805526e9f2/c2601/AA7F49C6D13DA4DB21FD12805526E9F2.jpg 832w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.3 网络请求代码</p>\n<p>我们再来看一段nodejs中的代码，区别于前者的是，如图1.4所示的是一段文件I/O的处理。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e17178c5955c6292be26c8eaf3707e46/3f513/E17178C5955C6292BE26C8EAF3707E46.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.177215189873415%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3QUH/8QAFhAAAwAAAAAAAAAAAAAAAAAAABAh/9oACAEBAAEFAir/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAZEAACAwEAAAAAAAAAAAAAAAAAQQERIYH/2gAIAQEAAT8h1HBFs//aAAwDAQACAAMAAAAQAA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAbEAACAgMBAAAAAAAAAAAAAAABEQBhITFxkf/aAAgBAQABPxBASoVzn1MGjqf/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/e17178c5955c6292be26c8eaf3707e46/828fb/E17178C5955C6292BE26C8EAF3707E46.jpg\"\n        srcset=\"/static/e17178c5955c6292be26c8eaf3707e46/ff44c/E17178C5955C6292BE26C8EAF3707E46.jpg 158w,\n/static/e17178c5955c6292be26c8eaf3707e46/a6688/E17178C5955C6292BE26C8EAF3707E46.jpg 315w,\n/static/e17178c5955c6292be26c8eaf3707e46/828fb/E17178C5955C6292BE26C8EAF3707E46.jpg 630w,\n/static/e17178c5955c6292be26c8eaf3707e46/0ede0/E17178C5955C6292BE26C8EAF3707E46.jpg 945w,\n/static/e17178c5955c6292be26c8eaf3707e46/3f513/E17178C5955C6292BE26C8EAF3707E46.jpg 1096w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.4 nodejs中文件I/O的处理</p>\n<p>由此看来，实现异步的最核心原理在于：<strong>将callback作为参数传递给异步执行函数，当有结果之后再触发callback执行</strong></p>\n<p>我们可以收集一波常用的异步操作，大致分为以下三种：网络请求、IO操作、定时任务；</p>\n<h3 id=\"121-常见的异步操作\" style=\"position:relative;\"><a href=\"#121-%E5%B8%B8%E8%A7%81%E7%9A%84%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C\" aria-label=\"121 常见的异步操作 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2.1 常见的异步操作：</h3>\n<ul>\n<li>网络请求： ajax、http.get</li>\n<li>IO操作：readFile、readdir</li>\n<li>定时函数： setTimeout、setInterval</li>\n</ul>\n<p>那么，在这里提出第一个问题：</p>\n<h3 id=\"122-事件绑定算不算异步操作\" style=\"position:relative;\"><a href=\"#122-%E4%BA%8B%E4%BB%B6%E7%BB%91%E5%AE%9A%E7%AE%97%E4%B8%8D%E7%AE%97%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C\" aria-label=\"122 事件绑定算不算异步操作 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2.2 事件绑定算不算异步操作？</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/966dab00c8c1446882f06eb101f4ab95/15ec7/966DAB00C8C1446882F06EB101F4AB95.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.77215189873418%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3gUH/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFxABAAMAAAAAAAAAAAAAAAAAAAEhQf/aAAgBAQABPyHVof/aAAwDAQACAAMAAAAQAA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAYEAEAAwEAAAAAAAAAAAAAAAABABGBIf/aAAgBAQABPxBESXrMS1dn/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/966dab00c8c1446882f06eb101f4ab95/828fb/966DAB00C8C1446882F06EB101F4AB95.jpg\"\n        srcset=\"/static/966dab00c8c1446882f06eb101f4ab95/ff44c/966DAB00C8C1446882F06EB101F4AB95.jpg 158w,\n/static/966dab00c8c1446882f06eb101f4ab95/a6688/966DAB00C8C1446882F06EB101F4AB95.jpg 315w,\n/static/966dab00c8c1446882f06eb101f4ab95/828fb/966DAB00C8C1446882F06EB101F4AB95.jpg 630w,\n/static/966dab00c8c1446882f06eb101f4ab95/15ec7/966DAB00C8C1446882F06EB101F4AB95.jpg 690w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.5 事件绑定</p>\n<p>在公布答案之前，我们对比一下以下两者之间的区别：\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b7bc3b9378e53746c3d277e8370b16e8/fd879/B7BC3B9378E53746C3D277E8370B16E8.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.24050632911392%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3QUD/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFhABAQEAAAAAAAAAAAAAAAAAIQAQ/9oACAEBAAE/IWc//9oADAMBAAIAAwAAABDwD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABkQAQACAwAAAAAAAAAAAAAAAAEAESExUf/aAAgBAQABPxBotQ6zDU//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/b7bc3b9378e53746c3d277e8370b16e8/828fb/B7BC3B9378E53746C3D277E8370B16E8.jpg\"\n        srcset=\"/static/b7bc3b9378e53746c3d277e8370b16e8/ff44c/B7BC3B9378E53746C3D277E8370B16E8.jpg 158w,\n/static/b7bc3b9378e53746c3d277e8370b16e8/a6688/B7BC3B9378E53746C3D277E8370B16E8.jpg 315w,\n/static/b7bc3b9378e53746c3d277e8370b16e8/828fb/B7BC3B9378E53746C3D277E8370B16E8.jpg 630w,\n/static/b7bc3b9378e53746c3d277e8370b16e8/0ede0/B7BC3B9378E53746C3D277E8370B16E8.jpg 945w,\n/static/b7bc3b9378e53746c3d277e8370b16e8/fd879/B7BC3B9378E53746C3D277E8370B16E8.jpg 1010w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.6 事件绑定对比</p>\n<p>他们写法相同、执行方式也相同，都会将callback放入call-stack中通过eventloop调用；</p>\n<p>那么他们的不同之处在于：调用源不同，前者是用户手动触发、后者是系统读取完文件后调用；此外前者有着比较明显的“订阅-发布”的设计模式痕迹，后者则没有；</p>\n<details>\n  <summary style=\"font-size: 16px; font-weight: 700\">\n    请思考后展开答案\n  </summary>\n  <span id=\"17:31:42\">[答案1 事件绑定算不算异步操作](#17:31:42-1)</span>\n  是也不是，关键要看触发源来自于哪。\n</details>\n<h2 id=\"13-异步的演进方案\" style=\"position:relative;\"><a href=\"#13-%E5%BC%82%E6%AD%A5%E7%9A%84%E6%BC%94%E8%BF%9B%E6%96%B9%E6%A1%88\" aria-label=\"13 异步的演进方案 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.3 异步的演进方案</h2>\n<p>关于异步方案的演进，我们可以从图1.7梳理出这样一条链路</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8da0eb206c2f0c87bafeb9ff2a3fdba2/b4157/8DA0EB206C2F0C87BAFEB9FF2A3FDBA2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 157.59493670886076%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAgABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe6CqMg0D//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEAAQUCT//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CT//EABwQAAEEAwEAAAAAAAAAAAAAAAABESFREDFBcf/aAAgBAQABPyHwm8Ork4kdaE0TwdaE0f/aAAwDAQACAAMAAAAQ08xA/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHBABAAICAwEAAAAAAAAAAAAAAQARIUEQUWGR/9oACAEBAAE/EEdqzK6oXuIICyDbXzhQtFk9kS2YpWlzLCXKf//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/8da0eb206c2f0c87bafeb9ff2a3fdba2/828fb/8DA0EB206C2F0C87BAFEB9FF2A3FDBA2.jpg\"\n        srcset=\"/static/8da0eb206c2f0c87bafeb9ff2a3fdba2/ff44c/8DA0EB206C2F0C87BAFEB9FF2A3FDBA2.jpg 158w,\n/static/8da0eb206c2f0c87bafeb9ff2a3fdba2/a6688/8DA0EB206C2F0C87BAFEB9FF2A3FDBA2.jpg 315w,\n/static/8da0eb206c2f0c87bafeb9ff2a3fdba2/828fb/8DA0EB206C2F0C87BAFEB9FF2A3FDBA2.jpg 630w,\n/static/8da0eb206c2f0c87bafeb9ff2a3fdba2/b4157/8DA0EB206C2F0C87BAFEB9FF2A3FDBA2.jpg 688w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.7 异步方案的演进</p>\n<blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 490px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a341ec4d95771b63dedf1d075fb22e0b/6b254/A341EC4D95771B63DEDF1D075FB22E0B.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 9.49367088607595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAACABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB2aFB/8QAFhAAAwAAAAAAAAAAAAAAAAAAAAEQ/9oACAEBAAEFAoj/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAXEAEBAQEAAAAAAAAAAAAAAAAAUTFx/9oACAEBAAE/Ib1WH//aAAwDAQACAAMAAAAQgA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAACAwEAAAAAAAAAAAAAAAABEQAhQTH/2gAIAQEAAT8QQwIQdRwwA1bP/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/a341ec4d95771b63dedf1d075fb22e0b/6b254/A341EC4D95771B63DEDF1D075FB22E0B.jpg\"\n        srcset=\"/static/a341ec4d95771b63dedf1d075fb22e0b/ff44c/A341EC4D95771B63DEDF1D075FB22E0B.jpg 158w,\n/static/a341ec4d95771b63dedf1d075fb22e0b/a6688/A341EC4D95771B63DEDF1D075FB22E0B.jpg 315w,\n/static/a341ec4d95771b63dedf1d075fb22e0b/6b254/A341EC4D95771B63DEDF1D075FB22E0B.jpg 490w\"\n        sizes=\"(max-width: 490px) 100vw, 490px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n</blockquote>\n<p>callback到promise阶段发生在jquery时代，在jQuery 1.5版本 以前还有deferred的出现，之后在此基础上出现了promise；</p>\n<p>那么在这里再提出一个问题：</p>\n<h3 id=\"131-deferred和promise有什么区别\" style=\"position:relative;\"><a href=\"#131-deferred%E5%92%8Cpromise%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB\" aria-label=\"131 deferred和promise有什么区别 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.3.1 <code class=\"language-text\">$.deferred</code>和<code class=\"language-text\">$.promise</code>有什么区别？</h3>\n<p>首先说明，这里的deferred和promise都是jQuery上的对象，不是我们所熟悉的promise。\n在回答这个问题之前，先介绍一下deferrd：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/eda6100e00940edc16e34d1111856c0c/50066/EDA6100E00940EDC16E34D1111856C0C.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.025316455696203%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAACABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3JCwf//EABYQAAMAAAAAAAAAAAAAAAAAAAEQMf/aAAgBAQABBQJCf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAABD/2gAIAQEABj8Cf//EABcQAAMBAAAAAAAAAAAAAAAAAAABMRD/2gAIAQEAAT8hdHXl/9oADAMBAAIAAwAAABADz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAQACAwEAAAAAAAAAAAAAAAEAIRExQXH/2gAIAQEAAT8QVvY3dwjWzm5//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/eda6100e00940edc16e34d1111856c0c/828fb/EDA6100E00940EDC16E34D1111856C0C.jpg\"\n        srcset=\"/static/eda6100e00940edc16e34d1111856c0c/ff44c/EDA6100E00940EDC16E34D1111856C0C.jpg 158w,\n/static/eda6100e00940edc16e34d1111856c0c/a6688/EDA6100E00940EDC16E34D1111856C0C.jpg 315w,\n/static/eda6100e00940edc16e34d1111856c0c/828fb/EDA6100E00940EDC16E34D1111856C0C.jpg 630w,\n/static/eda6100e00940edc16e34d1111856c0c/0ede0/EDA6100E00940EDC16E34D1111856C0C.jpg 945w,\n/static/eda6100e00940edc16e34d1111856c0c/3ac88/EDA6100E00940EDC16E34D1111856C0C.jpg 1260w,\n/static/eda6100e00940edc16e34d1111856c0c/50066/EDA6100E00940EDC16E34D1111856C0C.jpg 1384w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>deferred有以上5种方法，我们将它区分为两类，前者属于用户掌握控制权，控制deferred对象的状态，后者则将这个权利交给它自身。</p>\n<details>\n  <summary style=\"font-size: 16px; font-weight: 700\">\n    请思考后展开答案\n  </summary>\n  他们的区别是：promise对象相比于deferred对象，缺少了.resolve和.reject这两个函数属性（没错，与如今的promie有略微区别），你无法在上述划分的第二类方法以外去决议(resolve or reject)一个promise的状态（这个与如今类似）；而deferred可以在外边直接决议；\n</details> \n<p>Promise在这里更多地被作为一个异步流程控制工具，而非一个订阅发布的事件模块，在此屏蔽了外部状态的改变。（当然，非主流之外的标准大家有兴趣可以自行搜寻或者看参考链接）</p>\n<p>按照主流的说法，callback被认为是一个最差的方案，会出现类似于回调地狱这类问题等；而async/await则被认为是所谓异步的终极解决方案。\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ce51a39e3aaf4592af69a73b34976d3f/f0afc/CE51A39E3AAF4592AF69A73B34976D3F.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.22784810126582%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAc2uIA//xAAYEAACAwAAAAAAAAAAAAAAAAAAAREgIf/aAAgBAQABBQJqDK//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAWEAEBAQAAAAAAAAAAAAAAAAARASD/2gAIAQEABj8CKa//xAAYEAACAwAAAAAAAAAAAAAAAAABEABRYf/aAAgBAQABPyG2sMKF/wD/2gAMAwEAAgADAAAAEPMP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhABAAMAAwAAAAAAAAAAAAAAARARIQAxgf/aAAgBAQABPxAttNnZXDTE8hK7P//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/ce51a39e3aaf4592af69a73b34976d3f/828fb/CE51A39E3AAF4592AF69A73B34976D3F.jpg\"\n        srcset=\"/static/ce51a39e3aaf4592af69a73b34976d3f/ff44c/CE51A39E3AAF4592AF69A73B34976D3F.jpg 158w,\n/static/ce51a39e3aaf4592af69a73b34976d3f/a6688/CE51A39E3AAF4592AF69A73B34976D3F.jpg 315w,\n/static/ce51a39e3aaf4592af69a73b34976d3f/828fb/CE51A39E3AAF4592AF69A73B34976D3F.jpg 630w,\n/static/ce51a39e3aaf4592af69a73b34976d3f/f0afc/CE51A39E3AAF4592AF69A73B34976D3F.jpg 658w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.8 回调地狱</p>\n<h3 id=\"132-callback的引入\" style=\"position:relative;\"><a href=\"#132-callback%E7%9A%84%E5%BC%95%E5%85%A5\" aria-label=\"132 callback的引入 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.3.2 callback的引入</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/171c910237c1cc49f9965242cee5f6c4/b3058/171C910237C1CC49F9965242CEE5F6C4.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.860759493670885%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAACABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB2wSD/8QAFhABAQEAAAAAAAAAAAAAAAAAAAEy/9oACAEBAAEFAplX/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFhABAQEAAAAAAAAAAAAAAAAAADFB/9oACAEBAAE/ITin/9oADAMBAAIAAwAAABAAD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABkQAAIDAQAAAAAAAAAAAAAAAAABITFxgf/aAAgBAQABPxC3ROHBh//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/171c910237c1cc49f9965242cee5f6c4/828fb/171C910237C1CC49F9965242CEE5F6C4.jpg\"\n        srcset=\"/static/171c910237c1cc49f9965242cee5f6c4/ff44c/171C910237C1CC49F9965242CEE5F6C4.jpg 158w,\n/static/171c910237c1cc49f9965242cee5f6c4/a6688/171C910237C1CC49F9965242CEE5F6C4.jpg 315w,\n/static/171c910237c1cc49f9965242cee5f6c4/828fb/171C910237C1CC49F9965242CEE5F6C4.jpg 630w,\n/static/171c910237c1cc49f9965242cee5f6c4/0ede0/171C910237C1CC49F9965242CEE5F6C4.jpg 945w,\n/static/171c910237c1cc49f9965242cee5f6c4/3ac88/171C910237C1CC49F9965242CEE5F6C4.jpg 1260w,\n/static/171c910237c1cc49f9965242cee5f6c4/b3058/171C910237C1CC49F9965242CEE5F6C4.jpg 1296w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.9 callback</p>\n<p>从流行的趋势来看，这种说法不无道理，我们确实从callback style一步步走到了今天大量使用 async/await 的阶段。那么，是否真是如此？</p>\n<h3 id=\"133-promise也是callback\" style=\"position:relative;\"><a href=\"#133-promise%E4%B9%9F%E6%98%AFcallback\" aria-label=\"133 promise也是callback permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.3.3 promise也是callback？</h3>\n<p>稍后我们要介绍的主角Promise，在它的Promise/A+规范中有这么一句表述：\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/43b28/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.075949367088604%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBP/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdVYSB//xAAXEAEBAQEAAAAAAAAAAAAAAAACABQE/9oACAEBAAEFAlzFWM2IX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABkQAAIDAQAAAAAAAAAAAAAAAAACATEykf/aAAgBAQAGPwK54aY0x//EABoQAAICAwAAAAAAAAAAAAAAAAABESEx4fH/2gAIAQEAAT8haS6qwJ9AuEf/2gAMAwEAAgADAAAAEHAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFhEBAQEAAAAAAAAAAAAAAAAAARAh/9oACAECAQE/EAAyf//EAB0QAAICAQUAAAAAAAAAAAAAAAERADEhYXGRwfD/2gAIAQEAAT8QBcMRU8QnEr2TqLV+aT//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/828fb/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg\"\n        srcset=\"/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/ff44c/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg 158w,\n/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/a6688/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg 315w,\n/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/828fb/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg 630w,\n/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/0ede0/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg 945w,\n/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/3ac88/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg 1260w,\n/static/2ccf675b33bf2cc92c0c1ad5855e6ccd/43b28/2CCF675B33BF2CC92C0C1AD5855E6CCD.jpg 1390w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>Promise 表示一个异步操作的最终结果，与之进行交互的方式主要是<code class=\"language-text\">then</code>方法，该方法注册了两个<strong>回调函数</strong>，用于接收 promise 的终值或本 promise 不能执行的原因。</p>\n</blockquote>\n<p>Callback是一个很宽泛的概念，我们可以把promise当作是一个能处理0-1个异步结果的状态管理器：因此，我们可以把callback -> promise的演进看作是一种style到另一种style的过程。\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/92be4e052b27172d4c27830d72cf4954/670dc/92BE4E052B27172D4C27830D72CF4954.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 6.329113924050632%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAABABQDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAG2AD//xAAWEAADAAAAAAAAAAAAAAAAAAABEDH/2gAIAQEAAQUCEX//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAVEAEBAAAAAAAAAAAAAAAAAAAQsf/aAAgBAQABPyGj/9oADAMBAAIAAwAAABDzz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABcQAAMBAAAAAAAAAAAAAAAAAAABEDH/2gAIAQEAAT8Q1Cn/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/92be4e052b27172d4c27830d72cf4954/828fb/92BE4E052B27172D4C27830D72CF4954.jpg\"\n        srcset=\"/static/92be4e052b27172d4c27830d72cf4954/ff44c/92BE4E052B27172D4C27830D72CF4954.jpg 158w,\n/static/92be4e052b27172d4c27830d72cf4954/a6688/92BE4E052B27172D4C27830D72CF4954.jpg 315w,\n/static/92be4e052b27172d4c27830d72cf4954/828fb/92BE4E052B27172D4C27830D72CF4954.jpg 630w,\n/static/92be4e052b27172d4c27830d72cf4954/0ede0/92BE4E052B27172D4C27830D72CF4954.jpg 945w,\n/static/92be4e052b27172d4c27830d72cf4954/3ac88/92BE4E052B27172D4C27830D72CF4954.jpg 1260w,\n/static/92be4e052b27172d4c27830d72cf4954/670dc/92BE4E052B27172D4C27830D72CF4954.jpg 1650w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.10 promise</p>\n<h3 id=\"134-generator也是callback\" style=\"position:relative;\"><a href=\"#134-generator%E4%B9%9F%E6%98%AFcallback\" aria-label=\"134 generator也是callback permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.3.4 generator也是callback？</h3>\n<p>随着进一步演进，在社区中出现了co库将generator与promise结合实现同步写法编写异步代码的解决方案：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e4820d8bb88684defe25b089a237b26e/aefc3/E4820D8BB88684DEFE25B089A237B26E.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.632911392405056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdybAD//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAEFAl//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAXEAEAAwAAAAAAAAAAAAAAAAABABEg/9oACAEBAAE/IVphn//aAAwDAQACAAMAAAAQwA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAEBAQADAAAAAAAAAAAAAAABABEQITH/2gAIAQEAAT8QZckpHndhvBf/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/e4820d8bb88684defe25b089a237b26e/828fb/E4820D8BB88684DEFE25B089A237B26E.jpg\"\n        srcset=\"/static/e4820d8bb88684defe25b089a237b26e/ff44c/E4820D8BB88684DEFE25B089A237B26E.jpg 158w,\n/static/e4820d8bb88684defe25b089a237b26e/a6688/E4820D8BB88684DEFE25B089A237B26E.jpg 315w,\n/static/e4820d8bb88684defe25b089a237b26e/828fb/E4820D8BB88684DEFE25B089A237B26E.jpg 630w,\n/static/e4820d8bb88684defe25b089a237b26e/aefc3/E4820D8BB88684DEFE25B089A237B26E.jpg 926w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.11 co-generator</p>\n<p>你们猜我是不是想说这也是一种callback style？</p>\n<p>没错。。\n我们可以把generator函数理解为：\n它是一个把执行权一步一步交出去的函数：交出去后怎么回来？这就得调用callback函数。\n当然事实没有这么简单，在这个过程中还需要做许多工作，需要恢复上下文执行栈环境等等。</p>\n<p>为了印证这个说法，我们来看一个例子：如何将generator视为多个callback的函数的整合。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d8f18ad68d4e0284446c78f2f6694af8/c222a/D8F18AD68D4E0284446C78F2F6694AF8.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.21518987341771%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAd0FkD//xAAXEAADAQAAAAAAAAAAAAAAAAAAARAh/9oACAEBAAEFAhXZ/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGhAAAgIDAAAAAAAAAAAAAAAAARAAIRExQf/aAAgBAQABPyE0WOeINXP/2gAMAwEAAgADAAAAEADP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhAAAwADAQAAAAAAAAAAAAAAAAERIUGBYf/aAAgBAQABPxBnh2M5mrohbYkOcL9D/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/d8f18ad68d4e0284446c78f2f6694af8/828fb/D8F18AD68D4E0284446C78F2F6694AF8.jpg\"\n        srcset=\"/static/d8f18ad68d4e0284446c78f2f6694af8/ff44c/D8F18AD68D4E0284446C78F2F6694AF8.jpg 158w,\n/static/d8f18ad68d4e0284446c78f2f6694af8/a6688/D8F18AD68D4E0284446C78F2F6694AF8.jpg 315w,\n/static/d8f18ad68d4e0284446c78f2f6694af8/828fb/D8F18AD68D4E0284446C78F2F6694AF8.jpg 630w,\n/static/d8f18ad68d4e0284446c78f2f6694af8/c222a/D8F18AD68D4E0284446C78F2F6694AF8.jpg 794w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.12 genetator的一个例子</p>\n<p>如图1.12所示的代码，我们去掉*和yeild关键字，用朴素函数简化后变成图1.13这个样子。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e07f6e6b1f1da639d5fba7fde9fe3bbc/70aca/E07F6E6B1F1DA639D5FBA7FDE9FE3BBC.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 112.0253164556962%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAWABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe7QoM0KD//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEAAQUCH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CH//EABkQAAMAAwAAAAAAAAAAAAAAAAABERAgIf/aAAgBAQABPyF8FrKTH//aAAwDAQACAAMAAAAQAAgA/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAGhABAQEBAQEBAAAAAAAAAAAAAQARIUFRkf/aAAgBAQABPxDS0eb2AHInHR+wYcidvIJ4fkF//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/e07f6e6b1f1da639d5fba7fde9fe3bbc/828fb/E07F6E6B1F1DA639D5FBA7FDE9FE3BBC.jpg\"\n        srcset=\"/static/e07f6e6b1f1da639d5fba7fde9fe3bbc/ff44c/E07F6E6B1F1DA639D5FBA7FDE9FE3BBC.jpg 158w,\n/static/e07f6e6b1f1da639d5fba7fde9fe3bbc/a6688/E07F6E6B1F1DA639D5FBA7FDE9FE3BBC.jpg 315w,\n/static/e07f6e6b1f1da639d5fba7fde9fe3bbc/828fb/E07F6E6B1F1DA639D5FBA7FDE9FE3BBC.jpg 630w,\n/static/e07f6e6b1f1da639d5fba7fde9fe3bbc/0ede0/E07F6E6B1F1DA639D5FBA7FDE9FE3BBC.jpg 945w,\n/static/e07f6e6b1f1da639d5fba7fde9fe3bbc/70aca/E07F6E6B1F1DA639D5FBA7FDE9FE3BBC.jpg 966w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.13 通过朴素函数转化一个generator</p>\n<p>就这样，我们构造了一个嵌套了 4 层的 callback，然后在 next 函数的 4 次调用中，分别解开一层层的回调，最后清空了 callback 的层次。实现了与前面的 generator function 相似的行为。</p>\n<p>当然，在babel中并不是通过上述方式来实现的，而是利用一个合成函数，通过switch case将它分割成多块，每次只执行其中一个case：\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/493bdf847706c3972b6f8501dbface82/8e1fc/493BDF847706C3972B6F8501DBFACE82.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 120.25316455696202%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAYABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe6UoM0KD//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEAAQUCH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CH//EABgQAAIDAAAAAAAAAAAAAAAAAAEQESAh/9oACAEBAAE/IZ1m3//aAAwDAQACAAMAAAAQQAgA/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHBABAQACAgMAAAAAAAAAAAAAAQAhMUFxUWGR/9oACAEBAAE/EMGQh6jVw7Y1EiuPMHf2L//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/493bdf847706c3972b6f8501dbface82/828fb/493BDF847706C3972B6F8501DBFACE82.jpg\"\n        srcset=\"/static/493bdf847706c3972b6f8501dbface82/ff44c/493BDF847706C3972B6F8501DBFACE82.jpg 158w,\n/static/493bdf847706c3972b6f8501dbface82/a6688/493BDF847706C3972B6F8501DBFACE82.jpg 315w,\n/static/493bdf847706c3972b6f8501dbface82/828fb/493BDF847706C3972B6F8501DBFACE82.jpg 630w,\n/static/493bdf847706c3972b6f8501dbface82/8e1fc/493BDF847706C3972B6F8501DBFACE82.jpg 900w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.14 babel转化generator的解决方案</p>\n<h3 id=\"135-最后演进到asyncawait\" style=\"position:relative;\"><a href=\"#135-%E6%9C%80%E5%90%8E%E6%BC%94%E8%BF%9B%E5%88%B0asyncawait\" aria-label=\"135 最后演进到asyncawait permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.3.5 最后演进到async/await</h3>\n<p>至于generator到async/await的演进，我们可以视为它是promise + generator这个方案的语义化和标准化。</p>\n<p>至此，我们可以将JavaScript里的异步方案演进表述为以下形式<sup><a href=\"https://mp.weixin.qq.com/s/qdJ0Xd8zTgtetFdlJL3P1g\" title=\"100行实现一个Promise/A+\">1</a></sup>：\nRaw Callback Style -> Promise Callback Style -> Generator Callback Style -> Async/Await Callback</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c825e85b437029689f170347582711ed/b204c/C825E85B437029689F170347582711ED.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.30379746835443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe8jS0D/xAAVEAEBAAAAAAAAAAAAAAAAAAAQAf/aAAgBAQABBQJj/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGRAAAgMBAAAAAAAAAAAAAAAAEEEAATGh/9oACAEBAAE/IVnCwqf/2gAMAwEAAgADAAAAEFPP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHRABAAEDBQAAAAAAAAAAAAAAAQARMXEQIUGBkf/aAAgBAQABPxAPSCo7FOtLMpwSxzP/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/c825e85b437029689f170347582711ed/828fb/C825E85B437029689F170347582711ED.jpg\"\n        srcset=\"/static/c825e85b437029689f170347582711ed/ff44c/C825E85B437029689F170347582711ED.jpg 158w,\n/static/c825e85b437029689f170347582711ed/a6688/C825E85B437029689F170347582711ED.jpg 315w,\n/static/c825e85b437029689f170347582711ed/828fb/C825E85B437029689F170347582711ED.jpg 630w,\n/static/c825e85b437029689f170347582711ed/0ede0/C825E85B437029689F170347582711ED.jpg 945w,\n/static/c825e85b437029689f170347582711ed/3ac88/C825E85B437029689F170347582711ED.jpg 1260w,\n/static/c825e85b437029689f170347582711ed/b204c/C825E85B437029689F170347582711ED.jpg 1724w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.15 JavaScript异步方案演进的表述</p>\n<p>新的表述跟旧的表述，总体上是一致的。只是描述口径从 4 个不同事物的演进，变成了同种事物的不同形态的演进。</p>\n<p>语义化和标准化，不意味着能力的增强，它也有可能导致能力的减弱。</p>\n<ol>\n<li>比如generator和async-await对比，generator 既能支持同步行为，也能支持异步行为；而async只支持异步行为。</li>\n<li>再比如并行处理，我们需要在async函数中使用promise.all才能达到目的</li>\n<li>最后callback虽然被人诟病，但是如果有如图1.16的需求，那又该如何实现？</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f876c08cdae85ece52e29b51522f6354/fbd2c/F876C08CDAE85ECE52E29B51522F6354.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.746835443037973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAME/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAd1RQP/EABYQAQEBAAAAAAAAAAAAAAAAAAEQIf/aAAgBAQABBQI1n//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAABD/2gAIAQEABj8Cf//EABkQAAEFAAAAAAAAAAAAAAAAAAABEBEhQf/aAAgBAQABPyFGhFN//9oADAMBAAIAAwAAABDzz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABkQAQADAQEAAAAAAAAAAAAAAAEAEZEh8f/aAAgBAQABPxDsK2AKF6yg9Z//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/f876c08cdae85ece52e29b51522f6354/828fb/F876C08CDAE85ECE52E29B51522F6354.jpg\"\n        srcset=\"/static/f876c08cdae85ece52e29b51522f6354/ff44c/F876C08CDAE85ECE52E29B51522F6354.jpg 158w,\n/static/f876c08cdae85ece52e29b51522f6354/a6688/F876C08CDAE85ECE52E29B51522F6354.jpg 315w,\n/static/f876c08cdae85ece52e29b51522f6354/828fb/F876C08CDAE85ECE52E29B51522F6354.jpg 630w,\n/static/f876c08cdae85ece52e29b51522f6354/0ede0/F876C08CDAE85ECE52E29B51522F6354.jpg 945w,\n/static/f876c08cdae85ece52e29b51522f6354/fbd2c/F876C08CDAE85ECE52E29B51522F6354.jpg 1180w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.16 控制并发数的异步请求控制</p>\n<p>所以说，如果我们愿意手动管理callback，理论上最原始的callback的表达能力是最强的；\n这也很符合这个世界的规律：<strong>等价交换</strong>；</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bea4bb425d88316b7b34d7d775bab835/f4946/BEA4BB425D88316B7B34D7D775BAB835.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.91139240506328%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAARABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe8AoxsKD//EABYQAQEBAAAAAAAAAAAAAAAAABABQv/aAAgBAQABBQIhDR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAUEAEAAAAAAAAAAAAAAAAAAAAw/9oACAEBAAY/Ah//xAAcEAADAAIDAQAAAAAAAAAAAAAAAREhMRBBgZH/2gAIAQEAAT8hitgsrYkXZcnr4IevP//aAAwDAQACAAMAAAAQcw8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHRAAAgEEAwAAAAAAAAAAAAAAAREAECExQWFxof/aAAgBAQABPxBSgdy4eQDyApsCvsuEAruoRLZLtJhPHX//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/bea4bb425d88316b7b34d7d775bab835/828fb/BEA4BB425D88316B7B34D7D775BAB835.jpg\"\n        srcset=\"/static/bea4bb425d88316b7b34d7d775bab835/ff44c/BEA4BB425D88316B7B34D7D775BAB835.jpg 158w,\n/static/bea4bb425d88316b7b34d7d775bab835/a6688/BEA4BB425D88316B7B34D7D775BAB835.jpg 315w,\n/static/bea4bb425d88316b7b34d7d775bab835/828fb/BEA4BB425D88316B7B34D7D775BAB835.jpg 630w,\n/static/bea4bb425d88316b7b34d7d775bab835/0ede0/BEA4BB425D88316B7B34D7D775BAB835.jpg 945w,\n/static/bea4bb425d88316b7b34d7d775bab835/3ac88/BEA4BB425D88316B7B34D7D775BAB835.jpg 1260w,\n/static/bea4bb425d88316b7b34d7d775bab835/f4946/BEA4BB425D88316B7B34D7D775BAB835.jpg 1274w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图1.17 有失有得的异步方案演进\n从上往下，我们编写代码的方式越来越方便，更易维护；为此付出的代价就是能力削弱，编译器需要识别更多关键字；</p>\n<p>初步介绍完js的异步发展过程，我们就开始介绍今日的主角promise：</p>\n<h1 id=\"2-promise\" style=\"position:relative;\"><a href=\"#2-promise\" aria-label=\"2 promise permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2 Promise</h1>\n<h2 id=\"21-概览\" style=\"position:relative;\"><a href=\"#21-%E6%A6%82%E8%A7%88\" aria-label=\"21 概览 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 概览</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3f024598c245c50fd8c920c0f8abc486/8284a/3F024598C245C50FD8C920C0F8ABC486.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.68354430379747%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAFABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAEDBP/EABUBAQEAAAAAAAAAAAAAAAAAAAAC/9oADAMBAAIQAxAAAAHfeSkH/8QAFxABAQEBAAAAAAAAAAAAAAAAAQMCEv/aAAgBAQABBQJ1TqqhJXP/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAXEQEBAQEAAAAAAAAAAAAAAAABACEx/9oACAECAQE/AXkGX//EABgQAQEAAwAAAAAAAAAAAAAAACEAAlFx/9oACAEBAAY/AjM5G5v/xAAYEAEAAwEAAAAAAAAAAAAAAAARAAExIf/aAAgBAQABPyHDaWTXUIncksn/2gAMAwEAAgADAAAAEAQf/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAEx/9oACAEDAQE/EJqv/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oACAECAQE/ECOIgF//xAAbEAEBAAIDAQAAAAAAAAAAAAABIQARQVFhkf/aAAgBAQABPxBrghJ57wQFUGxD7i6xdrSe5//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/3f024598c245c50fd8c920c0f8abc486/828fb/3F024598C245C50FD8C920C0F8ABC486.jpg\"\n        srcset=\"/static/3f024598c245c50fd8c920c0f8abc486/ff44c/3F024598C245C50FD8C920C0F8ABC486.jpg 158w,\n/static/3f024598c245c50fd8c920c0f8abc486/a6688/3F024598C245C50FD8C920C0F8ABC486.jpg 315w,\n/static/3f024598c245c50fd8c920c0f8abc486/828fb/3F024598C245C50FD8C920C0F8ABC486.jpg 630w,\n/static/3f024598c245c50fd8c920c0f8abc486/0ede0/3F024598C245C50FD8C920C0F8ABC486.jpg 945w,\n/static/3f024598c245c50fd8c920c0f8abc486/3ac88/3F024598C245C50FD8C920C0F8ABC486.jpg 1260w,\n/static/3f024598c245c50fd8c920c0f8abc486/8284a/3F024598C245C50FD8C920C0F8ABC486.jpg 1666w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图2.1 不同的Promise</p>\n<p>通过之前的描述，我们明白promise的出现那一定是迟早的事，并且promise还有很多兄弟姐妹；\n有兴趣的同学可以去看看《聊一聊promise的前世今生》这篇文章<sup><a href=\"https://www.cnblogs.com/tarol/p/9042407.html\" title=\"聊一聊promise的前世今生\">2</a></sup>。</p>\n<p>如今我们使用的promise更多是在Promies/A+ 基础上增强的Promise ES6标准。</p>\n<p>今天的另一个问题就是:</p>\n<h3 id=\"211-图21中俩者的promise有啥区别\" style=\"position:relative;\"><a href=\"#211-%E5%9B%BE21%E4%B8%AD%E4%BF%A9%E8%80%85%E7%9A%84promise%E6%9C%89%E5%95%A5%E5%8C%BA%E5%88%AB\" aria-label=\"211 图21中俩者的promise有啥区别 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1.1 图2.1中俩者的promise有啥区别？</h3>\n<details>\n  <summary style=\"font-size: 16px; font-weight: 700\">\n    请思考后展开答案\n  </summary>\n  他们的区别是：ES6中的Promise增加了 `.catch` 方法，增加了 `Promsie.resolve`、`Promise.reject`、 `Promise.all`、`Promise.race`等静态方法\n</details> \n<p>作为现代JavaScript中的一部分，理解和掌握Promise对前端开发者异常重要。它几乎成为面试中必问的问题之一，甚至还有一些付费教程教学如何实现一个Promise。</p>\n<p>依我之见，互联网上资料丰富，但是也是鱼龙混杂：我们可以通过搜索引擎搜到与关键字相关的NNNN条信息，但是不一定能找到自己想要的信息。可能是我们搜索的关键字、可能是信息太多无法筛选、可能是因为坦克原因不可见、也可能是作者表述与读者理解力的不对等。</p>\n<p>我将尽量以一种能看懂的方式实现Promise/A+规范。</p>\n<p>不过，正如我所参考的这个实现作者所说的<sup><a href=\"https://mp.weixin.qq.com/s/qdJ0Xd8zTgtetFdlJL3P1g\" title=\"100行实现一个Promise/A+\">1</a></sup>：</p>\n<blockquote>\n<p>不过，如果一个初学者，想通过实现 Promises/A+ 去学习 Promises。或者认为实现了 Promises/A+规范后，对 Promises 的理解水平能得到质的提升。最后可能会失望。</p>\n</blockquote>\n<blockquote>\n<p>实际上，Promises/A+ 规范，内容简短，实现难度低。其中充斥着细节行为的描述，缺乏设计目的和背景的部分，完全没有介绍使用场景。并不是一个入门 Promises 的好材料。</p>\n</blockquote>\n<blockquote>\n<p>即便成功实现 Promises/A+ 规范，也不一定比没实现过的开发者，更善于使用 Promises 特性。</p>\n</blockquote>\n<p>如果想更好地使用Promise，我会推荐你去看promise迷你书<sup><a href=\"http://liubin.org/promises-book/\" title=\"promise迷你书\">3</a></sup></p>\n<h2 id=\"22-实现一个-promisea-规范\" style=\"position:relative;\"><a href=\"#22-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA-promisea-%E8%A7%84%E8%8C%83\" aria-label=\"22 实现一个 promisea 规范 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 实现一个 Promise/A+ 规范</h2>\n<p>我们会使用Promise/A+作者提供的测试套件来测试我们实现的Promise是否符合规范。</p>\n<p>现在跟着我一起左手🐲右手🌈</p>\n<h3 id=\"221-前期工作\" style=\"position:relative;\"><a href=\"#221-%E5%89%8D%E6%9C%9F%E5%B7%A5%E4%BD%9C\" aria-label=\"221 前期工作 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2.1 前期工作</h3>\n<p>英文规范： <a href=\"https://promisesaplus.com/\">https://promisesaplus.com/</a>\n中文规范： <a href=\"https://www.ituring.com.cn/article/66566\">https://www.ituring.com.cn/article/66566</a>\n测试套件： promises-aplus-tests</p>\n<p>git repo: <a href=\"https://github.com/hemisu/promise-aplus-impl\">https://github.com/hemisu/promise-aplus-impl</a></p>\n<p>左侧打开promise规范网页，右侧编写代码撒。\n创建一个目录，再命令行执行：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone https://github.com/hemisu/promise-aplus-impl\n<span class=\"token builtin class-name\">cd</span> promise-aplus-impl <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">npm</span> <span class=\"token function\">install</span>\n<span class=\"token function\">npm</span> run <span class=\"token builtin class-name\">test</span></code></pre></div>\n<p>这样你就可以看到自带的promise的测试结果啦：D</p>\n<h3 id=\"222-开始实现\" style=\"position:relative;\"><a href=\"#222-%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0\" aria-label=\"222 开始实现 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2.2 开始实现</h3>\n<p>首先取消掉<code class=\"language-text\">src/index.js</code>中第一行注释，引入我们自己编写的promise</p>\n<p>在<code class=\"language-text\">src/promies.js</code>中已经准备好了后面需要使用的一部分类型检测代码。\n接着我们就开始对照着Promise/A+规范开始编码（推荐使用英文原版，有标注规范条目，不理解的地方再对照图灵中文翻译）。</p>\n<h3 id=\"223-术语---1terminology\" style=\"position:relative;\"><a href=\"#223-%E6%9C%AF%E8%AF%AD---1terminology\" aria-label=\"223 术语   1terminology permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2.3 术语 - 1.terminology</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2f15c716ce0a3405cfbbfda2f1ef7e14/4b7fe/2F15C716CE0A3405CFBBFDA2F1EF7E14.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.202531645569614%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHYkkWAH//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABkQAAIDAQAAAAAAAAAAAAAAAAEQABEh4f/aAAgBAQABPyEjey0X/9oADAMBAAIAAwAAABAQz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EAB4QAQACAQQDAAAAAAAAAAAAAAEAEVEQITFBcdHh/9oACAEBAAE/EAunTl7l6+kFrcZyfMxp/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/2f15c716ce0a3405cfbbfda2f1ef7e14/828fb/2F15C716CE0A3405CFBBFDA2F1EF7E14.jpg\"\n        srcset=\"/static/2f15c716ce0a3405cfbbfda2f1ef7e14/ff44c/2F15C716CE0A3405CFBBFDA2F1EF7E14.jpg 158w,\n/static/2f15c716ce0a3405cfbbfda2f1ef7e14/a6688/2F15C716CE0A3405CFBBFDA2F1EF7E14.jpg 315w,\n/static/2f15c716ce0a3405cfbbfda2f1ef7e14/828fb/2F15C716CE0A3405CFBBFDA2F1EF7E14.jpg 630w,\n/static/2f15c716ce0a3405cfbbfda2f1ef7e14/0ede0/2F15C716CE0A3405CFBBFDA2F1EF7E14.jpg 945w,\n/static/2f15c716ce0a3405cfbbfda2f1ef7e14/4b7fe/2F15C716CE0A3405CFBBFDA2F1EF7E14.jpg 1220w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图2.1 Terminology</p>\n<p>规范的第一部分描述了几个术语，它们分别如下：</p>\n<ul>\n<li><code class=\"language-text\">promise</code> 是一个包含 <code class=\"language-text\">then</code> 方法的对象或者函数</li>\n<li><code class=\"language-text\">thenable</code> 是一个包含 <code class=\"language-text\">then</code> 方法的对象或者函数</li>\n<li><code class=\"language-text\">value</code> 是一个合法JS值，可以是一个 <code class=\"language-text\">undefined</code> <code class=\"language-text\">thenable</code> <code class=\"language-text\">promose</code></li>\n</ul>\n<p>这里解释一下，value是一个promise内部保持的值，它决议（resolve）成功时我们可以称它为result，而它失败(reject)时我们可以称它为reason。</p>\n<p>对应这一节的规范，我们可以编写对应的代码（部分已内置）：\n这里的 <code class=\"language-text\">thenable</code> 涉及到鸭子类型(Duck Typing)。鸭子类型可解释为,如果一只动物,走起来像鸭子或者叫起来像鸭子,就可以把它当作鸭子。同理，一个对象或者函数如果有 <code class=\"language-text\">then</code> 方法，我们就可以称它为 <code class=\"language-text\">thenable</code></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// utils</span>\n<span class=\"token comment\">// ...</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isThenable</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">obj</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token function\">isObject</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token function\">isFunction</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token string\">'then'</span> <span class=\"token keyword\">in</span> obj\n<span class=\"token comment\">// ...</span>\n\n<span class=\"token comment\">// begin here</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">Promise</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">then</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// </span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这一部分没有多少代码需要添加，我们只需要在构造函数中加入一行<code class=\"language-text\">value</code>的内置值就行；另外在原型上挂载一个 <code class=\"language-text\">then</code> 方法</p>\n<h3 id=\"224-promise的状态---21-promise-states\" style=\"position:relative;\"><a href=\"#224-promise%E7%9A%84%E7%8A%B6%E6%80%81---21-promise-states\" aria-label=\"224 promise的状态   21 promise states permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2.4 promise的状态 - 2.1 Promise States</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/abfb1dbd9bb5dbaf203d0a18339370c5/a8586/ABFB1DBD9BB5DBAF203D0A18339370C5.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.35443037974683%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAevpFFA//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGxAAAgIDAQAAAAAAAAAAAAAAAREAECExUZH/2gAIAQEAAT8hQeh5GaGYAuV//9oADAMBAAIAAwAAABAzD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABwQAQABBAMAAAAAAAAAAAAAAAEAESExURCBkf/aAAgBAQABPxAM3L6QTFPOBWo43Gqt0gup/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/abfb1dbd9bb5dbaf203d0a18339370c5/828fb/ABFB1DBD9BB5DBAF203D0A18339370C5.jpg\"\n        srcset=\"/static/abfb1dbd9bb5dbaf203d0a18339370c5/ff44c/ABFB1DBD9BB5DBAF203D0A18339370C5.jpg 158w,\n/static/abfb1dbd9bb5dbaf203d0a18339370c5/a6688/ABFB1DBD9BB5DBAF203D0A18339370C5.jpg 315w,\n/static/abfb1dbd9bb5dbaf203d0a18339370c5/828fb/ABFB1DBD9BB5DBAF203D0A18339370C5.jpg 630w,\n/static/abfb1dbd9bb5dbaf203d0a18339370c5/0ede0/ABFB1DBD9BB5DBAF203D0A18339370C5.jpg 945w,\n/static/abfb1dbd9bb5dbaf203d0a18339370c5/a8586/ABFB1DBD9BB5DBAF203D0A18339370C5.jpg 1224w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图2.2 Promise States</p>\n<p>这里的规范说明promise有<code class=\"language-text\">PENDING</code>、<code class=\"language-text\">FULFILLED</code>、<code class=\"language-text\">REJECT</code>三种状态；\n那么我们先加入这几个常量，在构造函数中声明这个值：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">PENDING</span> <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">FULFILLED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'fulfilled'</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">REJECTED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'rejected'</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">f</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>然后从2.1.1 和 2.1.2.* 可以知道第一种可以转变为后面两种，后面两种不可再次 <code class=\"language-text\">transition</code>，我们就再加入一条transition函数让这个函数进行状态变化，并且保存状态变化后的值 <code class=\"language-text\">value</code>。就如之前提到的，如果<code class=\"language-text\">state</code>为<code class=\"language-text\">fulfilled</code>时，<code class=\"language-text\">result</code>就被看作<code class=\"language-text\">value</code>，如果<code class=\"language-text\">state</code>被<code class=\"language-text\">rejected</code>时，<code class=\"language-text\">result</code>就被看作<code class=\"language-text\">reason</code>。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">transition</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">promise<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>promise<span class=\"token punctuation\">.</span>state <span class=\"token operator\">!==</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n  promise<span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> state\n  promise<span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> result\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>此外规范中补充，这里的<code class=\"language-text\">must not change</code>不意味着不可变对象，而仅仅是内存指向不变。（即这个value值如果是个对象，修改一下对象里的属性并不会破坏这条规则）</p>\n<h3 id=\"225-then-方法---22-the-then-method\" style=\"position:relative;\"><a href=\"#225-then-%E6%96%B9%E6%B3%95---22-the-then-method\" aria-label=\"225 then 方法   22 the then method permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2.5 then 方法 - 2.2 The then Method</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fccede45412b545c613a24ad01f12664/4b7fe/FCCEDE45412B545C613A24AD01F12664.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.949367088607595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAFABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAduQsD//xAAWEAEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQEAAQUCSMf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAWEAEBAQAAAAAAAAAAAAAAAAARABD/2gAIAQEAAT8hJMf/2gAMAwEAAgADAAAAEHAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAAICAwAAAAAAAAAAAAAAAQARITGRscH/2gAIAQEAAT8QCY8gi2uIE11P/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/fccede45412b545c613a24ad01f12664/828fb/FCCEDE45412B545C613A24AD01F12664.jpg\"\n        srcset=\"/static/fccede45412b545c613a24ad01f12664/ff44c/FCCEDE45412B545C613A24AD01F12664.jpg 158w,\n/static/fccede45412b545c613a24ad01f12664/a6688/FCCEDE45412B545C613A24AD01F12664.jpg 315w,\n/static/fccede45412b545c613a24ad01f12664/828fb/FCCEDE45412B545C613A24AD01F12664.jpg 630w,\n/static/fccede45412b545c613a24ad01f12664/0ede0/FCCEDE45412B545C613A24AD01F12664.jpg 945w,\n/static/fccede45412b545c613a24ad01f12664/4b7fe/FCCEDE45412B545C613A24AD01F12664.jpg 1220w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图2.3 then大致描述\nthen方法的描述就比较地长了，我们逐一来看：\n首先规范说要有一个这样的方法，它接收俩参数。既然它这么大方地给了我们就直接复制到之前的代码中吧:D</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token class-name\">Promise</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">then</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后规范的2.2.1 ～ 2.2.3说明了一下这2个参数如果是函数会怎么样、不是函数又会怎么样，我们先略过不看，需要用到的时候我们再提。</p>\n<p>2.2.4中提及，这俩参数如果被<code class=\"language-text\">called</code>。哦那他们首先就是函数了。它们必须等到执行上下文只含平台代码的时候才能被执行。这里是什么意思呢？我们看到它有一个备注<code class=\"language-text\">3.1</code>，我们看看图2.4。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3c8d9ef3c70c59b930ad8423aa2d0eba/1982c/3C8D9EF3C70C59B930AD8423AA2D0EBA.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.075949367088604%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAEDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdeAtB//xAAWEAEBAQAAAAAAAAAAAAAAAAAAAUH/2gAIAQEAAQUC1H//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAYEAACAwAAAAAAAAAAAAAAAAAAEQEhMf/aAAgBAQABPyGUxRg//9oADAMBAAIAAwAAABDwD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABwQAQACAQUAAAAAAAAAAAAAAAEAIRExUWFxof/aAAgBAQABPxBjQp2nbyWKOTmf/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/3c8d9ef3c70c59b930ad8423aa2d0eba/828fb/3C8D9EF3C70C59B930AD8423AA2D0EBA.jpg\"\n        srcset=\"/static/3c8d9ef3c70c59b930ad8423aa2d0eba/ff44c/3C8D9EF3C70C59B930AD8423AA2D0EBA.jpg 158w,\n/static/3c8d9ef3c70c59b930ad8423aa2d0eba/a6688/3C8D9EF3C70C59B930AD8423AA2D0EBA.jpg 315w,\n/static/3c8d9ef3c70c59b930ad8423aa2d0eba/828fb/3C8D9EF3C70C59B930AD8423AA2D0EBA.jpg 630w,\n/static/3c8d9ef3c70c59b930ad8423aa2d0eba/0ede0/3C8D9EF3C70C59B930AD8423AA2D0EBA.jpg 945w,\n/static/3c8d9ef3c70c59b930ad8423aa2d0eba/1982c/3C8D9EF3C70C59B930AD8423AA2D0EBA.jpg 1176w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图2.4 备注3.1</p>\n<p>再补充一份翻译好的规范</p>\n<blockquote>\n<p>这里的平台代码指的是引擎、环境以及 promise 的实施代码。实践中要确保 onFulfilled 和 onRejected 方法异步执行，且应该在 then 方法被调用的那一轮事件循环之后的新执行栈中执行。这个事件队列可以采用“宏任务（macro-task）”机制或者“微任务（micro-task）”机制来实现。由于 promise 的实施代码本身就是平台代码（译者注：即都是 JavaScript），故代码自身在处理在处理程序时可能已经包含一个任务调度队列。</p>\n</blockquote>\n<p>大体意思呢就是这个then方法里的俩兄弟需要等下一个事件队列（macro task/micro task）才能执行。那我们先随便上一个：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token class-name\">Promise</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">then</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 2.2.5 别问，先放着</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>规范2.2.6说then方法可能会被同一个promise多次调用，如果被调用的话需要按照注册的时候的顺序依次调用。</p>\n<p>这下我们知道，他们应该放在一个队列中；其次，它们是不是像我们第一节说的回调一样？一个一个被注册到队列中等到需要的时候再拿出来？</p>\n<p>于是我们先去构造函数中注册一个队列保存这些注册的<code class=\"language-text\">then</code>回调。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">f</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 2.2.6</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>callbacks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>最后来到2.2.7，先看规范：\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8fb32ef8c0da6b0b82e68f63f1b0844b/ff688/8FB32EF8C0DA6B0B82E68F63F1B0844B.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.10126582278481%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHZHEsEH//EABcQAAMBAAAAAAAAAAAAAAAAAAABEBH/2gAIAQEAAQUCNjv/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAYEAEBAAMAAAAAAAAAAAAAAAABABARMf/aAAgBAQABPyFtocjl/9oADAMBAAIAAwAAABDDz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABsQAQEBAAIDAAAAAAAAAAAAAAERACExQXGR/9oACAEBAAE/EEi8E9YkSZEsPmJeseN1b//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/8fb32ef8c0da6b0b82e68f63f1b0844b/828fb/8FB32EF8C0DA6B0B82E68F63F1B0844B.jpg\"\n        srcset=\"/static/8fb32ef8c0da6b0b82e68f63f1b0844b/ff44c/8FB32EF8C0DA6B0B82E68F63F1B0844B.jpg 158w,\n/static/8fb32ef8c0da6b0b82e68f63f1b0844b/a6688/8FB32EF8C0DA6B0B82E68F63F1B0844B.jpg 315w,\n/static/8fb32ef8c0da6b0b82e68f63f1b0844b/828fb/8FB32EF8C0DA6B0B82E68F63F1B0844B.jpg 630w,\n/static/8fb32ef8c0da6b0b82e68f63f1b0844b/0ede0/8FB32EF8C0DA6B0B82E68F63F1B0844B.jpg 945w,\n/static/8fb32ef8c0da6b0b82e68f63f1b0844b/ff688/8FB32EF8C0DA6B0B82E68F63F1B0844B.jpg 1226w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图2.5 then方法 条目2.2.7</p>\n<p>这里说道：<code class=\"language-text\">then</code>方法必须返回一个promise，称它为promies2，之前的promise就称它promise1。其实这里的promise1、promise2不是同一个promise对象了，在之后我们会提到关于这个的反模式写法。我们先加入这一条：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token class-name\">Promise</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">then</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// promise2 2.2.7</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// 2.2.5 别问，先放着</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后我们发现，2.2.7下面提及的东西都是在执行、返回结果甚至已经要回家过年了#滑稽#（在决议promise1的结果了），我一看这哪行，<code class=\"language-text\">PENDING</code> 状态要做什么都还没干呢。</p>\n<p>这时我们前面提及的，我们要把<code class=\"language-text\">then</code>以回调的形式注册到队列中（2.2.6）就需要在这里重拳出击，保存目前所给的所有东西（方便恢复案发现场），排队进入队列。同时，这么多逻辑我们也不能都在一个地方写，为了好看一些，我们抽一个方法<code class=\"language-text\">handleCallback</code>来进行剩余的操作。</p>\n<p>为了减少篇幅（文字工作者不利的地方），这里我就把后面要用到的状态(state)和结果(value)都放函数里了。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token class-name\">Promise</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">then</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// promise2 2.2.7</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> callback <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> onFulfilled<span class=\"token punctuation\">,</span> onRejected<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 2.2.6</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>callbacks<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 2.2.4</span>\n      <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> \n        <span class=\"token function\">handleCallback</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">handleCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 接下来要大干一场的地方</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后我们来处理这个<code class=\"language-text\">handleCallback</code>方法：\n首先，进了这个方法的promies状态不是笑（fulfilled）就是哭（rejected），我们要对这个进行一个判断。\n另外，扔进来的callback包我们也拆一下方便下一步工作。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">handleCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">{</span> onFulfilled<span class=\"token punctuation\">,</span> onRejected<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> callback\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    \n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// REJECTED</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>接着我们就要用到前面提及但是未用的2.2.1～2.2.3条款并结合2.2.7\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/223edf02df00fb49ec748e72bf34dda6/deb44/223EDF02DF00FB49EC748E72BF34DDA6.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.9620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAexZTYP/xAAWEAEBAQAAAAAAAAAAAAAAAAABEAD/2gAIAQEAAQUCrif/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAZEAADAAMAAAAAAAAAAAAAAAAAARARITH/2gAIAQEAAT8hZhTo2n//2gAMAwEAAgADAAAAEPDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhAAAwADAQAAAAAAAAAAAAAAAAERITGRcf/aAAgBAQABPxB43JwTpjovUbh3s7CH/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/223edf02df00fb49ec748e72bf34dda6/828fb/223EDF02DF00FB49EC748E72BF34DDA6.jpg\"\n        srcset=\"/static/223edf02df00fb49ec748e72bf34dda6/ff44c/223EDF02DF00FB49EC748E72BF34DDA6.jpg 158w,\n/static/223edf02df00fb49ec748e72bf34dda6/a6688/223EDF02DF00FB49EC748E72BF34DDA6.jpg 315w,\n/static/223edf02df00fb49ec748e72bf34dda6/828fb/223EDF02DF00FB49EC748E72BF34DDA6.jpg 630w,\n/static/223edf02df00fb49ec748e72bf34dda6/0ede0/223EDF02DF00FB49EC748E72BF34DDA6.jpg 945w,\n/static/223edf02df00fb49ec748e72bf34dda6/deb44/223EDF02DF00FB49EC748E72BF34DDA6.jpg 1212w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图2.6 then方法 2.2.1～2.2.3条款</p>\n<p>2.2.7.1 如果我们执行 <code class=\"language-text\">onFulfilled</code> 和 <code class=\"language-text\">onRejected</code> 返回的值（这里称为x），它就使用promise的决议过程处理<code class=\"language-text\">[[Resolve]](promise2, x)</code>这个值。那么首先这俩兄弟它得是个function才能返回结果x。我们这里就进行一个判断，然后决议它。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">handleCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">{</span> onFulfilled<span class=\"token punctuation\">,</span> onRejected<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> callback\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 进行判断</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isFunction</span><span class=\"token punctuation\">(</span>onFulfilled<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// 决议它</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 进行判断</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isFunction</span><span class=\"token punctuation\">(</span>onRejected<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// 决议它</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后看到2.2.7.2 如果执行报错，我们要保护它，扔出一个错误作为promise2决议失败的理由。并且，2.2.7.3-4提出，如果俩兄弟不是函数的时候，跟着promise1的情况决议值</p>\n<p>经过文字工作者的简单处理，代码就变成了这亚子：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">handleCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">{</span> onFulfilled<span class=\"token punctuation\">,</span> onRejected<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> callback\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">isFunction</span><span class=\"token punctuation\">(</span>onFulfilled<span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">?</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// 2.2.7.3</span>\n      <span class=\"token operator\">:</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">isFunction</span><span class=\"token punctuation\">(</span>onRejected<span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">?</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// 2.2.7.4</span>\n      <span class=\"token operator\">:</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 2.2.7.2</span>\n    <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>至此我们的代码应该是这样的:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isFunction</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">obj</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">typeof</span> obj <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span>\n<span class=\"token keyword\">const</span> toString <span class=\"token operator\">=</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>toString\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isObject</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">obj</span> <span class=\"token operator\">=></span> <span class=\"token function\">toString</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token string\">'[object Object]'</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isThenable</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">obj</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token function\">isObject</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token function\">isFunction</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token string\">'then'</span> <span class=\"token keyword\">in</span> obj\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isPromise</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">promise</span> <span class=\"token operator\">=></span> promise <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Promise</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PENDING</span> <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">FULFILLED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'fulfilled'</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">REJECTED</span> <span class=\"token operator\">=</span> <span class=\"token string\">'rejected'</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">f</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>callbacks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">transition</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">promise<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>promise<span class=\"token punctuation\">.</span>state <span class=\"token operator\">!==</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n  promise<span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> state\n  promise<span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> result\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">Promise</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">then</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">onFulfilled<span class=\"token punctuation\">,</span> onRejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">// promise2</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> callback <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> onFulfilled<span class=\"token punctuation\">,</span> onRejected<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>callbacks<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> \n        <span class=\"token function\">handleCallback</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> \n\n<span class=\"token keyword\">function</span> <span class=\"token function\">handleCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">{</span> onFulfilled<span class=\"token punctuation\">,</span> onRejected<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> callback\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state <span class=\"token operator\">===</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">isFunction</span><span class=\"token punctuation\">(</span>onFulfilled<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">isFunction</span><span class=\"token punctuation\">(</span>onRejected<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>至此我们已经完成了66.66%的工作，因为总共就3条目：D</p>\n<h3 id=\"226-then-方法---23-the-promise-resolution-procedure\" style=\"position:relative;\"><a href=\"#226-then-%E6%96%B9%E6%B3%95---23-the-promise-resolution-procedure\" aria-label=\"226 then 方法   23 the promise resolution procedure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2.6 then 方法 - 2.3 The Promise Resolution Procedure</h3>\n<p>对于大段的英文，我还是先放中文翻译吧：D</p>\n<blockquote>\n<p>Promise 解决过程是一个抽象的操作，其需输入一个 promise 和一个值，我们表示为 [[Resolve]](promise, x)，如果 x 有 then 方法且看上去像一个 Promise ，解决程序即尝试使 promise 接受 x 的状态；否则其用 x 的值来执行 promise 。</p>\n</blockquote>\n<blockquote>\n<p>这种 thenable 的特性使得 Promise 的实现更具有通用性：只要其暴露出一个遵循 Promise/A+ 协议的 then 方法即可；这同时也使遵循 Promise/A+ 规范的实现可以与那些不太规范但可用的实现能良好共存。</p>\n</blockquote>\n<p>直接看中文的好处是我们更熟悉它（大雾\n需要抠细节的时候再读原文不失为一种折衷的做法。\n对于这第三部分规范，它大题的意思就是我们promise可以resolve不同类型的值，对于不同的值我们要做不同的处理。</p>\n<p>首先它说明了这个方法带着promise和一个参数x。并且2.3.1做了一个基本的判断。话不多说我们开干：\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c7c592fbb53e9c43f6fe6032772807d9/00d7d/C7C592FBB53E9C43F6FE6032772807D9.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.822784810126581%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAADABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdmwSD//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAEFAn//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAXEAADAQAAAAAAAAAAAAAAAAAAARAR/9oACAEBAAE/IWZP/9oADAMBAAIAAwAAABAAD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABgQAAMBAQAAAAAAAAAAAAAAAAABMREh/9oACAEBAAE/EHycEmwUP//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/c7c592fbb53e9c43f6fe6032772807d9/828fb/C7C592FBB53E9C43F6FE6032772807D9.jpg\"\n        srcset=\"/static/c7c592fbb53e9c43f6fe6032772807d9/ff44c/C7C592FBB53E9C43F6FE6032772807D9.jpg 158w,\n/static/c7c592fbb53e9c43f6fe6032772807d9/a6688/C7C592FBB53E9C43F6FE6032772807D9.jpg 315w,\n/static/c7c592fbb53e9c43f6fe6032772807d9/828fb/C7C592FBB53E9C43F6FE6032772807D9.jpg 630w,\n/static/c7c592fbb53e9c43f6fe6032772807d9/0ede0/C7C592FBB53E9C43F6FE6032772807D9.jpg 945w,\n/static/c7c592fbb53e9c43f6fe6032772807d9/00d7d/C7C592FBB53E9C43F6FE6032772807D9.jpg 1218w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图2.7 决议过程1</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">promise<span class=\"token punctuation\">,</span> x</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>promise <span class=\"token operator\">===</span> x<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2.3.1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>2.3.2：如果x是个promise，那就沿用x的状态，让promise跟着x的状态走。\n这里就类似继承一般，我们只需要在x上注册一个then，把promise的决议方法放进去即可完成要求。\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/03da27a461c8807c32a589d19c1193e9/62f39/03DA27A461C8807C32A589D19C1193E9.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.78481012658228%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAFABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB2KFB/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAEhEf/aAAgBAQABPyE2CqP/2gAMAwEAAgADAAAAEIPP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAAMAAwEAAAAAAAAAAAAAAQARITFBcYH/2gAIAQEAAT8QXVozqYsFfWc5u/Wf/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/03da27a461c8807c32a589d19c1193e9/828fb/03DA27A461C8807C32A589D19C1193E9.jpg\"\n        srcset=\"/static/03da27a461c8807c32a589d19c1193e9/ff44c/03DA27A461C8807C32A589D19C1193E9.jpg 158w,\n/static/03da27a461c8807c32a589d19c1193e9/a6688/03DA27A461C8807C32A589D19C1193E9.jpg 315w,\n/static/03da27a461c8807c32a589d19c1193e9/828fb/03DA27A461C8807C32A589D19C1193E9.jpg 630w,\n/static/03da27a461c8807c32a589d19c1193e9/0ede0/03DA27A461C8807C32A589D19C1193E9.jpg 945w,\n/static/03da27a461c8807c32a589d19c1193e9/62f39/03DA27A461C8807C32A589D19C1193E9.jpg 1202w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图2.8 决议过程2</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">promise<span class=\"token punctuation\">,</span> x</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>promise <span class=\"token operator\">===</span> x<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2.3.1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">isPromise</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> x<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>来到2.3.3，发现这一条特别长。一条一条解读：\n如果我们发现x是一个<code class=\"language-text\">thenable</code>对象或者函数\n1: 设一个变量 <code class=\"language-text\">then</code> 指向 x.then\n2: 如果取 <code class=\"language-text\">x</code> 的 <code class=\"language-text\">then</code> 属性失败了，捕捉错误 <code class=\"language-text\">e</code> 并决议作为 <code class=\"language-text\">reason</code> 决议 promise 失败\n3: 如果 <code class=\"language-text\">then</code> 是一个 <code class=\"language-text\">function</code> 就使它的this指向为x，接收俩个参数分别称为 <code class=\"language-text\">resolvePromise</code> 和 <code class=\"language-text\">rejectPromise</code></p>\n<p>考虑一下，什么方法可以控制一个函数被调用时的 <code class=\"language-text\">this</code> 指向并且返回的还是函数。</p>\n<p>2.3.3.3.1 和 2.3.3.3.2 这两条与 2.3.2.2 和 2.3.2.3 有些类似，我们只需要注册一个 <code class=\"language-text\">then</code> 方法，将promise的控制权注册进去即可。</p>\n<p>剩余的2.3.3.3 ～ 2.3.3.4 先保留，我们之后来讲。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6ec23faafdf54cafd9aa7d9a20620637/09fd1/6EC23FAAFDF54CAFD9AA7D9A20620637.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.21518987341771%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAey2Swf/xAAVEAEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAQABBQJrf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABgQAAMBAQAAAAAAAAAAAAAAAAABERAh/9oACAEBAAE/IU6K6RD/2gAMAwEAAgADAAAAENMP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhAAAwEBAQEAAAAAAAAAAAAAAAERIYExcf/aAAgBAQABPxCGMoyCs0l8ETmv4JJ411n/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/6ec23faafdf54cafd9aa7d9a20620637/828fb/6EC23FAAFDF54CAFD9AA7D9A20620637.jpg\"\n        srcset=\"/static/6ec23faafdf54cafd9aa7d9a20620637/ff44c/6EC23FAAFDF54CAFD9AA7D9A20620637.jpg 158w,\n/static/6ec23faafdf54cafd9aa7d9a20620637/a6688/6EC23FAAFDF54CAFD9AA7D9A20620637.jpg 315w,\n/static/6ec23faafdf54cafd9aa7d9a20620637/828fb/6EC23FAAFDF54CAFD9AA7D9A20620637.jpg 630w,\n/static/6ec23faafdf54cafd9aa7d9a20620637/0ede0/6EC23FAAFDF54CAFD9AA7D9A20620637.jpg 945w,\n/static/6ec23faafdf54cafd9aa7d9a20620637/09fd1/6EC23FAAFDF54CAFD9AA7D9A20620637.jpg 1208w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图2.9 决议过程3</p>\n<p>分别判断 <code class=\"language-text\">x</code> 是否为 <code class=\"language-text\">promise</code> 自身、 新的promise、 <code class=\"language-text\">thenable</code>对象之后，剩余的处理方法即2.3.4，以x的决议promise成功</p>\n<p>代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">promise<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>promise <span class=\"token operator\">===</span> x<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2.3.1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">isPromise</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> x<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">isThenable</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> then <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> x\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">isFunction</span><span class=\"token punctuation\">(</span>then<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token function\">then</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>到这里我们完成了规范主要的部分，剩下的工作就是要拼接+完成之前跳过的细节条目。</p>\n<p>首先，为了应对测试套件，我们需要写俩个静态方法：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Promise<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nPromise<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">reason</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>reason<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>我们发现这时候 <code class=\"language-text\">transition</code> 方法和 <code class=\"language-text\">resolvePromise</code> 方法还没被使用到。再思考一下平时我们使用promise的方式：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>于是我们需要在promise的构造函数中做以下工作：</p>\n<ol>\n<li>使用 <code class=\"language-text\">transition</code> 对单个promise进行状态转移</li>\n<li>使用 <code class=\"language-text\">handleCallback</code> 对当前的promise转移到下一个promise状态</li>\n<li>使用 <code class=\"language-text\">resolvePromise</code> 来处理promise决议成功后的result值</li>\n<li>当 <code class=\"language-text\">resolve</code> 或者 <code class=\"language-text\">reject</code> 被多次调用时，只取第一次调用的结果，忽略后面的调用。（2.3.3.3.3）</li>\n<li>将 <code class=\"language-text\">resolve</code> 和 <code class=\"language-text\">reject</code> 作为参数，传入 <code class=\"language-text\">f</code> 函数，后续在<code class=\"language-text\">new Promise</code>时就把 <code class=\"language-text\">f</code> 供出去让使用者可以使用 <code class=\"language-text\">resovle</code> 和 <code class=\"language-text\">reject</code> 方法。</li>\n<li>构建 <code class=\"language-text\">onFulfilled</code> 和 <code class=\"language-text\">onRejected</code> 提供将当前promise状态转换的能力</li>\n</ol>\n<p>这里直接贴上promies构造函数的代码，并且在代码中注释以上完成的功能点：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">f</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>callbacks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token comment\">// 6</span>\n  <span class=\"token keyword\">let</span> <span class=\"token function-variable function\">onFulfilled</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> <span class=\"token function\">transition</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">FULFILLED</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 1</span>\n  <span class=\"token keyword\">let</span> <span class=\"token function-variable function\">onRejected</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">reason</span> <span class=\"token operator\">=></span> <span class=\"token function\">transition</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">REJECTED</span><span class=\"token punctuation\">,</span> reason<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 1</span>\n\n  <span class=\"token keyword\">let</span> flag <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 4</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token comment\">// 4</span>\n    flag <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span> <span class=\"token comment\">// 4</span>\n    <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> onFulfilled<span class=\"token punctuation\">,</span> onRejected<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 3</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">reason</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token comment\">// 4</span>\n    flag <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span> <span class=\"token comment\">// 4</span>\n    <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span>reason<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 5</span>\n    <span class=\"token function\">f</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里的 <code class=\"language-text\">try...catch</code> 是因为2.2.7.2中，注册的callback如果在 <code class=\"language-text\">transition</code> 到新的状态的过程中抛错，可以在最外层被捕获到，直接决议promies失败。</p>\n<p>然后我们就来测试一下现在的代码</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> run <span class=\"token builtin class-name\">test</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aab4878614d10c4dfe9a05b531e05484/614df/AAB4878614D10C4DFE9A05B531E05484.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.32911392405063%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe5Q0o//xAAWEAADAAAAAAAAAAAAAAAAAAABIDH/2gAIAQEAAQUCNX//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAZEAACAwEAAAAAAAAAAAAAAAAAARARMUH/2gAIAQEAAT8hBVXIeicf/9oADAMBAAIAAwAAABATD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABwQAAICAgMAAAAAAAAAAAAAAAABESEQMUFRYf/aAAgBAQABPxCHQXi9CiK0XdjKvH//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/aab4878614d10c4dfe9a05b531e05484/828fb/AAB4878614D10C4DFE9A05B531E05484.jpg\"\n        srcset=\"/static/aab4878614d10c4dfe9a05b531e05484/ff44c/AAB4878614D10C4DFE9A05B531E05484.jpg 158w,\n/static/aab4878614d10c4dfe9a05b531e05484/a6688/AAB4878614D10C4DFE9A05B531E05484.jpg 315w,\n/static/aab4878614d10c4dfe9a05b531e05484/828fb/AAB4878614D10C4DFE9A05B531E05484.jpg 630w,\n/static/aab4878614d10c4dfe9a05b531e05484/0ede0/AAB4878614D10C4DFE9A05B531E05484.jpg 945w,\n/static/aab4878614d10c4dfe9a05b531e05484/614df/AAB4878614D10C4DFE9A05B531E05484.jpg 978w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图2.10 第一次测试结果</p>\n<p>这里我看到第一个错误结果就停止继续跑下去了。我们看一下这里报错对应的说明：</p>\n<blockquote>\n<p>applied to a promise rejected and then chained off of</p>\n</blockquote>\n<p>这里我们大概能猜出<strong>链式</strong>这一问题，回忆之前的代码，我们似乎没有处理注册在 <code class=\"language-text\">callbacks</code> 队列里的 <code class=\"language-text\">then</code> 回调，是否是这个原因导致呢？</p>\n<p>我们再实现一个 <code class=\"language-text\">handleCallbacks</code> 来处理队列里所有的 <code class=\"language-text\">then</code> 回调，这里注意我们还是需要遵守2.2.4使其与当前执行上下文不在一起。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">transition</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">promise<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>promise<span class=\"token punctuation\">.</span>state <span class=\"token operator\">!==</span> <span class=\"token constant\">PENDING</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n  promise<span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> state\n  promise<span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> result\n\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">handleCallbacks</span><span class=\"token punctuation\">(</span>promise<span class=\"token punctuation\">.</span>callbacks<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">handleCallbacks</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callbacks<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>callbacks<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token function\">handleCallback</span><span class=\"token punctuation\">(</span>callbacks<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span> \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>完整代码见：<a href=\"https://github.com/hemisu/promise-aplus-impl\">repo</a></p>\n<p>我们最后跑一下测试。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 318px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ce07c5a06be97ba8f62f00604ca42898/2debd/CE07C5A06BE97BA8F62F00604CA42898.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.88607594936709%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAd+ALBf/xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAEFAn//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAYEAADAQEAAAAAAAAAAAAAAAABEWEAEP/aAAgBAQABPyFU5U8//9oADAMBAAIAAwAAABB4D//EABYRAAMAAAAAAAAAAAAAAAAAAAEQMf/aAAgBAwEBPxAVf//EABYRAAMAAAAAAAAAAAAAAAAAAAEQMf/aAAgBAgEBPxAVf//EABkQAQACAwAAAAAAAAAAAAAAAAEAERAxQf/aAAgBAQABPxBs6IKzhj//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/ce07c5a06be97ba8f62f00604ca42898/2debd/CE07C5A06BE97BA8F62F00604CA42898.jpg\"\n        srcset=\"/static/ce07c5a06be97ba8f62f00604ca42898/ff44c/CE07C5A06BE97BA8F62F00604CA42898.jpg 158w,\n/static/ce07c5a06be97ba8f62f00604ca42898/a6688/CE07C5A06BE97BA8F62F00604CA42898.jpg 315w,\n/static/ce07c5a06be97ba8f62f00604ca42898/2debd/CE07C5A06BE97BA8F62F00604CA42898.jpg 318w\"\n        sizes=\"(max-width: 318px) 100vw, 318px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图2.11 第二次测试结果</p>\n<p>可以看到我们已经实现了一个Promies/A+规范（鼓掌）</p>\n<p>这里插一个小tip，我们如果把macroTask替换成microTask会不会更快一些捏？这里使用 <code class=\"language-text\">process.nextTick</code> 来替换 <code class=\"language-text\">setTimeout</code></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 270px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/182425ce19c05e16a5ad2d5631ae2fea/6f81f/182425CE19C05E16A5AD2D5631AE2FEA.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.354430379746837%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAd4E0Nf/xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAEFAn//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAXEAADAQAAAAAAAAAAAAAAAAAAARFh/9oACAEBAAE/IZrJrEf/2gAMAwEAAgADAAAAEIfP/8QAFREBAQAAAAAAAAAAAAAAAAAAEEH/2gAIAQMBAT8Qp//EABURAQEAAAAAAAAAAAAAAAAAABBB/9oACAECAQE/EKf/xAAcEAACAgIDAAAAAAAAAAAAAAABEQAxIUFRYXH/2gAIAQEAAT8QN8TPM3F3cBBMn2f/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/182425ce19c05e16a5ad2d5631ae2fea/6f81f/182425CE19C05E16A5AD2D5631AE2FEA.jpg\"\n        srcset=\"/static/182425ce19c05e16a5ad2d5631ae2fea/ff44c/182425CE19C05E16A5AD2D5631AE2FEA.jpg 158w,\n/static/182425ce19c05e16a5ad2d5631ae2fea/6f81f/182425CE19C05E16A5AD2D5631AE2FEA.jpg 270w\"\n        sizes=\"(max-width: 270px) 100vw, 270px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图2.12 第三次测试结果</p>\n<p>可以看到跑完测试的时间减少了3s，非常大的进步：D</p>\n<h2 id=\"23-增强为es6的promise\" style=\"position:relative;\"><a href=\"#23-%E5%A2%9E%E5%BC%BA%E4%B8%BAes6%E7%9A%84promise\" aria-label=\"23 增强为es6的promise permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 增强为ES6的promise</h2>\n<p>ES6需要补充的方法如下，可以看下面的一个是规范地址，一个是mdn地址；除去还在草案中的allsettled等方法，前面我们已经实现了打勾的部分，我们还需要实现剩下的catch、all、race。</p>\n<ol>\n<li><a href=\"https://tc39.es/ecma262/#sec-promise-objects\">https://tc39.es/ecma262/#sec-promise-objects</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/finally\">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/finally</a></li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/a4413/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.848101265822784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQB/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQP/2gAMAwEAAhADEAAAAb7ybgof/8QAGBAAAgMAAAAAAAAAAAAAAAAAABEBAxL/2gAIAQEAAQUCxY5Gf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABcRAAMBAAAAAAAAAAAAAAAAAAECEDH/2gAIAQIBAT8BRQMn/8QAFxAAAwEAAAAAAAAAAAAAAAAAEBEikf/aAAgBAQAGPwJzp//EABkQAAIDAQAAAAAAAAAAAAAAAAABMUFxgf/aAAgBAQABPyFLsaIHR//aAAwDAQACAAMAAAAQgA//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPxBVn//EABURAQEAAAAAAAAAAAAAAAAAABEQ/9oACAECAQE/EGRP/8QAGhABAAMAAwAAAAAAAAAAAAAAAQARIUGBof/aAAgBAQABPxCox3bM96hw8wABfif/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/828fb/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg\"\n        srcset=\"/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/ff44c/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg 158w,\n/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/a6688/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg 315w,\n/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/828fb/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg 630w,\n/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/0ede0/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg 945w,\n/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/3ac88/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg 1260w,\n/static/4c2a96f3e8ba48d1c40be67f84ed4d3e/a4413/4C2A96F3E8BA48D1C40BE67F84ED4D3E.jpg 1312w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图2.13 需要完成的方法</p>\n<h3 id=\"231-promiseprototypecatch\" style=\"position:relative;\"><a href=\"#231-promiseprototypecatch\" aria-label=\"231 promiseprototypecatch permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3.1 Promise.prototype.catch</h3>\n<p>这个方法其实就是一个语法糖，实现起来十分方便</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token class-name\">Promise</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">catch</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">f</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>reason<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> </code></pre></div>\n<h3 id=\"232-promiseall\" style=\"position:relative;\"><a href=\"#232-promiseall\" aria-label=\"232 promiseall permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3.2 Promise#all</h3>\n<p>实现 <code class=\"language-text\">promise.all</code> 方法主要注意以下几点：</p>\n<ol>\n<li>它不同于还在草案的<code class=\"language-text\">allSettled</code>，<code class=\"language-text\">all</code> 方法在决议失败时只需要返回第一个失败的错误。</li>\n<li>传入 <code class=\"language-text\">all</code> 方法的promises是一个数组，全部决议成功后返回的也是一个结果数组，且顺序与promises一致。</li>\n</ol>\n<p>接下来的工作我们就只需要判断每个值是否为promise，然后注册在 <code class=\"language-text\">then</code> 中进行处理。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Promise<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">all</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">promises <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> results <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">fn</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">i<span class=\"token punctuation\">,</span> resolve</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    count<span class=\"token operator\">++</span>\n    results<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">===</span> promises<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    promises<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">promise<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">isPromise</span><span class=\"token punctuation\">(</span>promise<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          promise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"232-promiserace\" style=\"position:relative;\"><a href=\"#232-promiserace\" aria-label=\"232 promiserace permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3.2 Promise#race</h3>\n<p>其实实现了 <code class=\"language-text\">all</code> 方法后，<code class=\"language-text\">race</code> 的方法的实现就水到渠成了。我们把上面的<code class=\"language-text\">fn</code>拿走就可以完成了</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Promise<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">race</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">promises <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>  \n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    promises<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">promise</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">isPromise</span><span class=\"token punctuation\">(</span>promise<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          promise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>最后跑一下测试，</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">results</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'results'</span><span class=\"token punctuation\">,</span> results<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">timeEnd</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TIME_LOG_NAME</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">race</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">results</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'results'</span><span class=\"token punctuation\">,</span> results<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">timeEnd</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TIME_LOG_NAME</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>最后一个 <code class=\"language-text\">finally</code> 方法交给大家来解决吧～欢迎在下面提出</p>\n<h1 id=\"3-总结\" style=\"position:relative;\"><a href=\"#3-%E6%80%BB%E7%BB%93\" aria-label=\"3 总结 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3 总结</h1>\n<h2 id=\"31实现promise之后的思考\" style=\"position:relative;\"><a href=\"#31%E5%AE%9E%E7%8E%B0promise%E4%B9%8B%E5%90%8E%E7%9A%84%E6%80%9D%E8%80%83\" aria-label=\"31实现promise之后的思考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1实现promise之后的思考</h2>\n<h3 id=\"311-它是一个callback-management\" style=\"position:relative;\"><a href=\"#311-%E5%AE%83%E6%98%AF%E4%B8%80%E4%B8%AAcallback-management\" aria-label=\"311 它是一个callback management permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1.1 它是一个callback management</h3>\n<p>正如前面所说的，我们可以把promise看作是一个callback management：\n也正如它内置状态所展示的一样，它可以处理0～1个异步结果。\n如果有了解RxJS的同学，我们可以RxJS当作是一个可以处理0～Infinite个异步结果的库。\n这无疑是一种能力的增强，同时也是对编码人员的挑战。如果实际的场景没有这么大的需求，我们不会轻易上这类工具。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a4ca555a1d97807117682bb7b8b2233a/1b43a/A4CA555A1D97807117682BB7B8B2233A.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.151898734177216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAEABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB34EB/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAERIf/aAAgBAQABPyGCWlh//9oADAMBAAIAAwAAABAAD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAAICAwAAAAAAAAAAAAAAAAERACExQZH/2gAIAQEAAT8QRu+yyWbCzARFbLn/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/a4ca555a1d97807117682bb7b8b2233a/828fb/A4CA555A1D97807117682BB7B8B2233A.jpg\"\n        srcset=\"/static/a4ca555a1d97807117682bb7b8b2233a/ff44c/A4CA555A1D97807117682BB7B8B2233A.jpg 158w,\n/static/a4ca555a1d97807117682bb7b8b2233a/a6688/A4CA555A1D97807117682BB7B8B2233A.jpg 315w,\n/static/a4ca555a1d97807117682bb7b8b2233a/828fb/A4CA555A1D97807117682BB7B8B2233A.jpg 630w,\n/static/a4ca555a1d97807117682bb7b8b2233a/0ede0/A4CA555A1D97807117682BB7B8B2233A.jpg 945w,\n/static/a4ca555a1d97807117682bb7b8b2233a/3ac88/A4CA555A1D97807117682BB7B8B2233A.jpg 1260w,\n/static/a4ca555a1d97807117682bb7b8b2233a/1b43a/A4CA555A1D97807117682BB7B8B2233A.jpg 1892w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>图3.1 Callback Management</p>\n<h3 id=\"312-能手写promies实现就一定精通promies\" style=\"position:relative;\"><a href=\"#312-%E8%83%BD%E6%89%8B%E5%86%99promies%E5%AE%9E%E7%8E%B0%E5%B0%B1%E4%B8%80%E5%AE%9A%E7%B2%BE%E9%80%9Apromies\" aria-label=\"312 能手写promies实现就一定精通promies permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1.2 能手写promies实现，就一定精通promies？</h3>\n<p>我们刚刚实现的Promise/A+ 规范，重点围绕的是 How to implement 通过实现规范，或者所谓的吃透底层源码，以期打通任督二脉的武学幻想，是不切实际的。 想要精通 promises，还得在日常开发的各个异步场景中，多加思考和训练。 我们应当把精通 promises 定义为：\n<strong>善于在各种异步场景中使用 promises 解决问题。</strong>\n这里就很推荐promise迷你书 <sup><a href=\"http://liubin.org/promises-book/\" title=\"promise迷你书\">3</a></sup></p>\n<h3 id=\"313-promise-是比-callback-更先进的异步方案\" style=\"position:relative;\"><a href=\"#313-promise-%E6%98%AF%E6%AF%94-callback-%E6%9B%B4%E5%85%88%E8%BF%9B%E7%9A%84%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88\" aria-label=\"313 promise 是比 callback 更先进的异步方案 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1.3 Promise 是比 callback 更先进的异步方案？</h3>\n<p>正如前面所说的等价交换，语义化和标准化，不意味着能力的增强，它也有可能导致能力的减弱；所以谈不上先进，因为减少心智负担也是重要的一个环节。</p>\n<ul>\n<li>减少编码的心智负担，提高代码可维护性</li>\n<li>只有两种callback路径，削弱了灵活性</li>\n</ul>\n<p>但是我们也要发现的是：promise 的 <code class=\"language-text\">then</code> 只支持 <code class=\"language-text\">onFulfilled</code> 和 <code class=\"language-text\">onRejected</code> 两种 callback 路径，属于对所有可能的 callback 路径的简化。\n同样是给有兴趣的同学，<a href=\"https://github.com/callbag/callbag\" title=\"callbag\">callbag</a>库可以使用多个callback函数组合，实现rxjs的observables和iterables。</p>\n<h2 id=\"32-反模式\" style=\"position:relative;\"><a href=\"#32-%E5%8F%8D%E6%A8%A1%E5%BC%8F\" aria-label=\"32 反模式 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 反模式</h2>\n<p>最后的最后，我们来看几个反模式。</p>\n<h3 id=\"321-anti-patterns-1\" style=\"position:relative;\"><a href=\"#321-anti-patterns-1\" aria-label=\"321 anti patterns 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2.1 Anti-patterns 1</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a8df6f5d79c0e2eb9b9c138c846e4b2a/627f4/A8DF6F5D79C0E2EB9B9C138C846E4B2A.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.22784810126582%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3VFB/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGBABAQADAAAAAAAAAAAAAAAAAQAQESH/2gAIAQEAAT8h6QsWs//aAAwDAQACAAMAAAAQMM//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAbEAEBAQACAwAAAAAAAAAAAAABABEhMUFhof/aAAgBAQABPxBdE69srx9tZzI3YIv/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/a8df6f5d79c0e2eb9b9c138c846e4b2a/828fb/A8DF6F5D79C0E2EB9B9C138C846E4B2A.jpg\"\n        srcset=\"/static/a8df6f5d79c0e2eb9b9c138c846e4b2a/ff44c/A8DF6F5D79C0E2EB9B9C138C846E4B2A.jpg 158w,\n/static/a8df6f5d79c0e2eb9b9c138c846e4b2a/a6688/A8DF6F5D79C0E2EB9B9C138C846E4B2A.jpg 315w,\n/static/a8df6f5d79c0e2eb9b9c138c846e4b2a/828fb/A8DF6F5D79C0E2EB9B9C138C846E4B2A.jpg 630w,\n/static/a8df6f5d79c0e2eb9b9c138c846e4b2a/627f4/A8DF6F5D79C0E2EB9B9C138C846E4B2A.jpg 810w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图3.1 Anti-patterns 1</p>\n<p>这块的问题在于没有使用promise方法链。</p>\n<ol>\n<li><code class=\"language-text\">promise.then</code>中产生的异常不会被外部捕获</li>\n<li>每次 <code class=\"language-text\">promise.then</code> 调用都会返回一个新创建的promise对象，不能得到 <code class=\"language-text\">then</code> 的返回值</li>\n</ol>\n<p>解决方法如图3.2所示\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/305e536e9ae1c3d8bc74c284c27d441d/627f4/305E536E9AE1C3D8BC74C284C27D441D.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.79746835443038%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3VoB/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGRAAAgMBAAAAAAAAAAAAAAAAAAERIDFR/9oACAEBAAE/IcJfBU//2gAMAwEAAgADAAAAECDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBABAAEEAwAAAAAAAAAAAAAAAQAQESExUWGB/9oACAEBAAE/EFdNdsG5ey5M4lihP//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/305e536e9ae1c3d8bc74c284c27d441d/828fb/305E536E9AE1C3D8BC74C284C27D441D.jpg\"\n        srcset=\"/static/305e536e9ae1c3d8bc74c284c27d441d/ff44c/305E536E9AE1C3D8BC74C284C27D441D.jpg 158w,\n/static/305e536e9ae1c3d8bc74c284c27d441d/a6688/305E536E9AE1C3D8BC74C284C27D441D.jpg 315w,\n/static/305e536e9ae1c3d8bc74c284c27d441d/828fb/305E536E9AE1C3D8BC74C284C27D441D.jpg 630w,\n/static/305e536e9ae1c3d8bc74c284c27d441d/627f4/305E536E9AE1C3D8BC74C284C27D441D.jpg 810w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图3.2 Anti-patterns 1 resolution</p>\n<h3 id=\"322-anti-patterns-2\" style=\"position:relative;\"><a href=\"#322-anti-patterns-2\" aria-label=\"322 anti patterns 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2.2 Anti-patterns 2</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/25393614a3d21e15b2d75eb6cc667f46/ad059/25393614A3D21E15B2D75EB6CC667F46.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.45569620253164%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3VFB/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGBAAAwEBAAAAAAAAAAAAAAAAAAERECH/2gAIAQEAAT8hfGURCZ//2gAMAwEAAgADAAAAEEDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAAICAwAAAAAAAAAAAAAAAQARIaExQZH/2gAIAQEAAT8QSlbWX7NzhG7dsCN59hP/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/25393614a3d21e15b2d75eb6cc667f46/828fb/25393614A3D21E15B2D75EB6CC667F46.jpg\"\n        srcset=\"/static/25393614a3d21e15b2d75eb6cc667f46/ff44c/25393614A3D21E15B2D75EB6CC667F46.jpg 158w,\n/static/25393614a3d21e15b2d75eb6cc667f46/a6688/25393614A3D21E15B2D75EB6CC667F46.jpg 315w,\n/static/25393614a3d21e15b2d75eb6cc667f46/828fb/25393614A3D21E15B2D75EB6CC667F46.jpg 630w,\n/static/25393614a3d21e15b2d75eb6cc667f46/ad059/25393614A3D21E15B2D75EB6CC667F46.jpg 758w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图3.3 Anti-patterns 2</p>\n<p>这个不是一个很严重的反模式，不过还记不记得我们前面实现的时候有写一个resolvePromise方法可以处理不同情况下的result。利用好这一点：D</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1f5f81c12726ec5bcda78e15e54a7e35/10435/1F5F81C12726EC5BCDA78E15E54A7E35.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.79746835443038%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3VFB/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAFxAAAwEAAAAAAAAAAAAAAAAAACAhMf/aAAgBAQABPyHCr//aAAwDAQACAAMAAAAQcA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAEBAQADAAAAAAAAAAAAAAABADERIVH/2gAIAQEAAT8QVw77Ct6iQThIAwi//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/1f5f81c12726ec5bcda78e15e54a7e35/828fb/1F5F81C12726EC5BCDA78E15E54A7E35.jpg\"\n        srcset=\"/static/1f5f81c12726ec5bcda78e15e54a7e35/ff44c/1F5F81C12726EC5BCDA78E15E54A7E35.jpg 158w,\n/static/1f5f81c12726ec5bcda78e15e54a7e35/a6688/1F5F81C12726EC5BCDA78E15E54A7E35.jpg 315w,\n/static/1f5f81c12726ec5bcda78e15e54a7e35/828fb/1F5F81C12726EC5BCDA78E15E54A7E35.jpg 630w,\n/static/1f5f81c12726ec5bcda78e15e54a7e35/10435/1F5F81C12726EC5BCDA78E15E54A7E35.jpg 944w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图3.4 Anti-patterns 2 resolution</p>\n<h3 id=\"323-anti-patterns-3\" style=\"position:relative;\"><a href=\"#323-anti-patterns-3\" aria-label=\"323 anti patterns 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2.3 Anti-patterns 3</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fe03cf8560b940da8051bf0d8f8f2ae1/627f4/FE03CF8560B940DA8051BF0D8F8F2AE1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.79746835443038%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3VFB/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGBAAAgMAAAAAAAAAAAAAAAAAAAERIDH/2gAIAQEAAT8hwkVP/9oADAMBAAIAAwAAABBwz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABsQAQEAAwADAAAAAAAAAAAAAAEAETFRQXGB/9oACAEBAAE/EFdU+sJ8Z9Wlg5Aci//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/fe03cf8560b940da8051bf0d8f8f2ae1/828fb/FE03CF8560B940DA8051BF0D8F8F2AE1.jpg\"\n        srcset=\"/static/fe03cf8560b940da8051bf0d8f8f2ae1/ff44c/FE03CF8560B940DA8051BF0D8F8F2AE1.jpg 158w,\n/static/fe03cf8560b940da8051bf0d8f8f2ae1/a6688/FE03CF8560B940DA8051BF0D8F8F2AE1.jpg 315w,\n/static/fe03cf8560b940da8051bf0d8f8f2ae1/828fb/FE03CF8560B940DA8051BF0D8F8F2AE1.jpg 630w,\n/static/fe03cf8560b940da8051bf0d8f8f2ae1/627f4/FE03CF8560B940DA8051BF0D8F8F2AE1.jpg 810w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图3.5 Anti-patterns 3</p>\n<p>这里的问题就在于，<code class=\"language-text\">somethingElseAsync</code>中抛出的函数不会被<code class=\"language-text\">handleMyError</code>处理。\n我们可以再注册一个 <code class=\"language-text\">then</code> 方法；或者直接使用 <code class=\"language-text\">catch</code> 语法糖。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/786e3bb5c3937897950bb2eb47f5c120/627f4/786E3BB5C3937897950BB2EB47F5C120.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.22784810126582%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3aFB/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGRAAAwADAAAAAAAAAAAAAAAAAAEREDFh/9oACAEBAAE/IdF4IhFj/9oADAMBAAIAAwAAABAgz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABkQAQEAAwEAAAAAAAAAAAAAAAEAETGRQf/aAAgBAQABPxBXR6wveG0kJhgtEX//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"IMAGE\"\n        title=\"IMAGE\"\n        src=\"/static/786e3bb5c3937897950bb2eb47f5c120/828fb/786E3BB5C3937897950BB2EB47F5C120.jpg\"\n        srcset=\"/static/786e3bb5c3937897950bb2eb47f5c120/ff44c/786E3BB5C3937897950BB2EB47F5C120.jpg 158w,\n/static/786e3bb5c3937897950bb2eb47f5c120/a6688/786E3BB5C3937897950BB2EB47F5C120.jpg 315w,\n/static/786e3bb5c3937897950bb2eb47f5c120/828fb/786E3BB5C3937897950BB2EB47F5C120.jpg 630w,\n/static/786e3bb5c3937897950bb2eb47f5c120/627f4/786E3BB5C3937897950BB2EB47F5C120.jpg 810w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n图3.4 Anti-patterns 3 resolution</p>\n<h2 id=\"33-附录\" style=\"position:relative;\"><a href=\"#33-%E9%99%84%E5%BD%95\" aria-label=\"33 附录 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3 附录</h2>\n<p>参考：</p>\n<ul>\n<li>\n<p>100行代码实现promise\n<a href=\"https://mp.weixin.qq.com/s/qdJ0Xd8zTgtetFdlJL3P1g\">https://mp.weixin.qq.com/s/qdJ0Xd8zTgtetFdlJL3P1g</a></p>\n</li>\n<li>\n<p>深入理解Javascript异步 part1 part2<br>\n<a href=\"https://github.com/wangfupeng1988/js-async-tutorial\">https://github.com/wangfupeng1988/js-async-tutorial</a></p>\n</li>\n<li>\n<p>promies迷你书\n<a href=\"http://liubin.org/promises-book/\">http://liubin.org/promises-book/</a></p>\n</li>\n<li>\n<p>聊一聊promise的前世今生\n<a href=\"https://www.cnblogs.com/tarol/p/9042407.html\">https://www.cnblogs.com/tarol/p/9042407.html</a></p>\n</li>\n<li>\n<p>更多的反模式\n<a href=\"http://taoofcode.net/promise-anti-patterns/\">http://taoofcode.net/promise-anti-patterns/</a></p>\n</li>\n</ul>\n<h2 id=\"答案1-事件绑定算不算异步操作\" style=\"position:relative;\"><a href=\"#%E7%AD%94%E6%A1%881-%E4%BA%8B%E4%BB%B6%E7%BB%91%E5%AE%9A%E7%AE%97%E4%B8%8D%E7%AE%97%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C\" aria-label=\"答案1 事件绑定算不算异步操作 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>答案1 事件绑定算不算异步操作</h2>\n<p><span id=\"17:31:42-1\"><a href=\"#17:31:42\">⬆️ 返回 ⬆️</a></span></p>\n<p>这个问题是在我研究这个主题的时候看到的一个讨论：\n<a href=\"https://github.com/wangfupeng1988/js-async-tutorial/blob/master/part1-basic/03-event-bind.md\">refer: 事件绑定算不算异步？</a></p>\n<p>个人的见解在于，事件绑定是否属于异步操作需要看触发源是否在同一个 <a href=\"https://es5.github.io/#x10.3\">execution context</a> 中。</p>\n<p>通过判断有没有runtime的介入：如果仅仅是在js engine下，它只负责取消息，不负责生产消息；那么在代码中编写的事件绑定就属于一类同步操作；</p>\n<p>如果有runtime的介入，比如浏览器DOM事件发送一条合成事件（SyntheticEvent）统一处理，或者是监听onload消息等，js engine在清理完call-stack后接受接收到这条消息并且执行，这时候就可以认为它是异步操作。</p>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#1-%E5%89%8D%E8%A8%80\">1. 前言</a></p>\n<ul>\n<li>\n<p><a href=\"#11-%E4%B8%BA%E4%BD%95%E4%BC%9A%E6%9C%89%E5%BC%82%E6%AD%A5\">1.1 为何会有异步</a></p>\n</li>\n<li>\n<p><a href=\"#12-%E5%BC%82%E6%AD%A5%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86\">1.2 异步的实现原理</a></p>\n<ul>\n<li><a href=\"#121-%E5%B8%B8%E8%A7%81%E7%9A%84%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C\">1.2.1 常见的异步操作：</a></li>\n<li><a href=\"#122-%E4%BA%8B%E4%BB%B6%E7%BB%91%E5%AE%9A%E7%AE%97%E4%B8%8D%E7%AE%97%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C\">1.2.2 事件绑定算不算异步操作？</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#13-%E5%BC%82%E6%AD%A5%E7%9A%84%E6%BC%94%E8%BF%9B%E6%96%B9%E6%A1%88\">1.3 异步的演进方案</a></p>\n<ul>\n<li><a href=\"#131-deferred%E5%92%8Cpromise%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB\">1.3.1 <code class=\"language-text\">$.deferred</code>和<code class=\"language-text\">$.promise</code>有什么区别？</a></li>\n<li><a href=\"#132-callback%E7%9A%84%E5%BC%95%E5%85%A5\">1.3.2 callback的引入</a></li>\n<li><a href=\"#133-promise%E4%B9%9F%E6%98%AFcallback\">1.3.3 promise也是callback？</a></li>\n<li><a href=\"#134-generator%E4%B9%9F%E6%98%AFcallback\">1.3.4 generator也是callback？</a></li>\n<li><a href=\"#135-%E6%9C%80%E5%90%8E%E6%BC%94%E8%BF%9B%E5%88%B0asyncawait\">1.3.5 最后演进到async/await</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#2-promise\">2 Promise</a></p>\n<ul>\n<li>\n<p><a href=\"#21-%E6%A6%82%E8%A7%88\">2.1 概览</a></p>\n<ul>\n<li><a href=\"#211-%E5%9B%BE21%E4%B8%AD%E4%BF%A9%E8%80%85%E7%9A%84promise%E6%9C%89%E5%95%A5%E5%8C%BA%E5%88%AB\">2.1.1 图2.1中俩者的promise有啥区别？</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#22-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA-promisea-%E8%A7%84%E8%8C%83\">2.2 实现一个 Promise/A+ 规范</a></p>\n<ul>\n<li><a href=\"#221-%E5%89%8D%E6%9C%9F%E5%B7%A5%E4%BD%9C\">2.2.1 前期工作</a></li>\n<li><a href=\"#222-%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0\">2.2.2 开始实现</a></li>\n<li><a href=\"#223-%E6%9C%AF%E8%AF%AD---1terminology\">2.2.3 术语 - 1.terminology</a></li>\n<li><a href=\"#224-promise%E7%9A%84%E7%8A%B6%E6%80%81---21-promise-states\">2.2.4 promise的状态 - 2.1 Promise States</a></li>\n<li><a href=\"#225-then-%E6%96%B9%E6%B3%95---22-the-then-method\">2.2.5 then 方法 - 2.2 The then Method</a></li>\n<li><a href=\"#226-then-%E6%96%B9%E6%B3%95---23-the-promise-resolution-procedure\">2.2.6 then 方法 - 2.3 The Promise Resolution Procedure</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#23-%E5%A2%9E%E5%BC%BA%E4%B8%BAes6%E7%9A%84promise\">2.3 增强为ES6的promise</a></p>\n<ul>\n<li><a href=\"#231-promiseprototypecatch\">2.3.1 Promise.prototype.catch</a></li>\n<li><a href=\"#232-promiseall\">2.3.2 Promise#all</a></li>\n<li><a href=\"#232-promiserace\">2.3.2 Promise#race</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#3-%E6%80%BB%E7%BB%93\">3 总结</a></p>\n<ul>\n<li>\n<p><a href=\"#31%E5%AE%9E%E7%8E%B0promise%E4%B9%8B%E5%90%8E%E7%9A%84%E6%80%9D%E8%80%83\">3.1实现promise之后的思考</a></p>\n<ul>\n<li><a href=\"#311-%E5%AE%83%E6%98%AF%E4%B8%80%E4%B8%AAcallback-management\">3.1.1 它是一个callback management</a></li>\n<li><a href=\"#312-%E8%83%BD%E6%89%8B%E5%86%99promies%E5%AE%9E%E7%8E%B0%E5%B0%B1%E4%B8%80%E5%AE%9A%E7%B2%BE%E9%80%9Apromies\">3.1.2 能手写promies实现，就一定精通promies？</a></li>\n<li><a href=\"#313-promise-%E6%98%AF%E6%AF%94-callback-%E6%9B%B4%E5%85%88%E8%BF%9B%E7%9A%84%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88\">3.1.3 Promise 是比 callback 更先进的异步方案？</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#32-%E5%8F%8D%E6%A8%A1%E5%BC%8F\">3.2 反模式</a></p>\n<ul>\n<li><a href=\"#321-anti-patterns-1\">3.2.1 Anti-patterns 1</a></li>\n<li><a href=\"#322-anti-patterns-2\">3.2.2 Anti-patterns 2</a></li>\n<li><a href=\"#323-anti-patterns-3\">3.2.3 Anti-patterns 3</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#33-%E9%99%84%E5%BD%95\">3.3 附录</a></p>\n</li>\n<li>\n<p><a href=\"#%E7%AD%94%E6%A1%881-%E4%BA%8B%E4%BB%B6%E7%BB%91%E5%AE%9A%E7%AE%97%E4%B8%8D%E7%AE%97%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C\">答案1 事件绑定算不算异步操作</a></p>\n</li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"js异步初探 - promise","date":"November 04, 2019","description":null}},"previous":{"fields":{"slug":"/old-posts/2018-10-17-React-Components-Elements-and-Instance/"},"frontmatter":{"title":"一次打包错误 引起的对 React Components, Elements, Instance三者的认识"}},"next":{"fields":{"slug":"/old-posts/promise-pool/"},"frontmatter":{"title":"js异步初探 - 图解并发控制"}}},"pageContext":{"id":"1c84bcf6-b47b-5bad-be30-31744e154099","previousPostId":"1cd2496c-0ec9-5e07-a002-a91eafe5d997","nextPostId":"7e002c77-fc4e-5f11-95b7-b6279b770e6c"}},
    "staticQueryHashes": ["2841359383","3257411868"]}
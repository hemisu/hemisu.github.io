{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/old-posts/2020-09-27-webpack-bundling-live-by-hand/",
    "result": {"data":{"site":{"siteMetadata":{"title":"何米酥`s Blog"}},"markdownRemark":{"id":"dabf4f24-d8be-5126-aa76-47fdc9ef0861","excerpt":"本质上，webpack 是一个用于现代 JavaScript 应用程序的静态模块打包工具。当 webpack 处理应用程序时，它会在内部构建一个 依赖图(dependency graph)，此依赖图对应映射到项目所需的每个模块，并生成一个或多个 bundle…","html":"<blockquote>\n<p>本质上，webpack 是一个用于现代 JavaScript 应用程序的静态模块打包工具。当 webpack 处理应用程序时，它会在内部构建一个 依赖图(dependency graph)，此依赖图对应映射到项目所需的每个模块，并生成一个或多个 bundle。</p>\n</blockquote>\n<p>为了更好地理解模块打包工具背后的理念，以及在底层它们是如何运作的，在观看 Tobias Koppers 放在油管的视频后整理本文，后续将录制视频帮助理解，demo地址将在底部放出。</p>\n<h2 id=\"demo介绍\" style=\"position:relative;\"><a href=\"#demo%E4%BB%8B%E7%BB%8D\" aria-label=\"demo介绍 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Demo介绍</h2>\n<p>视频<a href=\"https://www.youtube.com/watch?v=UNMkLHzofQI\">1</a>从开头介绍了整个项目的大体内容，位于 <code class=\"language-text\">src</code> 文件中：项目以 <code class=\"language-text\">React</code> 作为示范，引入一个异步懒加载组件（<code class=\"language-text\">lazy component</code>）展示到根组件中。</p>\n<p>项目目录如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">├── <span class=\"token constant\">README</span><span class=\"token punctuation\">.</span>md\n├── index<span class=\"token punctuation\">.</span>html\n├── one<span class=\"token operator\">-</span>day<span class=\"token operator\">-</span>bundler <span class=\"token comment\">// 按照打包流程顺序整理</span>\n├── react<span class=\"token operator\">-</span>bundle\n\t├── webpack<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>js <span class=\"token comment\">// 预打包 webpack 配置</span>\n├── src <span class=\"token comment\">// 源文件</span>\n├── webpack<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>js <span class=\"token comment\">// 主 webpack 配置</span></code></pre></div>\n<ol>\n<li>\n<p>主 <code class=\"language-text\">webpack</code> 配置</p>\n<p>文件位于 <code class=\"language-text\">wepback.config.js</code> ，主要内容是使用 <code class=\"language-text\">babel-loader</code> 解析 <code class=\"language-text\">js</code> 文件，然后配置了 3 个 <code class=\"language-text\">alias</code> 解析 <code class=\"language-text\">react</code>、<code class=\"language-text\">react-dom</code> 以及 <code class=\"language-text\">react-bundle</code></p>\n</li>\n<li>\n<p>预打包 <code class=\"language-text\">webpack</code> 配置</p>\n<p>文件位于 <code class=\"language-text\">react-bundler/webpack.config.js</code> 用于将 <code class=\"language-text\">react</code> 和 <code class=\"language-text\">react-dom</code> 以 <code class=\"language-text\">commonjs</code> 规范打包到 <code class=\"language-text\">react-bundler/dist/react-bundle.js</code> 中，这个地址也是主 <code class=\"language-text\">webpack</code> 中最后的 <code class=\"language-text\">alias</code> 指定的地址。这一步预打包是为了更方便后续的演示。</p>\n</li>\n</ol>\n<!--more-->\n<p>安装完依赖之后，我们可以先执行一波 <code class=\"language-text\">yarn webpack --display-modules</code> 查看 <code class=\"language-text\">webpack</code> 打包后的结果</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6e25126419b63c354f1fedec20a82a00/914c7/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.075949367088604%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABX0lEQVQoz2WRWY7bMBBEdYsAsUbWSlEUqZVaLdvj8Ybc/0AvMI0MguSj0OgGulFdzwuVpJoHhNYIqejsSNNZMlG4KowmbjRJo0mVYjkcqZoO07QEUYK/j/gI4295ZpuoLguirdyxad3o14WfSUSQpGSVIT9ZxNaTGU1vR7f4Y+ezC0J2QeSq7xThtf1AP0yM88q4rAzTQj2PdMeVylpK01CamkJXlFWNrlvnXrm+oSgVwpTEtSZS8n2w7iyX253b48nX/YEdZg7bicfzF+evG+thYTgfmR6fNLNF1Ia8qYiznDjNiIRgnwuCNMV7DTOpaO3AtB5cRsrULqN53ejsRN41qLFDGkMqBa/cX/LDP+9G75f3EV6cCnJVsmwn5/J8uXK9PzmeLwzzynbamD43yutCtrQEmcD/eGf2N4xvKEorR7MbJqq2p7UjstSkuXTO80KSFDlhIdkL8R/Vfyn/Bglj1GzoI+H1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image\"\n        title=\"image\"\n        src=\"/static/6e25126419b63c354f1fedec20a82a00/f058b/1.png\"\n        srcset=\"/static/6e25126419b63c354f1fedec20a82a00/c26ae/1.png 158w,\n/static/6e25126419b63c354f1fedec20a82a00/6bdcf/1.png 315w,\n/static/6e25126419b63c354f1fedec20a82a00/f058b/1.png 630w,\n/static/6e25126419b63c354f1fedec20a82a00/40601/1.png 945w,\n/static/6e25126419b63c354f1fedec20a82a00/914c7/1.png 978w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>使用 webpack —display-modules 查看打包结果</p>\n<h2 id=\"手动模拟打包流程\" style=\"position:relative;\"><a href=\"#%E6%89%8B%E5%8A%A8%E6%A8%A1%E6%8B%9F%E6%89%93%E5%8C%85%E6%B5%81%E7%A8%8B\" aria-label=\"手动模拟打包流程 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>手动模拟打包流程</h2>\n<p><code class=\"language-text\">webpack</code> 的打包流程如 <code class=\"language-text\">one-day-bundler</code> 中的各文件夹所示，接下来我们将手动模拟打包流程</p>\n<h3 id=\"第一步生成模块依赖图-module-graph\" style=\"position:relative;\"><a href=\"#%E7%AC%AC%E4%B8%80%E6%AD%A5%E7%94%9F%E6%88%90%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96%E5%9B%BE-module-graph\" aria-label=\"第一步生成模块依赖图 module graph permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>第一步：生成模块依赖图 （module-graph）</h3>\n<p>自 <code class=\"language-text\">webpack4</code> 开始，大部分的配置都内置了，这里的解析入口从 <code class=\"language-text\">src/index.js</code> 开始：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">Modules<span class=\"token operator\">:</span>\n\n<span class=\"token operator\">*</span> src<span class=\"token operator\">/</span>index<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ESM</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token constant\">TODO</span><span class=\"token operator\">-</span>List<span class=\"token operator\">:</span>\n\n<span class=\"token operator\">*</span> <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>src <span class=\"token keyword\">in</span> <span class=\"token operator\">...</span><span class=\"token operator\">/</span> <span class=\"token operator\">--</span><span class=\"token operator\">></span> <span class=\"token operator\">...</span><span class=\"token operator\">/</span>src<span class=\"token operator\">/</span>index<span class=\"token punctuation\">.</span>js</code></pre></div>\n<p>找到入口文件后我们的 <code class=\"language-text\">rules</code> 会解析到 <code class=\"language-text\">.js</code> 后缀的文件，通过 <code class=\"language-text\">babel-loader</code> 转译到 <code class=\"language-text\">modules</code> 中，我们可以手动模拟这个过程：</p>\n<p><code class=\"language-text\">yarn babel src/index.js -d one-day-bundler/10-module-graph/modules</code></p>\n<p>接着以 <code class=\"language-text\">src/index.js</code> 开始，静态分析 <code class=\"language-text\">ESM</code> 的 <code class=\"language-text\">import</code> 发现引用了 <code class=\"language-text\">react</code>、<code class=\"language-text\">react-dom</code> 和 <code class=\"language-text\">./HelloWorld</code>。由于 <code class=\"language-text\">react</code>、<code class=\"language-text\">react-dom</code> 已经在前面预编译为 <code class=\"language-text\">commonjs</code> 规范，这里就不需要继续往下解析了。</p>\n<p>在 <code class=\"language-text\">./HelloWorld</code> 中解析到以下三处，加入到 <code class=\"language-text\">module graph</code> 中</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// line: 9</span>\n<span class=\"token keyword\">import</span> BigText <span class=\"token keyword\">from</span> <span class=\"token string\">\"./BigText\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// line: 10</span>\n\n<span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span> <span class=\"token comment\">/* webpackChunkName: \"async\" */</span><span class=\"token string\">\"./Lazy\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_ref</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// line:31</span></code></pre></div>\n<p>与前面相同，继续手动模拟 <code class=\"language-text\">babel-loader</code> 的过程</p>\n<p><code class=\"language-text\">yarn babel src/HelloWorld.js -d one-day-bundler/10-module-graph/modules</code></p>\n<p><code class=\"language-text\">yarn babel src/BigText.js -d one-day-bundler/10-module-graph/modules</code></p>\n<p><code class=\"language-text\">yarn babel src/Lazy.js -d one-day-bundler/10-module-graph/modules</code></p>\n<p>经历以上三步内容，我们可以在目录中看到以下结构：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">one<span class=\"token operator\">-</span>day<span class=\"token operator\">-</span>bundler<span class=\"token operator\">/</span><span class=\"token number\">10</span><span class=\"token operator\">-</span>module<span class=\"token operator\">-</span>graph<span class=\"token operator\">/</span>modules<span class=\"token operator\">/</span>src\n├── BigText<span class=\"token punctuation\">.</span>js\n├── HelloWorld<span class=\"token punctuation\">.</span>js\n├── Lazy<span class=\"token punctuation\">.</span>js\n└── index<span class=\"token punctuation\">.</span>js</code></pre></div>\n<p>再进入 <code class=\"language-text\">src/BigText.js</code> 以及 <code class=\"language-text\">src/Lazy.js</code> 分析，最终的 <code class=\"language-text\">module graph</code> 图如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">Modules<span class=\"token operator\">:</span>\n\n<span class=\"token operator\">*</span> src<span class=\"token operator\">/</span>index<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ESM</span><span class=\"token punctuation\">)</span>\n    # react\n    # react<span class=\"token operator\">-</span>dom\n    # <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>HelloWorld\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>HelloWorld<span class=\"token punctuation\">.</span>js\n<span class=\"token operator\">*</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n<span class=\"token operator\">*</span> src<span class=\"token operator\">/</span>HelloWorld<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ESM</span><span class=\"token punctuation\">)</span>\n    # react\n    # <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>BigText\n    # <span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>Lazy\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">)</span> src<span class=\"token operator\">/</span>Lazy<span class=\"token punctuation\">.</span>js\n<span class=\"token operator\">*</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ESM</span><span class=\"token punctuation\">)</span>\n    # react\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n<span class=\"token operator\">*</span> src<span class=\"token operator\">/</span>Lazy<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ESM</span><span class=\"token punctuation\">)</span>\n    # react\n    # <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>BigText\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js\n\n<span class=\"token constant\">TODO</span><span class=\"token operator\">-</span>List<span class=\"token operator\">:</span>\n\nx <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>src <span class=\"token keyword\">in</span> <span class=\"token operator\">...</span><span class=\"token operator\">/</span> <span class=\"token operator\">--</span><span class=\"token operator\">></span> <span class=\"token operator\">...</span><span class=\"token operator\">/</span>src<span class=\"token operator\">/</span>index<span class=\"token punctuation\">.</span>js\nx react<span class=\"token operator\">-</span>bundle <span class=\"token keyword\">in</span> <span class=\"token operator\">...</span><span class=\"token operator\">/</span>src <span class=\"token operator\">--</span><span class=\"token operator\">></span> react<span class=\"token operator\">-</span>bundle\nx <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>HelloWorld <span class=\"token keyword\">in</span> <span class=\"token operator\">...</span><span class=\"token operator\">/</span>src <span class=\"token operator\">--</span><span class=\"token operator\">></span> <span class=\"token operator\">...</span><span class=\"token operator\">/</span>src<span class=\"token operator\">/</span>HelloWorld<span class=\"token punctuation\">.</span>js\nx <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>BigText <span class=\"token keyword\">in</span> <span class=\"token operator\">...</span><span class=\"token operator\">/</span>src <span class=\"token operator\">--</span><span class=\"token operator\">></span> <span class=\"token operator\">...</span><span class=\"token operator\">/</span>src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js\nx <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>Lazy <span class=\"token keyword\">in</span> <span class=\"token operator\">...</span><span class=\"token operator\">/</span>src <span class=\"token operator\">--</span><span class=\"token operator\">></span> <span class=\"token operator\">...</span><span class=\"token operator\">/</span>src<span class=\"token operator\">/</span>Lazy<span class=\"token punctuation\">.</span>js</code></pre></div>\n<h3 id=\"第二步生成区块图chunk-graph\" style=\"position:relative;\"><a href=\"#%E7%AC%AC%E4%BA%8C%E6%AD%A5%E7%94%9F%E6%88%90%E5%8C%BA%E5%9D%97%E5%9B%BEchunk-graph\" aria-label=\"第二步生成区块图chunk graph permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>第二步：生成区块图（chunk graph）</h3>\n<p>这一步将各个模块分发到chunk中，chunk 有两种形式：</p>\n<ul>\n<li><code class=\"language-text\">initial(初始化)</code> 是入口起点的 main chunk。此 chunk 包含为入口起点指定的所有模块及其依赖项。</li>\n<li><code class=\"language-text\">non-initial</code> 是可以延迟加载的块。可能会出现在使用 <a href=\"https://webpack.docschina.org/guides/code-splitting/#dynamic-imports\">动态导入(dynamic imports)</a> 或者 <a href=\"https://webpack.docschina.org/plugins/split-chunks-plugin/\">SplitChunksPlugin</a> 时。</li>\n</ul>\n<p>分发完毕后 <code class=\"language-text\">chunk graph</code> 如下</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">ChunkGroups<span class=\"token operator\">:</span>\n\n<span class=\"token operator\">*</span> EntryPoint main\n  <span class=\"token operator\">+</span> Chunk main\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>index<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>HelloWorld<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js\n<span class=\"token operator\">*</span> ChunkGroup <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>parent<span class=\"token operator\">:</span> main<span class=\"token punctuation\">)</span>\n  <span class=\"token operator\">+</span> Chunk asnyc\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>Lazy<span class=\"token punctuation\">.</span>js\n\t\t<span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n\t\t<span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js</code></pre></div>\n<h3 id=\"第三步优化可用模块optimize\" style=\"position:relative;\"><a href=\"#%E7%AC%AC%E4%B8%89%E6%AD%A5%E4%BC%98%E5%8C%96%E5%8F%AF%E7%94%A8%E6%A8%A1%E5%9D%97optimize\" aria-label=\"第三步优化可用模块optimize permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>第三步：优化可用模块（optimize）</h3>\n<p>在上一步的基础上，我们继续优化可用模块；在这个Demo中，这一步的作用是剔除 <code class=\"language-text\">async</code> 中已经存在的 <code class=\"language-text\">module</code> 。</p>\n<p><code class=\"language-text\">main chunk</code> 由于是入口，无任何已获取的 <code class=\"language-text\">module</code>，所以为空；但是到 <code class=\"language-text\">async chunk</code>，在加载这个 <code class=\"language-text\">chunk</code> 时我们已经获取了 <code class=\"language-text\">main chunk</code> 中所有的 <code class=\"language-text\">module</code>，我们可以将其中的 <code class=\"language-text\">module</code> 都复制到 <code class=\"language-text\">async</code> 的 <code class=\"language-text\">availableModules</code> 中，同时剔除重复出现的 <code class=\"language-text\">react-bundle.js</code> 和 <code class=\"language-text\">src/BigText.js</code> ，优化完毕后的区块图（<code class=\"language-text\">chunk graph</code>）如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">optimization<span class=\"token punctuation\">.</span>availableModules\n\nChunkGroups<span class=\"token operator\">:</span>\n\n<span class=\"token operator\">*</span> EntryPoint main\n    availableModules<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token operator\">+</span> Chunk main\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>index<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>HelloWorld<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js\n<span class=\"token operator\">*</span> ChunkGroup <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>parent<span class=\"token operator\">:</span> main<span class=\"token punctuation\">)</span>\n  availableModules<span class=\"token operator\">:</span>\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>index<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>HelloWorld<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js\n  <span class=\"token operator\">+</span> Chunk async\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>Lazy<span class=\"token punctuation\">.</span>js</code></pre></div>\n<h3 id=\"第四步串联模块concatenate-modules\" style=\"position:relative;\"><a href=\"#%E7%AC%AC%E5%9B%9B%E6%AD%A5%E4%B8%B2%E8%81%94%E6%A8%A1%E5%9D%97concatenate-modules\" aria-label=\"第四步串联模块concatenate modules permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>第四步：串联模块（concatenate-modules）</h3>\n<p>这一步会按以下规则将模块串联到一起：</p>\n<p>首先确保入口是 <code class=\"language-text\">ESM</code> 的规范，在此基础上检查它的依赖模块是否符合：</p>\n<ol>\n<li>同样也是 <code class=\"language-text\">ESM</code> 规范</li>\n<li>正常的 <code class=\"language-text\">import</code> （不是异步 <code class=\"language-text\">import</code> ）</li>\n<li>处于同一个区块（<code class=\"language-text\">chunk</code>）</li>\n<li>all importer must be included （这条没懂，求读者理解）</li>\n</ol>\n<p>最后一条规则是尝试所有的依赖，经过以上条件筛选后仅有 <code class=\"language-text\">src/HelloWorld.js</code> 与 <code class=\"language-text\">src/index.js</code> 同为 <code class=\"language-text\">ESM</code> 规范；<code class=\"language-text\">src/index.js</code> 正常引用 <code class=\"language-text\">src/HelloWorld.js</code> 且两者处于同一区块（<code class=\"language-text\">chunk</code>），因此我们可以将两者串联</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">Modules<span class=\"token operator\">:</span>\n\n<span class=\"token operator\">*</span> src<span class=\"token operator\">/</span>index<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token constant\">ESM</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>main<span class=\"token punctuation\">}</span>\n    # react\n    # react<span class=\"token operator\">-</span>dom\n    # <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>HelloWorld\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> not <span class=\"token constant\">ESM</span>\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>HelloWorld<span class=\"token punctuation\">.</span>js <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> ok\n        <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> not <span class=\"token constant\">ESM</span>\n        <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> Lazy is not same chunks\n        <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">)</span> src<span class=\"token operator\">/</span>Lazy<span class=\"token punctuation\">.</span>js <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> not normal <span class=\"token keyword\">import</span>\nx react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js <span class=\"token punctuation\">{</span>main<span class=\"token punctuation\">}</span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> not <span class=\"token constant\">ESM</span>\n<span class=\"token operator\">*</span> src<span class=\"token operator\">/</span>HelloWorld<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token constant\">ESM</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>main<span class=\"token punctuation\">}</span>\n    # react\n    # <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>BigText\n    # <span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>Lazy\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> not <span class=\"token constant\">ESM</span>\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> Lazy is not same chunks\n    <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">)</span> src<span class=\"token operator\">/</span>Lazy<span class=\"token punctuation\">.</span>js <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> not normal <span class=\"token keyword\">import</span>\n<span class=\"token operator\">*</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token constant\">ESM</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>main<span class=\"token punctuation\">}</span>\n    # react\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> not <span class=\"token constant\">ESM</span>\n<span class=\"token operator\">*</span> src<span class=\"token operator\">/</span>Lazy<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token constant\">ESM</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>async<span class=\"token punctuation\">}</span>\n    # react\n    # <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>BigText\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> not <span class=\"token constant\">ESM</span>\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js <span class=\"token operator\">&lt;</span><span class=\"token operator\">-</span> not same chunks</code></pre></div>\n<p>串联后模块依赖图（ <code class=\"language-text\">module graph</code> ）变为如下所示：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token operator\">*</span> src<span class=\"token operator\">/</span>index<span class=\"token punctuation\">.</span>js <span class=\"token operator\">+</span> <span class=\"token number\">1</span> module\n    # react\n    # react<span class=\"token operator\">-</span>dom\n    # <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>HelloWorld\n    # <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>BigText\n    # <span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>Lazy\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>HelloWorld<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">)</span> src<span class=\"token operator\">/</span>Lazy<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">+</span> src<span class=\"token operator\">/</span>index<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ESM</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">+</span> src<span class=\"token operator\">/</span>HelloWorld<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ESM</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">*</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n<span class=\"token operator\">*</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ESM</span><span class=\"token punctuation\">)</span>\n    # react\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n<span class=\"token operator\">*</span> src<span class=\"token operator\">/</span>Lazy<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ESM</span><span class=\"token punctuation\">)</span>\n    # react\n    # <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>BigText\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js</code></pre></div>\n<h3 id=\"第五步标号\" style=\"position:relative;\"><a href=\"#%E7%AC%AC%E4%BA%94%E6%AD%A5%E6%A0%87%E5%8F%B7\" aria-label=\"第五步标号 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>第五步：标号</h3>\n<p>这一步将 <code class=\"language-text\">module</code> 和 <code class=\"language-text\">chunk</code> 按序标记，方便后续引用；实际 <code class=\"language-text\">wepback</code> 按照 <code class=\"language-text\">production mode</code> 进行打包的产物，也是以数字标记的。如果按照 <code class=\"language-text\">development mode</code> 打包则是以解析的相对路径命名的。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">Modules<span class=\"token operator\">:</span>\n\n<span class=\"token operator\">*</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> src<span class=\"token operator\">/</span>index<span class=\"token punctuation\">.</span>js <span class=\"token operator\">+</span> <span class=\"token number\">1</span> module\n    # react\n    # react<span class=\"token operator\">-</span>dom\n    # <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>HelloWorld\n    # react\n    # <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>BigText\n    # <span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>Lazy\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>HelloWorld<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">)</span> src<span class=\"token operator\">/</span>Lazy<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">+</span> src<span class=\"token operator\">/</span>index<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ESM</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">+</span> src<span class=\"token operator\">/</span>HelloWorld<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ESM</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">*</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n<span class=\"token operator\">*</span> <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ESM</span><span class=\"token punctuation\">)</span>\n    # react\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n<span class=\"token operator\">*</span> <span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> src<span class=\"token operator\">/</span>Lazy<span class=\"token punctuation\">.</span><span class=\"token function\">js</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ESM</span><span class=\"token punctuation\">)</span>\n    # react\n    # <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>BigText\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js\n\nChunkGroups<span class=\"token operator\">:</span>\n\n<span class=\"token operator\">*</span> EntryPoint main\n  <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> Chunk main\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>index<span class=\"token punctuation\">.</span>js <span class=\"token operator\">+</span> <span class=\"token number\">1</span> modules\n    <span class=\"token operator\">-</span> react<span class=\"token operator\">-</span>bundle<span class=\"token punctuation\">.</span>js\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>BigText<span class=\"token punctuation\">.</span>js\n<span class=\"token operator\">*</span> ChunkGroup <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>parent<span class=\"token operator\">:</span> main<span class=\"token punctuation\">)</span>\n  <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> Chunk async\n    <span class=\"token operator\">-</span> src<span class=\"token operator\">/</span>Lazy<span class=\"token punctuation\">.</span>js</code></pre></div>\n<h3 id=\"第六步模块代码生成-code-generation-modules\" style=\"position:relative;\"><a href=\"#%E7%AC%AC%E5%85%AD%E6%AD%A5%E6%A8%A1%E5%9D%97%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90-code-generation-modules\" aria-label=\"第六步模块代码生成 code generation modules permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>第六步：模块代码生成 （code-generation-modules）</h3>\n<p>这里是<strong>关键</strong>的一步，从此处开始将会将所有的 <code class=\"language-text\">module</code> 包裹一层<strong>蛋清加面包糠</strong>然后炸至金黄（🐶），完成后会将所有模块打包至 <code class=\"language-text\">chunk</code> 中，此处即为 <code class=\"language-text\">demo</code> 里给的 <code class=\"language-text\">runtime.js</code> 和 <code class=\"language-text\">chunk.js</code>。</p>\n<p>这里的<strong>蛋清加面包糠</strong>由于前面预处理 <code class=\"language-text\">react-bundle</code> 时使用的是 <code class=\"language-text\">commonjs2</code> 规范，所以与其相关的 <code class=\"language-text\">runtime.js</code> 也要和 <code class=\"language-text\">exports</code>、 <code class=\"language-text\">module</code> 打交道。</p>\n<p><code class=\"language-text\">runtime.js</code> 在浏览器运行过程中，<code class=\"language-text\">webpack</code> 用来连接模块化应用程序所需的所有代码。它包含：在模块交互时，连接模块所需的加载和解析逻辑。其实无论使用什么模块规范，所有的 <code class=\"language-text\">import</code> 或者 <code class=\"language-text\">require</code> 、<code class=\"language-text\">define</code> 都会转变为 <code class=\"language-text\">__webpack_require__</code> （本文既视频和demo中提到的 <code class=\"language-text\">__magic__</code>），通过 <code class=\"language-text\">__webpack_require__</code> 和对应的模块标识符（这里是第五步标注的数字）来找到对应的模块</p>\n<p>在模块代码生成的过程中参考的都是已经在第五步标号完的 <code class=\"language-text\">Module Graph</code> 和 <code class=\"language-text\">Chunk Graph</code>。</p>\n<p>首先我们复制由第一步 <code class=\"language-text\">babel-loader</code> 转译的文件夹到目录，依次对如下文件做包装处理：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">one<span class=\"token operator\">-</span>day<span class=\"token operator\">-</span>bundler<span class=\"token operator\">/</span><span class=\"token number\">60</span><span class=\"token operator\">-</span>code<span class=\"token operator\">-</span>generation<span class=\"token operator\">-</span>modules<span class=\"token operator\">/</span>modules<span class=\"token operator\">/</span>src\n├── BigText<span class=\"token punctuation\">.</span>js\n├── HelloWorld<span class=\"token punctuation\">.</span>js\n├── Lazy<span class=\"token punctuation\">.</span>js\n└── index<span class=\"token punctuation\">.</span>js</code></pre></div>\n<p><code class=\"language-text\">BigText.js</code> 中引用 <code class=\"language-text\">React</code>，根据 <code class=\"language-text\">Module Graph</code> 得出从 <code class=\"language-text\">module [1]</code> 得到模块的导出内容</p>\n<p>原 <code class=\"language-text\">BigText.js</code> 中的内容：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_ref</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> children <span class=\"token operator\">=</span> _ref<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"h1\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n        children\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>使用一个魔术方法 （视频中作者称之为 <code class=\"language-text\">__magic__</code>) 对其进行改造，将其包装在一个函数中并且传入 <code class=\"language-text\">commonjs</code> 规范导出模块所需的 <code class=\"language-text\">exports</code> 对象；</p>\n<p>替换 <code class=\"language-text\">import React from \"react\";</code> 变为 <code class=\"language-text\">var X = __magic__(1);</code></p>\n<p>这里值得一提的是 <code class=\"language-text\">ESM</code> 的默认导出内容会挂载在 <code class=\"language-text\">X.default</code> 上，因此需要把 <code class=\"language-text\">React</code> 变量都替换为 <code class=\"language-text\">X.default</code></p>\n<p>替换完毕后的内容如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">__magic__<span class=\"token punctuation\">,</span> exports</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> <span class=\"token constant\">X</span> <span class=\"token operator\">=</span> <span class=\"token function\">__magic__</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    exports<span class=\"token punctuation\">.</span>default <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_ref</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> children <span class=\"token operator\">=</span> _ref<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token constant\">X</span><span class=\"token punctuation\">.</span>default<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"h1\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n            children\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>接着处理 <code class=\"language-text\">Lazy.js</code> ，与 <code class=\"language-text\">BigText.js</code> 相似，唯一的不同在于多导入了一个 <code class=\"language-text\">BigText.js</code> ，包装完毕后如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">__magic__<span class=\"token punctuation\">,</span> exports<span class=\"token punctuation\">,</span> module</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> <span class=\"token constant\">X</span> <span class=\"token operator\">=</span> <span class=\"token function\">__magic__</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> <span class=\"token constant\">Y</span> <span class=\"token operator\">=</span> <span class=\"token function\">__magic__</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    exports<span class=\"token punctuation\">.</span>default <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token constant\">X</span><span class=\"token punctuation\">.</span>default<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n            <span class=\"token constant\">Y</span><span class=\"token punctuation\">.</span>default<span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"Lazy Loaded!\"</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>最后需要处理的就是 <code class=\"language-text\">index.js + 1 module</code> 这一部分，在第四步中已经通过串联模块将<code class=\"language-text\">HelloWorld.js</code> 和 <code class=\"language-text\">index.js</code> 合并到一起了，这一部分的代码比较多，但是做的事情与前面两步没有什么不同，依旧是根据 <code class=\"language-text\">import</code> 的来源找到 <code class=\"language-text\">Module Graph</code> 的序号，用 <code class=\"language-text\">__magic__</code> 引用后使用，将文件整合完毕后就可以删除 <code class=\"language-text\">HelloWorld.js</code> 了。</p>\n<p>值得一提的是在 <code class=\"language-text\">31 行</code> 出现的：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span> <span class=\"token comment\">/* webpackChunkName: \"async\" */</span><span class=\"token string\">\"./Lazy\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_ref</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></code></pre></div>\n<p>这里涉及到异步模块的加载，也就是需要第二个 <code class=\"language-text\">chunk</code> 的参与，即可以延迟加载的 <code class=\"language-text\">async chunk</code> ，其背后的核心原理就是 <code class=\"language-text\">jsonp</code>。</p>\n<p>一般我们如何实现一个 <code class=\"language-text\">jsonp</code> ？抛开一堆过期时间、回调名称等等的拓展，核心的内容无非就是如下所示：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">var</span> script <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 创建一个标签</span>\nscript<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> <span class=\"token string\">'urls'</span> <span class=\"token comment\">// 指定资源地址，这即为第二个chunk地址</span>\ndocument<span class=\"token punctuation\">.</span>head<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>script<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 插入文档中触发加载</span></code></pre></div>\n<p>那如何完成 <code class=\"language-text\">31 行</code> 中对 <code class=\"language-text\">import( /* webpackChunkName: \"async\" */\"./Lazy\")</code> 的改造呢？</p>\n<p>我们观察到这句动态导入语句后使用了 <code class=\"language-text\">Promise.then</code> 实例方法，于是这个 <code class=\"language-text\">jsonp</code> 的实现应当用 <code class=\"language-text\">Promise</code> 包装一下，将 <code class=\"language-text\">resolve</code> 的控制权交出；同时在 <code class=\"language-text\">async chunk</code> 中调用 <code class=\"language-text\">resolve</code> 并将 <code class=\"language-text\">async chunk</code> 中的模块都加入到 <code class=\"language-text\">module</code>s 中。</p>\n<p>这些工具函数都放置在 <code class=\"language-text\">runtime.js</code> 文件中，核心实现如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">__magic__<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">loadChunk</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">chunkId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        chunkResolves<span class=\"token punctuation\">[</span>chunkId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> resolve <span class=\"token comment\">// 移交控制权</span>\n        <span class=\"token keyword\">var</span> script <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script'</span><span class=\"token punctuation\">)</span>\n        script<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> <span class=\"token string\">\"one-day-bundler/70-assets\"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">{</span><span class=\"token number\">0</span><span class=\"token operator\">:</span> <span class=\"token string\">\"async\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">[</span>chunkId<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">\".js\"</span><span class=\"token punctuation\">;</span>\n        document<span class=\"token punctuation\">.</span>head<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>script<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\nwindow<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">magicJsonp</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">chunkId<span class=\"token punctuation\">,</span> newModules</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> id <span class=\"token keyword\">in</span> newModules<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        modules<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newModules<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token comment\">// 将这个async chunk的所有模块加入到 modules</span>\n    <span class=\"token punctuation\">}</span>\n    chunkResolves<span class=\"token punctuation\">[</span>chunkId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// resolve 这次 loadChunk，完成动态导入</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>经过改造后 <code class=\"language-text\">31 行</code> 的代码就变为如下</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">__magic__<span class=\"token punctuation\">.</span><span class=\"token function\">loadChunk</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token function\">__magic__</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_ref</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></code></pre></div>\n<h3 id=\"第七步资源整合asstes\" style=\"position:relative;\"><a href=\"#%E7%AC%AC%E4%B8%83%E6%AD%A5%E8%B5%84%E6%BA%90%E6%95%B4%E5%90%88asstes\" aria-label=\"第七步资源整合asstes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>第七步：资源整合（asstes）</h3>\n<p>这一步的主要工作就是缝合怪，把第六步打包出来的 <code class=\"language-text\">Modules</code> 文件下的内容填充到 <code class=\"language-text\">runtime</code> 和 <code class=\"language-text\">chunk</code> 中。</p>\n<p><code class=\"language-text\">runtime</code> 文件：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modules</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> cache <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token comment\">// 缓存</span>\n    <span class=\"token keyword\">var</span> chunkResolves <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    window<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">magicJsonp</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">chunkId<span class=\"token punctuation\">,</span> newModules</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> id <span class=\"token keyword\">in</span> newModules<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            modules<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newModules<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n        chunkResolves<span class=\"token punctuation\">[</span>chunkId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">__magic__</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">id</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> cache<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            exports<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        modules<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>__magic__<span class=\"token punctuation\">,</span> exports<span class=\"token punctuation\">,</span> module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        cache<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> module<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    __magic__<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">loadChunk</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">chunkId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            chunkResolves<span class=\"token punctuation\">[</span>chunkId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> resolve\n            <span class=\"token keyword\">var</span> script <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script'</span><span class=\"token punctuation\">)</span>\n            script<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> <span class=\"token string\">\"one-day-bundler/70-assets\"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">{</span><span class=\"token number\">0</span><span class=\"token operator\">:</span> <span class=\"token string\">\"async\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">[</span>chunkId<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">\".js\"</span><span class=\"token punctuation\">;</span>\n            document<span class=\"token punctuation\">.</span>head<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>script<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">__magic__</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 根入口，module 0 即 index.src + 1 module (HelloWorld)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n\t\t<span class=\"token comment\">// 即将填充的内容 modules</span>\n\t<span class=\"token number\">0</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// modules/src/index.js 内容</span>\n\t<span class=\"token number\">1</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// modules/src/react-bundle.js 内容</span>\n\t<span class=\"token number\">2</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// modules/src/BigText.js 内容</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">chunk</code> 文件：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">window<span class=\"token punctuation\">.</span><span class=\"token function\">magicJsonp</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token number\">3</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// modules/src/Lazy.js 内容</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>这里还有一个知识点，在 <code class=\"language-text\">index.js</code> 的 <code class=\"language-text\">31行</code> 有个这样的注释</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">/* webpackChunkName: \"async\" */</span></code></pre></div>\n<p>所以需要将 <code class=\"language-text\">chunk</code> 命名为 <code class=\"language-text\">async</code>；同时根目录的入口文件 <code class=\"language-text\">index.html</code> 中引用的是 <code class=\"language-text\">main.js</code> ，所以 <code class=\"language-text\">runtime.js</code> 也需要更名。</p>\n<p>修改完毕后，在浏览器打开 <code class=\"language-text\">index.html</code> 我们就能看到以下内容：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 620px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4096d881472568b04198865459bb0bbd/2a195/2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.632911392405056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABLUlEQVQoz52Sy8uCQBTF/bdt16JN0dalIUqhK0NapAtx0UqkdkKrCHuhPUQF8XU+5kItKgO/C4eZOzMc7v3N5R6PB/I8R1EUqOsaZVmhqiras5WpLEtUVf06/yUuTRN0iaZpft5zq9UKkiRhOp2SdF1HEARQVRXj8RimacK2bSiKAk3TqMqn8TdxnufRw9FohPl8DlEUsd1u4TgOZFkm48ViAcMwKH83+6gwy7JOLTNOT6OvhkmS0Id0jTaWHGvver3icDhgt9shDENSFEW0Mp77/R6u6+J4PGK9XmOz2byq/TC0LIsYDgYD4jiZTOD7PmazGfHr9XoYDofo9/vgeR6CIGC5XLYbXi4XquB2u+F8PpPY3J1OJ7AZvd/vpDiOKX/ObSvDNE3xn2hj+Aflme02SJz7qAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0bf1081c-17be-4404-8f88-a3a198e80896/Untitled.png\"\n        title=\"https://s3-us-west-2.amazonaws.com/secure.notion-static.com/0bf1081c-17be-4404-8f88-a3a198e80896/Untitled.png\"\n        src=\"/static/4096d881472568b04198865459bb0bbd/2a195/2.png\"\n        srcset=\"/static/4096d881472568b04198865459bb0bbd/c26ae/2.png 158w,\n/static/4096d881472568b04198865459bb0bbd/6bdcf/2.png 315w,\n/static/4096d881472568b04198865459bb0bbd/2a195/2.png 620w\"\n        sizes=\"(max-width: 620px) 100vw, 620px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"demo地址\" style=\"position:relative;\"><a href=\"#demo%E5%9C%B0%E5%9D%80\" aria-label=\"demo地址 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Demo地址</h2>\n<p>原作者 demo 地址：<a href=\"https://github.com/sokra/webpack-meetup-2018-05\">https://github.com/sokra/webpack-meetup-2018-05</a></p>\n<p>本文 Fork 整理后： <a href=\"https://github.com/hemisu/webpack-meetup-2018-05\">https://github.com/hemisu/webpack-meetup-2018-05</a></p>\n<h2 id=\"参考链接\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5\" aria-label=\"参考链接 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考链接</h2>\n<p>[1]: Webpack founder Tobias Koppers demos bundling live by hand, <a href=\"https://www.youtube.com/watch?v=UNMkLHzofQI\">https://www.youtube.com/watch?v=UNMkLHzofQI</a></p>\n<p>[2]: webpack docs, <a href=\"https://webpack.docschina.org/\">https://webpack.docschina.org/</a></p>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#demo%E4%BB%8B%E7%BB%8D\">Demo介绍</a></p>\n</li>\n<li>\n<p><a href=\"#%E6%89%8B%E5%8A%A8%E6%A8%A1%E6%8B%9F%E6%89%93%E5%8C%85%E6%B5%81%E7%A8%8B\">手动模拟打包流程</a></p>\n<ul>\n<li><a href=\"#%E7%AC%AC%E4%B8%80%E6%AD%A5%E7%94%9F%E6%88%90%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96%E5%9B%BE-module-graph\">第一步：生成模块依赖图 （module-graph）</a></li>\n<li><a href=\"#%E7%AC%AC%E4%BA%8C%E6%AD%A5%E7%94%9F%E6%88%90%E5%8C%BA%E5%9D%97%E5%9B%BEchunk-graph\">第二步：生成区块图（chunk graph）</a></li>\n<li><a href=\"#%E7%AC%AC%E4%B8%89%E6%AD%A5%E4%BC%98%E5%8C%96%E5%8F%AF%E7%94%A8%E6%A8%A1%E5%9D%97optimize\">第三步：优化可用模块（optimize）</a></li>\n<li><a href=\"#%E7%AC%AC%E5%9B%9B%E6%AD%A5%E4%B8%B2%E8%81%94%E6%A8%A1%E5%9D%97concatenate-modules\">第四步：串联模块（concatenate-modules）</a></li>\n<li><a href=\"#%E7%AC%AC%E4%BA%94%E6%AD%A5%E6%A0%87%E5%8F%B7\">第五步：标号</a></li>\n<li><a href=\"#%E7%AC%AC%E5%85%AD%E6%AD%A5%E6%A8%A1%E5%9D%97%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90-code-generation-modules\">第六步：模块代码生成 （code-generation-modules）</a></li>\n<li><a href=\"#%E7%AC%AC%E4%B8%83%E6%AD%A5%E8%B5%84%E6%BA%90%E6%95%B4%E5%90%88asstes\">第七步：资源整合（asstes）</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#demo%E5%9C%B0%E5%9D%80\">Demo地址</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5\">参考链接</a></p>\n</li>\n</ul>","frontmatter":{"title":"webpack原理 - 作者教你手把手打包","date":"September 27, 2020","description":null}},"previous":{"fields":{"slug":"/old-posts/promise-pool/"},"frontmatter":{"title":"js异步初探 - 图解并发控制"}},"next":{"fields":{"slug":"/old-posts/learn-koa/"},"frontmatter":{"title":"阅读三大框架-koa"}}},"pageContext":{"id":"dabf4f24-d8be-5126-aa76-47fdc9ef0861","previousPostId":"7e002c77-fc4e-5f11-95b7-b6279b770e6c","nextPostId":"9065aae9-f1d2-500d-860c-c73fd56c34ff"}},
    "staticQueryHashes": ["2841359383","3257411868"]}